<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旅遊計劃規劃應用程式</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --accent-color: #ff7e5f;
            --background-color: #f8f9fa;
            --card-color: #ffffff;
            --text-color: #333333;
            --light-text: #666666;
            --border-color: #e0e0e0;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
        }

        /* 配色方案 */
        .theme-blue {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --accent-color: #ff7e5f;
        }

        .theme-green {
            --primary-color: #4a9c7d;
            --secondary-color: #6bb89c;
            --accent-color: #ff9a5f;
        }

        .theme-purple {
            --primary-color: #7a4a9c;
            --secondary-color: #9c6bbc;
            --accent-color: #5fd4ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            overflow-x: hidden;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
            width: 100%;
            max-width: 100%;
        }

        .header-left {
            flex: 1;
            min-width: 200px;
        }

        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        .header-top-row {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            flex-wrap: wrap;
            gap: 10px;
            width: 100%;
        }

        .header-bottom-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        h1 {
            color: var(--primary-color);
            font-size: clamp(1.5rem, 4vw, 2.2rem);
            margin-bottom: 5px;
            word-break: break-word;
        }

        .tagline {
            color: var(--light-text);
            font-size: clamp(0.9rem, 2vw, 1rem);
        }

        h2 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: clamp(1.3rem, 3vw, 1.8rem);
            word-break: break-word;
        }

        h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: clamp(1.1rem, 2.5vw, 1.4rem);
            word-break: break-word;
        }

        .theme-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .theme-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .theme-btn:hover {
            transform: scale(1.1);
        }

        .theme-btn.active {
            border-color: var(--text-color);
        }

        .theme-btn.blue {
            background: linear-gradient(135deg, #4a6fa5 50%, #ff7e5f 50%);
        }

        .theme-btn.green {
            background: linear-gradient(135deg, #4a9c7d 50%, #ff9a5f 50%);
        }

        .theme-btn.purple {
            background: linear-gradient(135deg, #7a4a9c 50%, #5fd4ff 50%);
        }

        /* 雲端狀態顯示 */
        .cloud-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .cloud-status.connected {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .cloud-status.disconnected {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .cloud-status i {
            font-size: 0.9rem;
        }

        /* 雲端按鈕 */
        .cloud-btn {
            padding: 6px 12px;
            border-radius: var(--border-radius);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid var(--border-color);
            background-color: #f8f9fa;
            color: var(--text-color);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .cloud-btn:hover:not(:disabled) {
            background-color: #e9ecef;
        }

        .cloud-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .cloud-btn.cloud-settings {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .cloud-btn.cloud-settings:hover:not(:disabled) {
            background-color: var(--secondary-color);
        }

        .cloud-btn.cloud-backup {
            background-color: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .cloud-btn.cloud-backup:hover:not(:disabled) {
            background-color: #45a049;
        }

        .cloud-btn.cloud-restore {
            background-color: var(--warning-color);
            color: white;
            border-color: var(--warning-color);
        }

        .cloud-btn.cloud-restore:hover:not(:disabled) {
            background-color: #e68900;
        }

        .cloud-btn.cloud-delete {
            background-color: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }

        .cloud-btn.cloud-delete:hover:not(:disabled) {
            background-color: #d32f2f;
        }

        /* 分享代碼按鈕 */
        .cloud-btn.cloud-share {
            background-color: #6c63ff;
            color: white;
            border-color: #6c63ff;
        }

        .cloud-btn.cloud-share:hover:not(:disabled) {
            background-color: #5752d4;
        }

        .app-container {
            display: grid;
            grid-template-columns: minmax(300px, 350px) 1fr;
            gap: 30px;
            width: 100%;
            max-width: 100%;
        }

        /* 旅遊計劃面板 */
        .plans-panel {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            height: fit-content;
            width: 100%;
            max-width: 100%;
            overflow: hidden;
        }

        .plans-list {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            width: 100%;
        }

        .plan-item {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            box-sizing: border-box;
        }

        .plan-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .plan-item.active {
            border-color: var(--accent-color);
            background-color: rgba(255, 126, 95, 0.05);
        }

        .plan-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            width: 100%;
        }

        .plan-item-name {
            font-weight: bold;
            color: var(--primary-color);
            font-size: clamp(0.9rem, 2vw, 1rem);
            word-break: break-word;
            max-width: 80%;
        }

        .plan-item-dates {
            font-size: 0.85rem;
            color: var(--light-text);
            margin-bottom: 5px;
            word-break: break-word;
        }

        .plan-item-days {
            font-size: 0.85rem;
            color: var(--light-text);
        }

        .plan-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            width: 100%;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: clamp(0.8rem, 1.5vw, 0.9rem);
            white-space: nowrap;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-secondary {
            background-color: #f0f0f0;
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: #e0e0e0;
        }

        .btn-accent {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-accent:hover {
            background-color: #ff6b4a;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        .btn-info {
            background-color: #6c63ff;
            color: white;
        }

        .btn-info:hover {
            background-color: #5752d4;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        /* 行程面板 */
        .itinerary-panel {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            min-height: 800px;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        .no-plan-selected {
            text-align: center;
            padding: 60px 20px;
            color: var(--light-text);
            width: 100%;
        }

        .no-plan-selected i {
            font-size: clamp(3rem, 10vw, 4rem);
            color: #e0e0e0;
            margin-bottom: 20px;
        }

        .plan-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 15px;
            width: 100%;
            max-width: 100%;
        }

        .plan-header-left {
            flex: 1;
            min-width: 200px;
            max-width: 100%;
        }

        .plan-header-right {
            flex-shrink: 0;
        }

        .days-tabs-container {
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
            margin-bottom: 30px;
            padding-bottom: 5px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }

        .days-tabs {
            display: flex;
            min-width: min-content;
            width: max-content;
        }

        .days-tabs-container::-webkit-scrollbar {
            height: 6px;
        }

        .days-tabs-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .days-tabs-container::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }

        .day-tab {
            padding: 12px 20px;
            border: 1px solid var(--border-color);
            background-color: #f9f9f9;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            margin-right: 5px;
            font-size: clamp(0.8rem, 1.5vw, 0.9rem);
            min-width: 80px;
            text-align: center;
        }

        .day-tab:hover {
            background-color: #f0f0f0;
        }

        .day-tab.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .cost-tab {
            background-color: #f0f0f0;
            color: var(--text-color);
        }

        .cost-tab.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .day-content {
            display: none;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }

        .day-content.active {
            display: block;
        }

        .cost-content {
            display: none;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }

        .cost-content.active {
            display: block;
        }

        .day-title-input {
            width: 100%;
            max-width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: clamp(1rem, 2vw, 1.1rem);
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        .activities-container {
            min-height: 500px;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }

        .activity-item {
            background-color: #f9f9f9;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            cursor: move;
            transition: all 0.3s;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .activity-item:hover {
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
            width: 100%;
        }

        .activity-name {
            font-weight: bold;
            font-size: clamp(1rem, 2vw, 1.2rem);
            color: var(--primary-color);
            word-break: break-word;
            max-width: 100%;
        }

        .activity-category {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 10px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .activity-category.attraction {
            background-color: #e3f2fd;
            color: #1565c0;
        }

        .activity-category.transport {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }

        .activity-category.activity {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .activity-category.accommodation {
            background-color: #fff3e0;
            color: #ef6c00;
        }

        .activity-category.shopping {
            background-color: #fff0f5;
            color: #c2185b;
        }

        .activity-category.other {
            background-color: #f5f5f5;
            color: #616161;
        }

        .activity-time {
            color: var(--light-text);
            font-size: 0.85rem;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .activity-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
            width: 100%;
            max-width: 100%;
        }

        .activity-address, .activity-cost, .activity-links, .activity-notes {
            font-size: 0.9rem;
            word-break: break-word;
            max-width: 100%;
            overflow-wrap: break-word;
        }

        .activity-links a {
            color: var(--primary-color);
            text-decoration: none;
            margin-right: 10px;
            word-break: break-all;
            display: inline-block;
            max-width: 100%;
        }

        .activity-links a:hover {
            text-decoration: underline;
        }

        .transport-item {
            background-color: #f0f7ff;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            margin-left: clamp(20px, 5vw, 30px);
            position: relative;
            width: calc(100% - clamp(20px, 5vw, 30px));
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .transport-item::before {
            content: "";
            position: absolute;
            left: -20px;
            top: 50%;
            width: 20px;
            height: 1px;
            background-color: var(--border-color);
        }

        .transport-item::after {
            content: "→";
            position: absolute;
            left: -25px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--light-text);
            font-size: 0.9rem;
        }

        .transport-type {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            background-color: #e3f2fd;
            color: #1565c0;
            margin-bottom: 10px;
            white-space: nowrap;
        }

        .transport-main {
            border-left: 4px solid #4caf50;
        }

        .transport-alternate {
            border-left: 4px solid #ff9800;
        }

        /* 浮動按鈕 */
        .floating-buttons {
            position: fixed;
            right: clamp(15px, 3vw, 30px);
            bottom: clamp(15px, 3vw, 30px);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 100;
        }

        .floating-btn {
            width: clamp(50px, 10vw, 60px);
            height: clamp(50px, 10vw, 60px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(1.2rem, 3vw, 1.5rem);
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
            position: relative;
        }

        .floating-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
        }

        .floating-btn.add-activity {
            background-color: var(--primary-color);
        }

        .floating-btn.add-transport {
            background-color: var(--accent-color);
        }

        .floating-btn.add-cost {
            background-color: var(--success-color);
        }

        .floating-btn-text {
            display: none;
            position: absolute;
            right: calc(100% + 10px);
            background-color: var(--primary-color);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .floating-btn:hover .floating-btn-text {
            display: block;
        }

        /* 模態框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .modal-body {
            padding: 25px;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }

        .form-group {
            margin-bottom: 20px;
            width: 100%;
            max-width: 100%;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            width: 100%;
            max-width: 100%;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
            font-size: clamp(0.9rem, 1.5vw, 1rem);
            word-break: break-word;
        }

        input, select, textarea {
            width: 100%;
            max-width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: clamp(0.9rem, 1.5vw, 1rem);
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
            width: 100%;
        }

        /* 費用統計面板 */
        .cost-summary {
            margin-top: 40px;
            background-color: #f9f9f9;
            border-radius: var(--border-radius);
            padding: 20px;
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
        }

        .cost-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: clamp(0.8rem, 1.5vw, 0.9rem);
            min-width: 600px; /* 增加最小寬度 */
        }

        .cost-table th, .cost-table td {
            padding: 10px 12px; /* 增加內邊距 */
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            word-break: break-word;
            white-space: nowrap;
            max-width: none; /* 移除最大寬度限制 */
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 增加特定欄位的寬度 */
        .cost-table th:nth-child(1), 
        .cost-table td:nth-child(1) {
            width: 80px; /* 日期欄位寬度 */
        }
        
        .cost-table th:nth-child(2), 
        .cost-table td:nth-child(2) {
            width: 80px; /* 類別欄位寬度 */
        }
        
        .cost-table th:nth-child(3), 
        .cost-table td:nth-child(3) {
            width: 120px; /* 說明欄位寬度 */
        }
        
        .cost-table th:nth-child(4), 
        .cost-table td:nth-child(4) {
            width: 80px; /* 幣別欄位寬度 */
        }
        
        .cost-table th:nth-child(5), 
        .cost-table td:nth-child(5) {
            width: 100px; /* 原幣費用欄位寬度 */
            text-align: right;
        }
        
        .cost-table th:nth-child(6), 
        .cost-table td:nth-child(6) {
            width: 100px; /* 換算台幣欄位寬度 */
            text-align: right;
        }
        
        .cost-table th:nth-child(7), 
        .cost-table td:nth-child(7) {
            width: 80px; /* 分攤人數欄位寬度 */
            text-align: center;
        }
        
        .cost-table th:nth-child(8), 
        .cost-table td:nth-child(8) {
            width: 100px; /* 每人費用欄位寬度 */
            text-align: right;
        }

        .cost-table th {
            background-color: #f0f0f0;
            color: var(--text-color);
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .cost-table tr:last-child td {
            border-bottom: none;
        }

        .total-cost {
            font-weight: bold;
            color: var(--accent-color);
        }

        .cost-category {
            font-weight: 600;
            color: var(--primary-color);
            background-color: rgba(74, 111, 165, 0.1);
        }

        .cost-subcategory {
            padding-left: 20px !important;
            font-weight: 500;
        }

        .cost-total-row {
            font-weight: bold;
            background-color: rgba(255, 126, 95, 0.1);
        }

        .currency-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .currency-input-group input {
            flex: 1;
        }

        .currency-input-group select {
            width: 120px;
        }

        /* 手機選單按鈕 */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* 滾動到頂部/底部按鈕 */
        .scroll-buttons {
            position: fixed;
            right: clamp(15px, 3vw, 30px);
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 99;
        }

        .scroll-btn {
            width: clamp(40px, 8vw, 50px);
            height: clamp(40px, 8vw, 50px);
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            transition: all 0.3s;
            border: none;
            font-size: 1.2rem;
        }

        .scroll-btn:hover {
            background-color: var(--secondary-color);
            transform: scale(1.1);
        }

        /* 多連結區域 */
        .links-container {
            margin-top: 10px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px dashed var(--border-color);
        }

        .link-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .link-item:last-child {
            margin-bottom: 0;
        }

        .link-item input {
            flex: 1;
        }

        .link-item .link-name {
            min-width: 120px;
        }

        .link-item .link-url {
            flex: 2;
        }

        .add-link-btn, .remove-link-btn {
            padding: 5px 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            border: none;
            background-color: var(--light-text);
            color: white;
            font-size: 0.8rem;
            min-width: 30px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-link-btn {
            background-color: var(--success-color);
        }

        .add-link-btn:hover {
            background-color: #45a049;
        }

        .remove-link-btn {
            background-color: var(--danger-color);
        }

        .remove-link-btn:hover {
            background-color: #d32f2f;
        }

        .links-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        /* 交通方式區域 */
        .transport-options-container {
            margin-top: 10px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px dashed var(--border-color);
        }

        .transport-option {
            background-color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }

        .transport-option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .transport-option-type {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .transport-option-title {
            font-weight: bold;
            color: var(--primary-color);
        }

        .transport-option-actions {
            display: flex;
            gap: 5px;
        }

        .add-transport-option-btn {
            width: 100%;
            padding: 10px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }

        .add-transport-option-btn:hover {
            background-color: var(--primary-color);
        }

        /* 前一晚住宿選擇 */
        .previous-accommodation {
            background-color: #fff3e0;
            border-left: 4px solid #ef6c00;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .previous-accommodation select {
            margin-top: 5px;
        }

        /* 檢視模式樣式 */
        /* 檢視模式下隱藏編輯控制項，但不可隱藏 activity-item 本身 */
        body.view-mode .edit-controls,
        body.view-mode .floating-buttons,
        body.view-mode .btn-danger,
        body.view-mode .btn-accent {
            display: none !important;
        }
        body.view-mode .btn-secondary.edit-plan,
        body.view-mode .btn-secondary.edit-activity,
        body.view-mode .btn-secondary.edit-transport,
        body.view-mode .delete-activity,
        body.view-mode .delete-transport,
        body.view-mode .day-title-input,
        body.view-mode .activity-item {
            display: none !important;
        }

        /* 確保行程項目在檢視模式依然有背景色與外框 */
        body.view-mode .activity-item {
            cursor: default !important;
            background-color: #f9f9f9;
            border: 1px solid var(--border-color);
            display: block !important; /* 強制顯示 */
        }

        body.view-mode .plan-item {
            cursor: default !important;
        }

        body.view-mode .day-tab {
            cursor: default !important;
        }

        body.view-mode .view-mode-controls {
            display: flex !important;
        }

        /* 分享模式樣式 */
        body.shared-mode .edit-controls,
        body.shared-mode .floating-buttons,
        body.shared-mode .btn-danger,
        body.shared-mode .btn-accent,
        body.shared-mode .btn-secondary.edit-plan,
        body.shared-mode .btn-secondary.edit-activity,
        body.shared-mode .btn-secondary.edit-transport,
        body.shared-mode .delete-activity,
        body.shared-mode .delete-transport,
        body.shared-mode .day-title-input,
        body.shared-mode .cloud-btn,
        body.shared-mode .btn-view-mode,
        body.shared-mode #addPlanBtn,
        body.shared-mode #backupBtn,
        body.shared-mode #restoreBtn,
        body.shared-mode #exchangeRateBtn,
        body.shared-mode #viewModeBtn,
        body.shared-mode .theme-selector,
        body.shared-mode .exit-share-mode-btn {
            display: none !important;
        }

        /* 確保行程項目在分享模式下是顯示的，並取消滑鼠點擊手勢 */
        body.shared-mode .activity-item {
            cursor: default !important;
            display: block !important;
            background-color: #f9f9f9;
            border: 1px solid var(--border-color);
        }

        body.shared-mode .plan-item {
            cursor: default !important;
        }

        body.shared-mode .view-mode-controls {
            display: flex !important;
        }

        body.shared-mode .shared-mode-indicator {
            display: flex !important;
        }

        /* 檢視模式控制按鈕 */
        .view-mode-controls {
            display: none;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn-view-mode {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-view-mode:hover {
            background-color: #e68900;
        }

        /* 分享模式指示器 */
        .shared-mode-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
            background-color: rgba(108, 99, 255, 0.1);
            color: #6c63ff;
            border: 1px solid rgba(108, 99, 255, 0.3);
            margin-right: 10px;
        }

        /* 退出分享模式按鈕 */
        .exit-share-mode-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            background-color: #6c63ff;
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.85rem;
            transition: background-color 0.3s;
        }

        .exit-share-mode-btn:hover {
            background-color: #5752d4;
        }

        /* 雲端備份/還原模態框專用樣式 */
        .cloud-backup-list,
        .cloud-restore-list,
        .cloud-delete-list,
        .cloud-share-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 10px;
        }

        .cloud-backup-item,
        .cloud-restore-item,
        .cloud-delete-item,
        .cloud-share-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .cloud-backup-item:last-child,
        .cloud-restore-item:last-child,
        .cloud-delete-item:last-child,
        .cloud-share-item:last-child {
            border-bottom: none;
        }

        .cloud-backup-item:hover,
        .cloud-restore-item:hover,
        .cloud-delete-item:hover,
        .cloud-share-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .cloud-backup-item.selected,
        .cloud-restore-item.selected,
        .cloud-delete-item.selected,
        .cloud-share-item.selected {
            background-color: rgba(74, 111, 165, 0.1);
            border-left: 3px solid var(--primary-color);
        }

        .cloud-backup-checkbox,
        .cloud-restore-checkbox,
        .cloud-delete-checkbox,
        .cloud-share-checkbox {
            margin-right: 10px;
            width: 20px;
            height: 20px;
        }

        .cloud-backup-info,
        .cloud-restore-info,
        .cloud-delete-info,
        .cloud-share-info {
            flex: 1;
        }

        .cloud-backup-name,
        .cloud-restore-name,
        .cloud-delete-name,
        .cloud-share-name {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
            word-break: break-word;
        }

        .cloud-backup-details,
        .cloud-restore-details,
        .cloud-delete-details,
        .cloud-share-details {
            font-size: 0.8rem;
            color: var(--light-text);
            word-break: break-word;
        }

        .cloud-backup-actions,
        .cloud-restore-actions,
        .cloud-delete-actions,
        .cloud-share-actions {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cloud-backup-selected-count,
        .cloud-restore-selected-count,
        .cloud-delete-selected-count,
        .cloud-share-selected-count {
            font-size: 0.9rem;
            color: var(--primary-color);
            font-weight: 600;
        }

        .cloud-backup-empty,
        .cloud-restore-empty,
        .cloud-delete-empty,
        .cloud-share-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--light-text);
        }

        .cloud-backup-empty i,
        .cloud-restore-empty i,
        .cloud-delete-empty i,
        .cloud-share-empty i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #e0e0e0;
        }

        .cloud-backup-datetime {
            font-size: 0.75rem;
            color: var(--light-text);
            margin-top: 3px;
        }

        /* 費用管理區域 */
        .cost-management {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .cost-categories {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .cost-category-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            background-color: #f0f0f0;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .cost-category-badge i {
            font-size: 0.9rem;
        }

        .cost-list-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* 已過期計劃區域 */
        .expired-plans-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            cursor: pointer;
        }

        .expired-plans-title {
            color: var(--light-text);
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .expired-plans-count {
            background-color: var(--light-text);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .expired-plans-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .expired-plans-content.expanded {
            max-height: 1000px;
        }

        .expired-plan-item {
            opacity: 0.7;
            background-color: #f9f9f9;
        }

        .expired-plan-item:hover {
            opacity: 0.9;
        }

        /* 分享代碼顯示區域 */
        .share-code-container {
            background-color: #f8f9fa;
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 20px;
            position: relative;
        }

        .share-code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .share-code-content {
            margin-bottom: 20px;
        }

        .share-code-url {
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            font-family: monospace;
            font-size: 0.9rem;
            word-break: break-all;
            overflow-x: auto;
            white-space: nowrap;
            margin-bottom: 15px;
        }

        .share-code-qr {
            text-align: center;
            margin: 20px 0;
        }

        .share-code-qr canvas {
            max-width: 200px;
            max-height: 200px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 10px;
            background-color: white;
        }

        .share-code-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .copy-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }

        .copy-btn:hover {
            background-color: var(--secondary-color);
        }

        .copy-btn.copied {
            background-color: var(--success-color);
        }

        .test-share-btn {
            background-color: #6c63ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }

        .test-share-btn:hover {
            background-color: #5752d4;
        }

        .share-info {
            background-color: rgba(108, 99, 255, 0.1);
            border-left: 4px solid #6c63ff;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .share-info h4 {
            color: #6c63ff;
            margin-bottom: 10px;
        }

        .share-info ul {
            padding-left: 20px;
            margin-bottom: 10px;
        }

        .share-info li {
            margin-bottom: 5px;
        }

        /* 響應式設計 */
        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .plans-panel {
                max-height: 500px;
                overflow-y: auto;
                max-width: 100%;
            }
            
            .floating-buttons {
                right: 20px;
                bottom: 20px;
            }
            
            .scroll-buttons {
                display: none; /* 在小螢幕隱藏滾動按鈕 */
            }
            
            .mobile-menu-btn {
                display: flex;
            }
            
            .plans-panel {
                position: fixed;
                top: 0;
                left: -100%;
                width: 100%;
                max-width: 350px;
                height: 100vh;
                z-index: 1000;
                transition: left 0.3s ease;
                overflow-y: auto;
                box-shadow: 5px 0 15px rgba(0,0,0,0.1);
            }
            
            .plans-panel.active {
                left: 0;
            }
            
            .plan-header {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .days-tabs {
                width: max-content;
            }
            
            .cost-table {
                min-width: 800px;
            }
            
            .cost-table th, .cost-table td {
                padding: 8px 10px;
                font-size: 0.75rem;
            }
            
            .header-right {
                align-items: flex-start;
            }
            
            .header-top-row {
                justify-content: flex-start;
            }
            
            .header-bottom-row {
                justify-content: flex-start;
            }
            
            .link-item {
                flex-direction: column;
            }
            
            .link-item input {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .header-right {
                width: 100%;
                align-items: flex-start;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .activity-details {
                grid-template-columns: 1fr;
            }
            
            .activity-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .activity-category {
                margin-left: 0;
                margin-top: 5px;
            }
            
            .floating-buttons {
                right: 15px;
                bottom: 15px;
                gap: 10px;
            }
            
            .floating-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .floating-btn-text {
                display: none !important;
            }
            
            .plan-actions {
                justify-content: center;
            }
            
            .btn {
                flex: 1;
                min-width: 120px;
                justify-content: center;
            }
            
            .modal-content {
                max-height: 85vh;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .day-tab {
                min-width: 70px;
                padding: 10px 15px;
            }
            
            .cost-table {
                min-width: 700px;
                font-size: 0.7rem;
            }
            
            .cost-table th, .cost-table td {
                padding: 6px 8px;
            }
            
            .cloud-status {
                font-size: 0.8rem;
            }
            
            .cloud-btn {
                padding: 5px 10px;
                font-size: 0.8rem;
            }
            
            .share-code-actions {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            h2 {
                font-size: 1.3rem;
            }
            
            h3 {
                font-size: 1.1rem;
            }
            
            .btn {
                padding: 8px 15px;
                font-size: 0.8rem;
            }
            
            .day-tab {
                padding: 8px 12px;
                min-width: 60px;
                font-size: 0.8rem;
            }
            
            .activity-item {
                padding: 15px;
            }
            
            .transport-item {
                padding: 12px;
                margin-left: 20px;
                width: calc(100% - 20px);
            }
            
            .mobile-menu-btn {
                top: 15px;
                left: 15px;
                width: 45px;
                height: 45px;
                font-size: 1.3rem;
            }
            
            .cost-table {
                min-width: 600px;
                font-size: 0.65rem;
            }
            
            .cost-table th, .cost-table td {
                padding: 5px 6px;
            }
            
            .cloud-status {
                font-size: 0.75rem;
                padding: 5px 10px;
            }
            
            .cloud-btn {
                padding: 4px 8px;
                font-size: 0.75rem;
            }
        }

        /* 遮罩層 */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        .overlay.active {
            display: block;
        }
        
        /* 防止內容超出 */
        .scroll-prevention {
            max-width: 100%;
            overflow-x: hidden;
        }
        
        /* 匯率設置按鈕 */
        .exchange-rate-btn {
            margin-top: 10px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .exchange-rate-btn:hover {
            background-color: var(--primary-color);
        }
        
        /* 匯率設置模態框 */
        #exchangeRateModal .modal-content {
            max-width: 500px;
        }
        
        .exchange-rate-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .exchange-rate-item label {
            min-width: 80px;
            margin-bottom: 0;
        }
        
        .exchange-rate-item input {
            flex: 1;
        }
        
        /* GitHub雲端設定模態框 */
        #githubCloudModal .modal-content {
            max-width: 500px;
        }
        
        .github-info {
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .github-info h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .github-info ol {
            padding-left: 20px;
            margin-bottom: 10px;
        }
        
        .github-info li {
            margin-bottom: 5px;
        }
        
        .github-info a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .github-info a:hover {
            text-decoration: underline;
        }
        
        .token-input {
            font-family: monospace;
        }

        /* 分享代碼模態框 */
        #cloudShareModal .modal-content {
            max-width: 600px;
        }
		
		/* 新增：費用分組標題樣式 */
		.cost-group-header {
			background-color: #e3f2fd; /* 淺藍色背景 */
			color: var(--primary-color);
			font-weight: bold;
			padding: 10px;
			margin-top: 15px;
			border-left: 5px solid var(--primary-color);
			display: flex;
			justify-content: space-between;
			align-items: center;
			border-radius: 4px;
		}

		.cost-group-header .group-title {
			font-size: 1rem;
		}

		.cost-group-header .group-subtotal {
			color: var(--accent-color);
			font-size: 1rem;
		}
		
    </style>
</head>
<body class="theme-blue scroll-prevention">
    <!-- 手機選單按鈕 -->
    <div class="mobile-menu-btn" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
    </div>
    
    <!-- 遮罩層 -->
    <div class="overlay" id="overlay"></div>
    
    <!-- 滾動到頂部/底部按鈕 -->
    <div class="scroll-buttons">
        <button class="scroll-btn" id="scrollToTopBtn">
            <i class="fas fa-chevron-up"></i>
        </button>
        <button class="scroll-btn" id="scrollToBottomBtn">
            <i class="fas fa-chevron-down"></i>
        </button>
    </div>
    
    <div class="container scroll-prevention">
        <header>
            <div class="header-left">
                <h1><i class="fas fa-map-marked-alt"></i> 旅遊計劃規劃</h1>
                <p class="tagline">輕鬆規劃您的完美旅程</p>
            </div>
            <div class="header-right">
                <div class="header-top-row">
                    <div class="theme-selector">
                        <div class="theme-btn blue active" data-theme="theme-blue"></div>
                        <div class="theme-btn green" data-theme="theme-green"></div>
                        <div class="theme-btn purple" data-theme="theme-purple"></div>
                    </div>
                    <!-- 分享模式指示器 -->
                    <div class="shared-mode-indicator" id="sharedModeIndicator">
                        <i class="fas fa-share-alt"></i>
                        <span>分享模式</span>
                    </div>
                    <!-- 退出分享模式按鈕 -->
                    <button class="exit-share-mode-btn" id="exitShareModeBtn">
                        <i class="fas fa-times"></i>
                        <span>退出分享</span>
                    </button>
                </div>
                <div class="header-bottom-row">
                    <div class="cloud-status disconnected" id="cloudStatus">
                        <i class="fas fa-cloud"></i>
                        <span>雲端未連接</span>
                    </div>
                    <button class="cloud-btn cloud-settings" id="cloudSettingsBtn">
                        <i class="fas fa-cog"></i>
                        <span>雲端設定</span>
                    </button>
                    <button class="cloud-btn cloud-backup" id="cloudBackupBtn" disabled>
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>雲端備份</span>
                    </button>
                    <button class="cloud-btn cloud-restore" id="cloudRestoreBtn" disabled>
                        <i class="fas fa-cloud-download-alt"></i>
                        <span>雲端還原</span>
                    </button>
                    <button class="cloud-btn cloud-share" id="cloudShareBtn" disabled>
                        <i class="fas fa-share-alt"></i>
                        <span>分享代碼</span>
                    </button>
                    <button class="cloud-btn cloud-delete" id="cloudDeleteBtn" disabled>
                        <i class="fas fa-trash-alt"></i>
                        <span>刪除備份</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="app-container">
            <!-- 旅遊計劃面板 -->
            <div class="plans-panel" id="plansPanel">
                <h2><i class="fas fa-calendar-alt"></i> 旅遊計劃</h2>
                <div class="plan-actions">
                    <button class="btn btn-primary" id="addPlanBtn"><i class="fas fa-plus"></i> 新增計劃</button>
                    <button class="btn btn-secondary" id="backupBtn"><i class="fas fa-download"></i> 本地備份</button>
                    <button class="btn btn-secondary" id="restoreBtn"><i class="fas fa-upload"></i> 本地還原</button>
                    <button class="btn btn-secondary" id="exchangeRateBtn"><i class="fas fa-money-bill-wave"></i> 匯率設定</button>
                    <button class="btn btn-view-mode" id="viewModeBtn"><i class="fas fa-eye"></i> 檢視模式</button>
                </div>
                
                <div class="plans-list" id="plansList">
                    <!-- 計劃項目將動態生成 -->
                </div>
                
                <!-- 已過期計劃區域 -->
                <div id="expiredPlansContainer" style="display: none;">
                    <div class="expired-plans-header" id="expiredPlansHeader">
                        <div class="expired-plans-title">
                            <i class="fas fa-chevron-down" id="expiredPlansIcon"></i>
                            <span>已過期旅遊計劃</span>
                            <span class="expired-plans-count" id="expiredPlansCount">0</span>
                        </div>
                    </div>
                    <div class="expired-plans-content" id="expiredPlansContent">
                        <!-- 已過期計劃項目將動態生成 -->
                    </div>
                </div>
            </div>

            <!-- 行程面板 -->
            <div class="itinerary-panel scroll-prevention">
                <div id="noPlanSelected" class="no-plan-selected">
                    <i class="fas fa-plane"></i>
                    <h3>請選擇或建立一個旅遊計劃</h3>
                    <p>從左側面板選擇一個計劃，或點擊「新增計劃」按鈕開始規劃</p>
                </div>
                
                <div id="planContent" style="display: none;">
                    <div class="plan-header">
                        <div class="plan-header-left">
                            <h2 id="currentPlanName">計劃名稱</h2>
                            <p id="currentPlanDates">日期範圍</p>
                        </div>
                        <div class="plan-header-right">
                            <div class="plan-actions">
                                <button class="btn btn-accent" id="sharePlanBtn"><i class="fas fa-share-alt"></i> 分享</button>
                                <button class="btn btn-danger" id="deletePlanBtn"><i class="fas fa-trash-alt"></i> 刪除</button>
                                <div class="view-mode-controls">
                                    <button class="btn btn-primary" id="exitViewModeBtn"><i class="fas fa-edit"></i> 退出檢視模式</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="days-tabs-container" id="daysTabsContainer">
                        <div class="days-tabs" id="daysTabs">
                            <!-- 天數標籤將動態生成 -->
                        </div>
                    </div>
                    
                    <div id="daysContent">
                        <!-- 每日內容將動態生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 浮動按鈕 -->
    <div class="floating-buttons">
        <div class="floating-btn add-activity" id="addActivityBtn">
            <i class="fas fa-plus"></i>
            <span class="floating-btn-text">+行程</span>
        </div>
        <div class="floating-btn add-transport" id="addTransportBtn">
            <i class="fas fa-plus"></i>
            <span class="floating-btn-text">+交通</span>
        </div>
        <div class="floating-btn add-cost" id="addCostBtn">
            <i class="fas fa-plus"></i>
            <span class="floating-btn-text">+費用</span>
        </div>
    </div>

    <!-- 新增/編輯計劃模態框 -->
    <div class="modal" id="planModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="planModalTitle">新增旅遊計劃</h3>
                <button class="btn btn-secondary" id="closePlanModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="planForm">
                    <div class="form-group">
                        <label for="planName">計劃名稱</label>
                        <input type="text" id="planName" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="planStartDate">旅遊開始日期</label>
                            <input type="date" id="planStartDate" required>
                        </div>
                        <div class="form-group">
                            <label for="planDays">預計旅遊天數</label>
                            <input type="number" id="planDays" min="1" max="365" value="3" required>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelPlanBtn">取消</button>
                        <button type="submit" class="btn btn-primary">儲存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 新增/編輯行程模態框 -->
    <div class="modal" id="activityModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="activityModalTitle">新增行程</h3>
                <button class="btn btn-secondary" id="closeActivityModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="activityForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="activityStartTime">開始時間</label>
                            <input type="text" id="activityStartTime" placeholder="例如：0900" required>
                        </div>
                        <div class="form-group">
                            <label for="activityEndTime">結束時間（非必填）</label>
                            <input type="text" id="activityEndTime" placeholder="例如：1100">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="activityName">行程名稱</label>
                        <input type="text" id="activityName" required>
                    </div>
                    <div class="form-group">
                        <label for="activityCategory">分類</label>
                        <select id="activityCategory" required>
                            <option value="attraction">景點</option>
                            <option value="transport">交通</option>
                            <option value="activity">活動</option>
                            <option value="accommodation">住宿</option>
                            <option value="shopping">購物</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    
                    <!-- 前一晚住宿選擇（僅當類別為住宿時顯示） -->
                    <div id="previousAccommodationContainer" class="previous-accommodation" style="display: none;">
                        <label for="previousAccommodation">選擇前一晚住宿地點</label>
                        <select id="previousAccommodation">
                            <option value="">無（新住宿地點）</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="activityLocation">地點</label>
                            <input type="text" id="activityLocation" required>
                        </div>
                        <div class="form-group">
                            <label for="activityAddress">地址</label>
                            <input type="text" id="activityAddress">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="activityCost">費用</label>
                                <input type="number" id="activityCost" min="0" step="0.01" value="0">
                            </div>
                            <div class="form-group">
                                <label for="activityCurrency">幣別</label>
                                <select id="activityCurrency">
                                    <option value="TWD">新台幣 (TWD)</option>
                                    <option value="USD">美元 (USD)</option>
                                    <option value="JPY">日圓 (JPY)</option>
                                    <option value="EUR">歐元 (EUR)</option>
                                    <option value="CNY">人民幣 (CNY)</option>
                                    <option value="KRW">韓元 (KRW)</option>
                                    <option value="HKD">港幣 (HKD)</option>
                                    <option value="GBP">英鎊 (GBP)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="activityParticipants">分攤人數</label>
                                <input type="number" id="activityParticipants" min="1" value="1">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 多連結區域 -->
                    <div class="links-container">
                        <div class="links-title">
                            <label>相關連結</label>
                            <button type="button" class="add-link-btn" id="addActivityLinkBtn">
                                <i class="fas fa-plus"></i> 新增連結
                            </button>
                        </div>
                        <div id="activityLinksContainer">
                            <!-- 連結項目將動態生成 -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="activityNotes">行程備註</label>
                        <textarea id="activityNotes" rows="3"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelActivityBtn">取消</button>
                        <button type="submit" class="btn btn-primary">儲存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 新增/編輯交通方式模態框 -->
    <div class="modal" id="transportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="transportModalTitle">新增交通方式</h3>
                <button class="btn btn-secondary" id="closeTransportModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="transportForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transportFromActivity">起始行程</label>
                            <select id="transportFromActivity" required>
                                <!-- 行程選項將動態生成 -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="transportToActivity">結束行程</label>
                            <select id="transportToActivity" required>
                                <!-- 行程選項將動態生成 -->
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transportStartTime">開始時間</label>
                            <input type="text" id="transportStartTime" placeholder="例如：0900" required>
                        </div>
                        <div class="form-group">
                            <label for="transportEndTime">結束時間</label>
                            <input type="text" id="transportEndTime" placeholder="例如：0930" required>
                        </div>
                    </div>
                    
                    <!-- 多交通方式區域 -->
                    <div class="transport-options-container">
                        <div class="links-title">
                            <label>交通方式選項</label>
                            <button type="button" class="add-transport-option-btn" id="addTransportOptionBtn">
                                <i class="fas fa-plus"></i> 新增交通方式
                            </button>
                        </div>
                        <div id="transportOptionsContainer">
                            <!-- 交通方式選項將動態生成 -->
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelTransportBtn">取消</button>
                        <button type="submit" class="btn btn-primary">儲存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 新增/編輯費用模態框 -->
    <div class="modal" id="costModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="costModalTitle">新增費用</h3>
                <button class="btn btn-secondary" id="closeCostModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="costForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="costDate">日期</label>
                            <input type="date" id="costDate" required>
                        </div>
                        <div class="form-group">
                            <label for="costCategory">類別</label>
                            <select id="costCategory" required>
                                <option value="transport">交通</option>
                                <option value="shopping">購物</option>
                                <option value="food">飲食</option>
                                <option value="insurance">保險</option>
                                <option value="internet">網路</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="costDescription">費用說明</label>
                        <input type="text" id="costDescription" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="costAmount">金額</label>
                            <input type="number" id="costAmount" min="0" step="0.01" value="0" required>
                        </div>
                        <div class="form-group">
                            <label for="costCurrency">幣別</label>
                            <select id="costCurrency" required>
                                <option value="TWD">新台幣 (TWD)</option>
                                <option value="USD">美元 (USD)</option>
                                <option value="JPY">日圓 (JPY)</option>
                                <option value="EUR">歐元 (EUR)</option>
                                <option value="CNY">人民幣 (CNY)</option>
                                <option value="KRW">韓元 (KRW)</option>
                                <option value="HKD">港幣 (HKD)</option>
                                <option value="GBP">英鎊 (GBP)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="costParticipants">分攤人數</label>
                            <input type="number" id="costParticipants" min="1" value="1" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="costNotes">備註</label>
                        <textarea id="costNotes" rows="3"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelCostBtn">取消</button>
                        <button type="submit" class="btn btn-primary">儲存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 匯率設定模態框 -->
    <div class="modal" id="exchangeRateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exchange-alt"></i> 匯率設定</h3>
                <button class="btn btn-secondary" id="closeExchangeRateModal">&times;</button>
            </div>

			<div class="modal-body">
				<p style="margin-bottom: 20px; color: var(--light-text);">設定外幣對新台幣(TWD)的匯率，用於費用統計計算。</p>
    
				<button type="button" class="btn btn-info" id="autoFetchRateBtn" style="margin-bottom: 20px; width: 100%; justify-content: center;">
					<i class="fas fa-sync-alt"></i> 自動取得最新匯率 (來源: ExchangeRate-API)
			</button>
    
    <div class="form-group">
				
                    <div class="exchange-rate-item">
                        <label>美元 (USD):</label>
                        <input type="number" id="usdRate" min="0" step="0.01" value="30.5" placeholder="1 USD = ? TWD">
                    </div>
                    <div class="exchange-rate-item">
                        <label>日圓 (JPY):</label>
                        <input type="number" id="jpyRate" min="0" step="0.0001" value="0.22" placeholder="1 JPY = ? TWD">
                    </div>
                    <div class="exchange-rate-item">
                        <label>歐元 (EUR):</label>
                        <input type="number" id="eurRate" min="0" step="0.01" value="33.5" placeholder="1 EUR = ? TWD">
                    </div>
                    <div class="exchange-rate-item">
                        <label>人民幣 (CNY):</label>
                        <input type="number" id="cnyRate" min="0" step="0.01" value="4.3" placeholder="1 CNY = ? TWD">
                    </div>
                    <div class="exchange-rate-item">
                        <label>韓元 (KRW):</label>
                        <input type="number" id="krwRate" min="0" step="0.0001" value="0.023" placeholder="1 KRW = ? TWD">
                    </div>
                    <div class="exchange-rate-item">
                        <label>港幣 (HKD):</label>
                        <input type="number" id="hkdRate" min="0" step="0.01" value="3.9" placeholder="1 HKD = ? TWD">
                    </div>
                    <div class="exchange-rate-item">
                        <label>英鎊 (GBP):</label>
                        <input type="number" id="gbpRate" min="0" step="0.01" value="38.5" placeholder="1 GBP = ? TWD">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelExchangeRateBtn">取消</button>
                    <button type="button" class="btn btn-primary" id="saveExchangeRateBtn">儲存匯率</button>
                </div>
            </div>
        </div>
    </div>

    <!-- GitHub雲端設定模態框 -->
    <div class="modal" id="githubCloudModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fab fa-github"></i> GitHub雲端設定</h3>
                <button class="btn btn-secondary" id="closeGithubCloudModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="github-info">
                    <h4>如何獲取GitHub Personal Access Token：</h4>
                    <ol>
                        <li>登入您的GitHub帳戶</li>
                        <li>點擊右上角頭像，選擇「Settings」</li>
                        <li>左側選單選擇「Developer settings」</li>
                        <li>選擇「Personal access tokens」→「Tokens (classic)」</li>
                        <li>點擊「Generate new token」→「Generate new token (classic)」</li>
                        <li>填入Token名稱（例如：旅行計劃應用程式）</li>
                        <li>選擇過期時間（建議選擇「No expiration」）</li>
                        <li>選擇權限：勾選「gist」</li>
                        <li>點擊「Generate token」按鈕</li>
                        <li>複製生成的Token並貼到下方欄位</li>
                    </ol>
                    <p><strong>注意：</strong>Token僅顯示一次，請務必妥善保存。</p>
                </div>
                <form id="githubCloudForm">
                    <div class="form-group">
                        <label for="githubToken">GitHub Personal Access Token</label>
                        <input type="password" id="githubToken" class="token-input" placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required>
                    </div>
                    <div class="form-group">
                        <label for="gistId">Gist ID (選填)</label>
                        <input type="text" id="gistId" placeholder="留空將創建新的Gist，或輸入現有Gist ID進行更新">
                        <p style="font-size: 0.8rem; color: var(--light-text); margin-top: 5px;">Gist ID可以在Gist網址中找到：https://gist.github.com/username/<strong>xxxxxxxxxxxxxxxxxxxxxxxx</strong></p>
                    </div>
                    <div class="form-group">
                        <label for="gistDescription">Gist描述</label>
                        <input type="text" id="gistDescription" value="旅遊計劃備份">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelGithubCloudBtn">取消</button>
                        <button type="submit" class="btn btn-primary">連接GitHub</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 雲端備份模態框 -->
    <div class="modal" id="cloudBackupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-cloud-upload-alt"></i> 雲端備份</h3>
                <button class="btn btn-secondary" id="closeCloudBackupModal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: var(--light-text);">選擇要備份到雲端的旅遊計劃（可多選）：</p>
                
                <div class="cloud-backup-list" id="cloudBackupList">
                    <!-- 備份計劃列表將動態生成 -->
                </div>
                
                <div class="cloud-backup-actions">
                    <div class="cloud-backup-selected-count" id="cloudBackupSelectedCount">
                        已選擇 0 個計劃
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary" id="cancelCloudBackupBtn">取消</button>
                        <button type="button" class="btn btn-primary" id="confirmCloudBackupBtn" disabled>
                            <i class="fas fa-cloud-upload-alt"></i> 開始備份
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 雲端還原模態框 -->
    <div class="modal" id="cloudRestoreModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-cloud-download-alt"></i> 雲端還原</h3>
                <button class="btn btn-secondary" id="closeCloudRestoreModal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: var(--light-text);">選擇要從雲端還原的旅遊計劃（可多選）：</p>
                
                <div class="cloud-restore-list" id="cloudRestoreList">
                    <!-- 還原計劃列表將動態生成 -->
                </div>
                
                <div class="cloud-restore-actions">
                    <div class="cloud-restore-selected-count" id="cloudRestoreSelectedCount">
                        已選擇 0 個計劃
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary" id="cancelCloudRestoreBtn">取消</button>
                        <button type="button" class="btn btn-primary" id="confirmCloudRestoreBtn" disabled>
                            <i class="fas fa-cloud-download-alt"></i> 開始還原
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 分享代碼模態框 -->
    <div class="modal" id="cloudShareModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-share-alt"></i> 生成分享代碼</h3>
                <button class="btn btn-secondary" id="closeCloudShareModal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: var(--light-text);">選擇要分享的旅遊計劃（可多選）：</p>
                
                <div class="cloud-share-list" id="cloudShareList">
                    <!-- 分享計劃列表將動態生成 -->
                </div>
                
                <div class="cloud-share-actions">
                    <div class="cloud-share-selected-count" id="cloudShareSelectedCount">
                        已選擇 0 個計劃
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary" id="cancelCloudShareBtn">取消</button>
                        <button type="button" class="btn btn-info" id="generateShareCodeBtn" disabled>
                            <i class="fas fa-code"></i> 生成分享代碼
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 分享代碼結果模態框 -->
    <div class="modal" id="shareCodeResultModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-share-alt"></i> 分享代碼已生成</h3>
                <button class="btn btn-secondary" id="closeShareCodeResultModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="share-code-container">
                    <div class="share-code-header">
                        <h4><i class="fas fa-link"></i> 分享連結</h4>
                    </div>
                    
                    <div class="share-code-content">
                        <p style="margin-bottom: 10px; color: var(--light-text);">複製以下連結分享給其他人：</p>
                        
                        <div class="share-code-url" id="shareCodeUrl">
                            <!-- 分享連結將動態生成 -->
                        </div>
                        
                        <!-- QR Code 區域 -->
                        <div class="share-code-qr" id="shareCodeQr">
                            <!-- QR Code 將動態生成 -->
                        </div>
                        
                        <div class="share-code-actions">
                            <button class="copy-btn" id="copyShareLinkBtn">
                                <i class="fas fa-copy"></i> 複製連結
                            </button>
                            <button class="test-share-btn" id="testShareLinkBtn">
                                <i class="fas fa-external-link-alt"></i> 測試開啟
                            </button>
                        </div>
                    </div>
                    
                    <div class="share-info">
                        <h4><i class="fas fa-info-circle"></i> 分享代碼說明</h4>
                        <ul>
                            <li>此連結使用GitHub Gist儲存旅遊計劃數據</li>
                            <li>接收者無需登入或設定即可查看計劃內容</li>
                            <li>分享模式為唯讀，無法編輯或修改計劃</li>
                            <li>分享連結永久有效，除非手動刪除Gist</li>
                            <li>數據儲存在公開Gist中，請勿包含敏感資訊</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 刪除雲端備份模態框 -->
    <div class="modal" id="cloudDeleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-trash-alt"></i> 刪除雲端備份</h3>
                <button class="btn btn-secondary" id="closeCloudDeleteModal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: var(--light-text);">選擇要刪除的雲端備份檔案（可多選）：</p>
                
                <div class="cloud-delete-list" id="cloudDeleteList">
                    <!-- 刪除備份列表將動態生成 -->
                </div>
                
                <div class="cloud-delete-actions">
                    <div class="cloud-delete-selected-count" id="cloudDeleteSelectedCount">
                        已選擇 0 個備份檔案
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary" id="cancelCloudDeleteBtn">取消</button>
                        <button type="button" class="btn btn-danger" id="confirmCloudDeleteBtn" disabled>
                            <i class="fas fa-trash-alt"></i> 刪除備份
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 應用狀態
        const state = {
            currentPlanId: null,
            currentDay: 1,
			costSortMode: 'date',
            plans: [],
            nextId: 1,
            exchangeRates: {
                USD: 30.5,
                JPY: 0.22,
                EUR: 33.5,
                CNY: 4.3,
                KRW: 0.023,
                HKD: 3.9,
                GBP: 38.5,
                TWD: 1 // 台幣對台幣匯率為1
            },
            githubConfig: {
                token: null,
                gistId: null,
                description: "旅遊計劃備份",
                isConnected: false
            },
            isViewMode: false,
            isSharedMode: false, // 新增：是否為分享模式
            cloudBackups: [], // 儲存雲端備份清單
            showExpiredPlans: false // 是否顯示已過期計劃
        };

        // 初始化應用
        document.addEventListener('DOMContentLoaded', function() {
            console.log('應用程式初始化...');
            
            // 檢查URL是否有分享代碼
            const hasShareCode = checkForShareCode();
            
            if (!hasShareCode) {
                // 正常模式：載入本地儲存
                loadPlansFromStorage();
                loadExchangeRatesFromStorage();
                loadGithubConfigFromStorage();
            }
            
            // 設置事件監聽器
            setupEventListeners();
            
            // 初始化UI
            if (!state.isSharedMode) {
                updatePlansList();
                updateCostSummary();
                updateCloudStatus();
            }
            
            // 設置時間格式化
            setupTimeFormatting();
            
            console.log('應用程式初始化完成，模式:', state.isSharedMode ? '分享模式' : '正常模式');
        });

        // 檢查URL是否有分享代碼（修改版本：使用 Gist ID）
        function checkForShareCode() {
            let shareCode = null;

            // 檢查 Hash (#) 中的參數
            if (window.location.hash) {
                const hashString = window.location.hash.substring(1);
                const hashParams = new URLSearchParams(hashString);
                shareCode = hashParams.get('share');
            }

            // 如果 Hash 沒找到，檢查 Search (?) (相容舊連結)
            if (!shareCode) {
                const searchParams = new URLSearchParams(window.location.search);
                shareCode = searchParams.get('share');
            }
            
            if (shareCode) {
                console.log('檢測到分享代碼，嘗試從Gist載入...', shareCode);
                
                // 檢查是否是Gist ID格式（32字元的十六進制字串）
                if (shareCode.length === 32 && /^[0-9a-f]+$/.test(shareCode)) {
                    // 從Gist載入分享數據
                    loadShareFromGist(shareCode);
                } else {
                    // 嘗試解析舊格式的分享代碼（Base64編碼）

                    try {
                        console.log('嘗試解析舊格式分享代碼...');
                        // 修正：增加對中文字元的相容性處理
                        const decodedData = decodeURIComponent(escape(atob(shareCode)));
                        const shareData = JSON.parse(decodedData);
                        
                        // 驗證分享數據結構
                        if (!shareData.plans || !Array.isArray(shareData.plans)) {
                            // 如果是單一計劃格式，封裝成陣列以相容 enterShareMode
                            if (shareData.id && (shareData.activities || shareData.transports)) {
                                const singlePlan = shareData;
                                // 【核心修復】確保 activities 陣列存在
                                if (!singlePlan.activities) singlePlan.activities = [];
                                if (!singlePlan.transports) singlePlan.transports = [];
                                
                                enterShareMode({ plans: [singlePlan] });
                                return true;
                            }
                            
                            console.error('分享代碼格式錯誤');
                            alert('分享代碼格式錯誤，無法載入計劃');
                            return false;
                        }
                        
                        // 【核心修復】確保陣列中的每個計劃都有 activities 屬性
                        shareData.plans.forEach(plan => {
                            if (!plan.activities) plan.activities = [];
                            if (!plan.transports) plan.transports = [];
                        });
                        
                        // 進入分享模式
                        enterShareMode(shareData);
                        return true;
                        
                    } catch (error) {
                        // ... 原有的 catch 邏輯 ...
                        console.error('分享代碼解析失敗:', error);
                        alert('分享代碼解析失敗，請檢查連結是否正確');
                        return false;
                    }
                }
                return true;
            }
            
            return false;
        }

        // 從Gist載入分享數據
        async function loadShareFromGist(gistId) {
            try {
                console.log('從Gist載入分享數據，Gist ID:', gistId);
                
                // 從Gist載入數據
                const response = await fetch(`https://api.github.com/gists/${gistId}`);
                
                if (!response.ok) {
                    throw new Error('無法載入分享數據，請檢查Gist ID是否正確');
                }
                
                const gistData = await response.json();
                
                // 尋找分享數據檔案
                let shareData = null;
                for (const [filename, file] of Object.entries(gistData.files)) {
                    if (filename.includes('travel_plan_share') || filename.endsWith('.json')) {
                        try {
                            // 直接從Gist API獲取內容（不需要再次fetch）
                            if (file.content) {
                                shareData = JSON.parse(file.content);
                                break;
                            } else if (file.raw_url) {
                                // 如果需要，透過 raw_url 下載
                                const contentResponse = await fetch(file.raw_url);
                                if (contentResponse.ok) {
                                    shareData = await contentResponse.json();
                                    break;
                                }
                            }
                        } catch (parseError) {
                            console.error('解析Gist檔案失敗:', parseError);
                        }
                    }
                }
                
                if (!shareData) {
                    // 如果沒有找到特定檔案，嘗試解析任何JSON檔案
                    for (const [filename, file] of Object.entries(gistData.files)) {
                        if (filename.endsWith('.json')) {
                            try {
                                if (file.content) {
                                    const data = JSON.parse(file.content);
                                    if (data.plans && Array.isArray(data.plans)) {
                                        shareData = data;
                                        break;
                                    }
                                }
                            } catch (error) {
                                // 繼續嘗試下一個檔案
                                continue;
                            }
                        }
                    }
                }
                
                if (!shareData) {
                    throw new Error('在Gist中找不到有效的分享數據');
                }
                
                // 驗證分享數據結構
                if (!shareData.plans || !Array.isArray(shareData.plans)) {
                    throw new Error('分享數據格式錯誤');
                }
                
                // 進入分享模式
                enterShareMode(shareData);
                
            } catch (error) {
                console.error('載入分享數據失敗:', error);
                alert('載入分享數據失敗：' + error.message);
                exitShareMode();
            }
        }

        // 進入分享模式 (修復版)
        function enterShareMode(shareData) {
            console.log('進入分享模式，載入分享的計劃...');
            
            state.isSharedMode = true;
            state.isViewMode = true; // 關鍵：確保渲染函數知道現在是檢視狀態
            document.body.classList.add('shared-mode');
            document.body.classList.add('view-mode'); 
            
            // 顯示分享模式指示器
            const indicator = document.getElementById('sharedModeIndicator');
            if (indicator) indicator.style.display = 'flex';
            const exitBtn = document.getElementById('exitShareModeBtn');
            if (exitBtn) exitBtn.style.display = 'inline-flex';
            
            try {
                // 確保每個計劃都有資料
                if (shareData.plans && Array.isArray(shareData.plans)) {
                    shareData.plans.forEach(plan => {
                        if (!plan.activities) plan.activities = [];
                        if (!plan.transports) plan.transports = [];
                    });
                    state.plans = shareData.plans;
                }

                // 【修正重點：載入匯率設定】
                // 檢查分享資料中是否有 exchangeRates，若有則更新 state
                if (shareData.exchangeRates) {
                    state.exchangeRates = { ...state.exchangeRates, ...shareData.exchangeRates };
                    console.log('已載入分享的匯率設定', state.exchangeRates);
                }

                // 更新 ID 計數器
                if (state.plans.length > 0) {
                    state.nextId = state.plans.reduce((maxId, plan) => Math.max(maxId, plan.id), 0) + 1;
                    state.currentPlanId = state.plans[0].id;
                    
                    // 延遲渲染確保 DOM 已經準備好
                    setTimeout(() => {
                        showPlanContent(); // 這裡負責畫出「行程」與「交通」
                        updatePlansList();
                        updateCostSummary();
                        
                        // 隱藏編輯元素
                        document.querySelectorAll('.edit-only, .floating-buttons, .edit-controls').forEach(el => {
                            el.style.setProperty('display', 'none', 'important');
                        });
                    }, 100);
                }
            } catch (error) {
                console.error('載入分享計劃錯誤:', error);
                alert('載入失敗: ' + error.message);
            }
        }

        // 退出分享模式
        function exitShareMode() {
            console.log('退出分享模式');
            
            // 清除狀態
            state.isSharedMode = false;
            state.plans = [];
            state.currentPlanId = null;
            state.githubConfig = {
                token: null,
                gistId: null,
                description: "旅遊計劃備份",
                isConnected: false
            };
            
            // 修正點：清除 URL 中的參數 (包含 search 和 hash)
            const url = new URL(window.location);
            url.searchParams.delete('share'); // 清除 ?share
            window.location.hash = '';        // 清除 #share
            window.history.replaceState({}, document.title, url.toString());
            
            // 移除CSS類別
            document.body.classList.remove('shared-mode');
            
            // 隱藏分享模式指示器
            document.getElementById('sharedModeIndicator').style.display = 'none';
            document.getElementById('exitShareModeBtn').style.display = 'none';
            
            // 重新載入本地儲存
            loadPlansFromStorage();
            loadExchangeRatesFromStorage();
            loadGithubConfigFromStorage();
            
            // 更新UI
            updatePlansList();
            updateCostSummary();
            updateCloudStatus();
            
            // 顯示無計劃選擇的訊息
            document.getElementById('noPlanSelected').style.display = 'block';
            document.getElementById('planContent').style.display = 'none';
            
            console.log('已退出分享模式，恢復正常模式');
        }

        // 從本地儲存載入GitHub設定
        function loadGithubConfigFromStorage() {
            const savedConfig = localStorage.getItem('githubConfig');
            if (savedConfig) {
                try {
                    state.githubConfig = JSON.parse(savedConfig);
                    console.log('已載入GitHub設定');
                    
                    // 測試連接
                    if (state.githubConfig.token && state.githubConfig.isConnected) {
                        testGithubConnection();
                    }
                } catch (error) {
                    console.error('載入GitHub設定時發生錯誤:', error);
                    state.githubConfig = {
                        token: null,
                        gistId: null,
                        description: "旅遊計劃備份",
                        isConnected: false
                    };
                }
            }
        }

        // 儲存GitHub設定到本地儲存
        function saveGithubConfigToStorage() {
            try {
                localStorage.setItem('githubConfig', JSON.stringify(state.githubConfig));
                console.log('GitHub設定已儲存到本地儲存');
            } catch (error) {
                console.error('儲存GitHub設定時發生錯誤:', error);
            }
        }

        // 從本地儲存載入計劃
        function loadPlansFromStorage() {
            const savedPlans = localStorage.getItem('travelPlans');
            if (savedPlans) {
                try {
                    state.plans = JSON.parse(savedPlans);
                    state.nextId = state.plans.reduce((maxId, plan) => Math.max(maxId, plan.id), 0) + 1;
                    console.log('已載入計劃:', state.plans.length, '個');
                } catch (error) {
                    console.error('載入計劃時發生錯誤:', error);
                    state.plans = [];
                }
            } else {
                console.log('沒有找到儲存的計劃');
            }
            
            if (state.plans.length > 0) {
                state.currentPlanId = state.plans[0].id;
                showPlanContent();
            }
        }

        // 從本地儲存載入匯率
        function loadExchangeRatesFromStorage() {
            const savedRates = localStorage.getItem('exchangeRates');
            if (savedRates) {
                try {
                    const rates = JSON.parse(savedRates);
                    state.exchangeRates = { ...state.exchangeRates, ...rates };
                    console.log('已載入匯率設定');
                } catch (error) {
                    console.error('載入匯率時發生錯誤:', error);
                }
            }
        }

        // 儲存計劃到本地儲存
        function savePlansToStorage() {
            try {
                localStorage.setItem('travelPlans', JSON.stringify(state.plans));
                console.log('計劃已儲存到本地儲存');
                updateCostSummary();
            } catch (error) {
                console.error('儲存計劃時發生錯誤:', error);
            }
        }

        // 儲存匯率到本地儲存
        function saveExchangeRatesToStorage() {
            try {
                localStorage.setItem('exchangeRates', JSON.stringify(state.exchangeRates));
                console.log('匯率已儲存到本地儲存');
            } catch (error) {
                console.error('儲存匯率時發生錯誤:', error);
            }
        }

        // 更新雲端狀態顯示
        function updateCloudStatus() {
            const cloudStatus = document.getElementById('cloudStatus');
            const cloudBackupBtn = document.getElementById('cloudBackupBtn');
            const cloudRestoreBtn = document.getElementById('cloudRestoreBtn');
            const cloudShareBtn = document.getElementById('cloudShareBtn');
            const cloudDeleteBtn = document.getElementById('cloudDeleteBtn');
            
            if (state.githubConfig.isConnected && state.githubConfig.token) {
                cloudStatus.className = 'cloud-status connected';
                cloudStatus.innerHTML = '<i class="fas fa-cloud"></i><span>雲端已連接</span>';
                cloudBackupBtn.disabled = false;
                cloudRestoreBtn.disabled = false;
                cloudShareBtn.disabled = false;
                cloudDeleteBtn.disabled = false;
            } else {
                cloudStatus.className = 'cloud-status disconnected';
                cloudStatus.innerHTML = '<i class="fas fa-cloud"></i><span>雲端未連接</span>';
                cloudBackupBtn.disabled = true;
                cloudRestoreBtn.disabled = true;
                cloudShareBtn.disabled = true;
                cloudDeleteBtn.disabled = true;
            }
        }

        // 測試GitHub連接
        async function testGithubConnection() {
            if (!state.githubConfig.token) {
                state.githubConfig.isConnected = false;
                updateCloudStatus();
                return false;
            }
            
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${state.githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    state.githubConfig.isConnected = true;
                    console.log('GitHub連接測試成功');
                    updateCloudStatus();
                    return true;
                } else {
                    state.githubConfig.isConnected = false;
                    console.log('GitHub連接測試失敗');
                    updateCloudStatus();
                    return false;
                }
            } catch (error) {
                console.error('GitHub連接測試錯誤:', error);
                state.githubConfig.isConnected = false;
                updateCloudStatus();
                return false;
            }
        }

        // 設置事件監聽器
        function setupEventListeners() {
            console.log('設置事件監聽器...');
            
            // 滾動到頂部/底部按鈕
            document.getElementById('scrollToTopBtn').addEventListener('click', function() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            
            document.getElementById('scrollToBottomBtn').addEventListener('click', function() {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            });
            
            // 主題選擇
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    document.body.className = this.dataset.theme;
                });
            });
            
            // 計劃相關按鈕
            document.getElementById('addPlanBtn').addEventListener('click', showAddPlanModal);
            document.getElementById('backupBtn').addEventListener('click', backupPlan);
            document.getElementById('restoreBtn').addEventListener('click', restorePlan);
            document.getElementById('exchangeRateBtn').addEventListener('click', showExchangeRateModal);
            document.getElementById('sharePlanBtn').addEventListener('click', sharePlan);
            document.getElementById('deletePlanBtn').addEventListener('click', deletePlan);
            
            // 檢視模式按鈕
            document.getElementById('viewModeBtn').addEventListener('click', enableViewMode);
            document.getElementById('exitViewModeBtn').addEventListener('click', exitViewMode);
            
            // 退出分享模式按鈕
            document.getElementById('exitShareModeBtn').addEventListener('click', exitShareMode);
            
            // 雲端相關按鈕
            document.getElementById('cloudSettingsBtn').addEventListener('click', showGithubCloudModal);
            document.getElementById('cloudBackupBtn').addEventListener('click', showCloudBackupModal);
            document.getElementById('cloudRestoreBtn').addEventListener('click', showCloudRestoreModal);
            document.getElementById('cloudShareBtn').addEventListener('click', showCloudShareModal);
            document.getElementById('cloudDeleteBtn').addEventListener('click', showCloudDeleteModal);
            
            // GitHub雲端設定模態框按鈕
            document.getElementById('closeGithubCloudModal').addEventListener('click', closeGithubCloudModal);
            document.getElementById('cancelGithubCloudBtn').addEventListener('click', closeGithubCloudModal);
            document.getElementById('githubCloudForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveGithubConfig();
            });
            
            // 雲端備份模態框按鈕
            document.getElementById('closeCloudBackupModal').addEventListener('click', closeCloudBackupModal);
            document.getElementById('cancelCloudBackupBtn').addEventListener('click', closeCloudBackupModal);
            document.getElementById('confirmCloudBackupBtn').addEventListener('click', startCloudBackup);
            
            // 雲端還原模態框按鈕
            document.getElementById('closeCloudRestoreModal').addEventListener('click', closeCloudRestoreModal);
            document.getElementById('cancelCloudRestoreBtn').addEventListener('click', closeCloudRestoreModal);
            document.getElementById('confirmCloudRestoreBtn').addEventListener('click', startCloudRestore);
            
            // 分享代碼模態框按鈕
            document.getElementById('closeCloudShareModal').addEventListener('click', closeCloudShareModal);
            document.getElementById('cancelCloudShareBtn').addEventListener('click', closeCloudShareModal);
            document.getElementById('generateShareCodeBtn').addEventListener('click', generateShareCode);
            
            // 分享代碼結果模態框按鈕
            document.getElementById('closeShareCodeResultModal').addEventListener('click', closeShareCodeResultModal);
            document.getElementById('copyShareLinkBtn').addEventListener('click', copyShareLink);
            document.getElementById('testShareLinkBtn').addEventListener('click', testShareLink);
            
            // 刪除雲端備份模態框按鈕
            document.getElementById('closeCloudDeleteModal').addEventListener('click', closeCloudDeleteModal);
            document.getElementById('cancelCloudDeleteBtn').addEventListener('click', closeCloudDeleteModal);
            document.getElementById('confirmCloudDeleteBtn').addEventListener('click', startCloudDelete);
            
            // 已過期計劃展開/收合
            document.getElementById('expiredPlansHeader').addEventListener('click', function() {
                const content = document.getElementById('expiredPlansContent');
                const icon = document.getElementById('expiredPlansIcon');
                
                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    icon.className = 'fas fa-chevron-down';
                } else {
                    content.classList.add('expanded');
                    icon.className = 'fas fa-chevron-up';
                }
            });
            
            // 手機選單按鈕
            document.getElementById('mobileMenuBtn').addEventListener('click', function() {
                document.getElementById('plansPanel').classList.toggle('active');
                document.getElementById('overlay').classList.toggle('active');
            });
            
            // 遮罩層點擊關閉選單
            document.getElementById('overlay').addEventListener('click', function() {
                document.getElementById('plansPanel').classList.remove('active');
                this.classList.remove('active');
            });
            
            // 模態框關閉按鈕
            document.getElementById('closePlanModal').addEventListener('click', closePlanModal);
            document.getElementById('closeActivityModal').addEventListener('click', closeActivityModal);
            document.getElementById('closeTransportModal').addEventListener('click', closeTransportModal);
            document.getElementById('closeCostModal').addEventListener('click', closeCostModal);
            document.getElementById('closeExchangeRateModal').addEventListener('click', closeExchangeRateModal);
            
            document.getElementById('cancelPlanBtn').addEventListener('click', closePlanModal);
            document.getElementById('cancelActivityBtn').addEventListener('click', closeActivityModal);
            document.getElementById('cancelTransportBtn').addEventListener('click', closeTransportModal);
            document.getElementById('cancelCostBtn').addEventListener('click', closeCostModal);
            document.getElementById('cancelExchangeRateBtn').addEventListener('click', closeExchangeRateModal);
            
            // 匯率設定儲存按鈕
            document.getElementById('saveExchangeRateBtn').addEventListener('click', saveExchangeRates);

			// 新增：自動取得匯率按鈕事件
			document.getElementById('autoFetchRateBtn').addEventListener('click', fetchLiveExchangeRates);
            
            // 行程類別變更時顯示/隱藏前一晚住宿選擇
            document.getElementById('activityCategory').addEventListener('change', function() {
                const previousAccommodationContainer = document.getElementById('previousAccommodationContainer');
                if (this.value === 'accommodation' && state.currentPlanId && state.currentDay > 1) {
                    loadPreviousAccommodations();
                    previousAccommodationContainer.style.display = 'block';
                } else {
                    previousAccommodationContainer.style.display = 'none';
                }
            });
            
            // 前一晚住宿選擇變更時更新地點和地址
            document.getElementById('previousAccommodation').addEventListener('change', function() {
                if (this.value) {
                    const plan = state.plans.find(p => p.id === state.currentPlanId);
                    if (plan && plan.activities) {
                        const accommodation = plan.activities.find(a => a.id === parseInt(this.value));
                        if (accommodation) {
                            document.getElementById('activityLocation').value = accommodation.location;
                            document.getElementById('activityAddress').value = accommodation.address || '';
                        }
                    }
                }
            });
            
            // 新增活動連結按鈕
            document.getElementById('addActivityLinkBtn').addEventListener('click', function() {
                addActivityLinkField();
            });
            
            // 新增交通方式按鈕
            document.getElementById('addTransportOptionBtn').addEventListener('click', function() {
                addTransportOptionField();
            });
            
            // 表單提交
            document.getElementById('planForm').addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('計劃表單提交');
                savePlan();
            });
            
            document.getElementById('activityForm').addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('行程表單提交');
                saveActivity();
            });
            
            document.getElementById('transportForm').addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('交通表單提交');
                saveTransport();
            });
            
            document.getElementById('costForm').addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('費用表單提交');
                saveCost();
            });
            
            // 浮動按鈕
            document.getElementById('addActivityBtn').addEventListener('click', showAddActivityModal);
            document.getElementById('addTransportBtn').addEventListener('click', showAddTransportModal);
            document.getElementById('addCostBtn').addEventListener('click', showAddCostModal);
            
            // 點擊模態框外部關閉
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });
            
            // 窗口大小改變時更新UI
            window.addEventListener('resize', function() {
                updateDaysTabsScroll();
            });
            
            console.log('事件監聽器設置完成');
        }

        // 顯示分享代碼模態框
        function showCloudShareModal() {
            if (state.plans.length === 0) {
                alert('目前沒有旅遊計劃可供分享');
                return;
            }
            
            // 更新分享計劃列表
            updateCloudShareList();
            
            document.getElementById('cloudShareModal').classList.add('active');
        }

        // 更新分享計劃列表
        function updateCloudShareList() {
            const cloudShareList = document.getElementById('cloudShareList');
            cloudShareList.innerHTML = '';
            
            if (state.plans.length === 0) {
                cloudShareList.innerHTML = `
                    <div class="cloud-share-empty">
                        <i class="fas fa-calendar-times"></i>
                        <p>目前沒有旅遊計劃</p>
                    </div>
                `;
                return;
            }
            
            state.plans.forEach(plan => {
                const planElement = document.createElement('div');
                planElement.className = 'cloud-share-item';
                
                const startDate = new Date(plan.startDate);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + plan.days - 1);
                
                planElement.innerHTML = `
                    <input type="checkbox" class="cloud-share-checkbox" data-id="${plan.id}">
                    <div class="cloud-share-info">
                        <div class="cloud-share-name">${plan.name}</div>
                        <div class="cloud-share-details">${formatDate(startDate)} - ${formatDate(endDate)} (${plan.days} 天)</div>
                    </div>
                `;
                
                cloudShareList.appendChild(planElement);
            });
            
            // 添加事件監聽器
            document.querySelectorAll('.cloud-share-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateCloudShareSelectedCount);
            });
            
            updateCloudShareSelectedCount();
        }

        // 更新分享計劃選擇計數
        function updateCloudShareSelectedCount() {
            const selectedCheckboxes = document.querySelectorAll('.cloud-share-checkbox:checked');
            const selectedCount = selectedCheckboxes.length;
            
            document.getElementById('cloudShareSelectedCount').textContent = `已選擇 ${selectedCount} 個計劃`;
            document.getElementById('generateShareCodeBtn').disabled = selectedCount === 0;
            
            // 更新選中項目的樣式
            document.querySelectorAll('.cloud-share-item').forEach(item => {
                const checkbox = item.querySelector('.cloud-share-checkbox');
                if (checkbox.checked) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // 關閉分享代碼模態框
        function closeCloudShareModal() {
            document.getElementById('cloudShareModal').classList.remove('active');
            // 取消所有選擇
            document.querySelectorAll('.cloud-share-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateCloudShareSelectedCount();
        }

        // 生成分享代碼（新版本：使用Gist儲存）
        // 生成分享代碼（修正版：確保包含行程與交通數據）
        async function generateShareCode() {
            const selectedCheckboxes = document.querySelectorAll('.cloud-share-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert('請至少選擇一個旅遊計劃進行分享');
                return;
            }
            
            const selectedPlanIds = Array.from(selectedCheckboxes).map(checkbox => parseInt(checkbox.dataset.id));
            
            // 【關鍵修正】提取資料時，明確結構化 activities 和 transports
            const selectedPlans = state.plans.filter(plan => selectedPlanIds.includes(plan.id)).map(plan => {
                return {
                    ...plan,
                    activities: plan.activities || [], // 確保行程存在
                    transports: plan.transports || []  // 確保交通存在
                };
            });
            
            try {
                // 建立分享數據（壓縮格式）
                const shareData = compressShareData({
                    plans: selectedPlans,
                    exchangeRates: state.exchangeRates,
                    timestamp: new Date().toISOString(),
                    version: '2.0',
                    appName: '旅遊計劃規劃'
                });
                
                // 生成Gist描述
                const planNames = selectedPlans.map(plan => plan.name).join(', ');
                const description = `旅遊計劃分享: ${planNames}`;
                const filename = `travel_plan_share_${Date.now()}.json`;
                
                // 建立Gist數據
                const gistData = {
                    description: description,
                    public: true, 
                    files: {
                        [filename]: {
                            content: JSON.stringify(shareData, null, 2)
                        }
                    }
                };
                
                // 顯示載入中狀態
                const generateBtn = document.getElementById('generateShareCodeBtn');
                const originalText = generateBtn.innerHTML;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...';
                generateBtn.disabled = true;
                
                let response;
                let gistId = null;
                
                try {
                    // 嘗試使用GitHub API創建Gist
                    const fetchOptions = {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify(gistData)
                    };

                    if (state.githubConfig && state.githubConfig.token) {
                        fetchOptions.headers['Authorization'] = `token ${state.githubConfig.token}`;
                    }

                    response = await fetch('https://api.github.com/gists', fetchOptions);
                    
                    if (response.ok) {
                        const result = await response.json();
                        gistId = result.id;
                    } else {
                        throw new Error('GitHub API請求失敗');
                    }
                } catch (githubError) {
                    console.warn('GitHub Gist創建失敗，使用備用方案:', githubError);
                    
                    // 備用方案：使用傳統方式產出 Base64 連結
                    const shareDataStr = JSON.stringify(shareData);
                    const compressedShareCode = btoa(unescape(encodeURIComponent(shareDataStr)));
                    
                    const currentUrl = window.location.origin + window.location.pathname;
                    const shareUrl = `${currentUrl}#share=${compressedShareCode}`;
                    
                    showShareCodeResult(shareUrl, selectedPlans, null);
                    closeCloudShareModal();
                    
                    generateBtn.innerHTML = originalText;
                    generateBtn.disabled = false;
                    return;
                }
                
                // 生成 Gist 短連結
                const currentUrl = window.location.origin + window.location.pathname;
                const shareUrl = `${currentUrl}#share=${gistId}`;
                
                showShareCodeResult(shareUrl, selectedPlans, gistId);
                closeCloudShareModal();
                
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
                
            } catch (error) {
                console.error('生成分享代碼錯誤:', error);
                const generateBtn = document.getElementById('generateShareCodeBtn');
                generateBtn.innerHTML = '<i class="fas fa-code"></i> 生成分享代碼';
                generateBtn.disabled = false;
                alert('生成分享代碼失敗：' + error.message);
            }
        }

        // 壓縮分享數據
        function compressShareData(shareData) {
            // 創建壓縮版本的數據，確保 activities 和 transports 完整保留
            const compressedData = {
                plans: shareData.plans.map(plan => {
                    // 確保 activities 和 transports 是陣列
                    const activities = Array.isArray(plan.activities) ? plan.activities : [];
                    const transports = Array.isArray(plan.transports) ? plan.transports : [];
                    
                    return {
                        ...plan, // 使用 ... 展開符號保留所有欄位(包含 id, name, days 等)
                        activities: activities.map(act => ({ ...act })), // 深度複製活動
                        transports: transports.map(ts => ({ ...ts }))   // 深度複製交通
                    };
                }),
                exchangeRates: shareData.exchangeRates,
                timestamp: shareData.timestamp,
                version: shareData.version,
                appName: shareData.appName
            };
            
            return compressedData;
        }

        // 創建壓縮分享代碼（備用方案）
        function createCompressedShareCode(shareData) {
            try {
                // 進一步壓縮數據
                const ultraCompressedData = {
                    p: shareData.plans, // plans
                    r: shareData.exchangeRates, // rates
                    t: shareData.timestamp, // timestamp
                    v: shareData.version // version
                };
                
                // 使用JSON.stringify壓縮
                const compressedJson = JSON.stringify(ultraCompressedData);
                
                // 使用Base64編碼（URL安全版本）
                const base64 = btoa(compressedJson)
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=+$/, '');
                
                return base64;
            } catch (error) {
                console.error('壓縮數據失敗:', error);
                throw error;
            }
        }

        // 顯示分享代碼結果
        function showShareCodeResult(shareUrl, selectedPlans, gistId) {
            // 更新分享連結
            const shareCodeUrl = document.getElementById('shareCodeUrl');
            shareCodeUrl.textContent = shareUrl;
            
            // 如果有Gist ID，顯示額外資訊
            const shareInfo = document.querySelector('.share-info');
            if (gistId) {
                const gistInfo = document.createElement('div');
                gistInfo.style.cssText = 'margin-top: 15px; padding: 12px; background: #e8f5e9; border-radius: 6px; font-size: 0.85rem;';
                gistInfo.innerHTML = `
                    <div style="font-weight: bold; color: #2e7d32; margin-bottom: 5px;">
                        <i class="fab fa-github"></i> GitHub Gist 資訊
                    </div>
                    <div style="word-break: break-all;">
                        <strong>Gist ID:</strong> ${gistId}
                    </div>
                    <div style="margin-top: 5px; font-size: 0.8rem; color: #666;">
                        也可訪問: <a href="https://gist.github.com/${gistId}" target="_blank" style="color: #4a6fa5;">https://gist.github.com/${gistId}</a>
                    </div>
                `;
                shareInfo.parentNode.insertBefore(gistInfo, shareInfo);
            }
            
            // 生成QR Code
            generateQRCode(shareUrl);
            
            // 顯示模態框
            document.getElementById('shareCodeResultModal').classList.add('active');
        }

        // 生成QR Code
        function generateQRCode(url) {
            const qrContainer = document.getElementById('shareCodeQr');
            qrContainer.innerHTML = '';
            
            // 簡單的QR Code生成（使用Canvas）
            const canvas = document.createElement('canvas');
            canvas.width = 200;
            canvas.height = 200;
            
            const ctx = canvas.getContext('2d');
            
            // 清除畫布
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 繪製QR Code（簡化版本）
            ctx.fillStyle = 'black';
            
            // 繪製邊框
            ctx.fillRect(10, 10, 180, 180);
            ctx.fillStyle = 'white';
            ctx.fillRect(20, 20, 160, 160);
            
            // 繪製URL文字（簡化顯示）
            ctx.fillStyle = 'black';
            ctx.font = '12px monospace';
            ctx.textAlign = 'center';
            ctx.fillText('分享連結', canvas.width / 2, 100);
            ctx.fillText('掃描或複製連結', canvas.width / 2, 120);
            ctx.fillText('開啟旅遊計劃', canvas.width / 2, 140);
            
            qrContainer.appendChild(canvas);
        }

        // 關閉分享代碼結果模態框
        function closeShareCodeResultModal() {
            document.getElementById('shareCodeResultModal').classList.remove('active');
            // 清除額外的Gist資訊
            const gistInfo = document.querySelector('.share-info').previousElementSibling;
            if (gistInfo && gistInfo.style && gistInfo.style.backgroundColor === 'rgb(232, 245, 233)') {
                gistInfo.remove();
            }
        }

        // 複製分享連結
        function copyShareLink() {
            const shareCodeUrl = document.getElementById('shareCodeUrl');
            const text = shareCodeUrl.textContent;
            
            navigator.clipboard.writeText(text).then(function() {
                const copyBtn = document.getElementById('copyShareLinkBtn');
                const originalText = copyBtn.innerHTML;
                
                copyBtn.innerHTML = '<i class="fas fa-check"></i> 已複製';
                copyBtn.classList.add('copied');
                
                setTimeout(function() {
                    copyBtn.innerHTML = originalText;
                    copyBtn.classList.remove('copied');
                }, 2000);
                
                console.log('分享連結已複製到剪貼簿');
            }).catch(function(err) {
                console.error('複製失敗:', err);
                alert('複製失敗，請手動複製連結');
            });
        }

        // 測試分享連結
        function testShareLink() {
            const shareCodeUrl = document.getElementById('shareCodeUrl');
            const url = shareCodeUrl.textContent;
            
            // 在新視窗中開啟
            window.open(url, '_blank');
        }

        // 啟用檢視模式
        function enableViewMode() {
            if (!state.currentPlanId) {
                alert('請先選擇一個旅遊計劃');
                return;
            }
            
            state.isViewMode = true;
            document.body.classList.add('view-mode');
            updateUIForViewMode();
        }

        // 退出檢視模式
        function exitViewMode() {
            state.isViewMode = false;
            document.body.classList.remove('view-mode');
            updateUIForViewMode();
        }

        // 更新UI以適應檢視模式
        function updateUIForViewMode() {
            // 更新活動顯示
            updateActivitiesContainer();
            
            // 更新計劃列表
            updatePlansList();
        }

        // 設置時間格式化
        function setupTimeFormatting() {
            document.addEventListener('blur', function(e) {
                if (e.target.matches('#activityStartTime, #activityEndTime, #transportStartTime, #transportEndTime')) {
                    formatTimeInput(e.target);
                }
            }, true);
        }

        // 格式化時間輸入
        function formatTimeInput(input) {
            let value = input.value.trim();
            if (value.length === 4 && /^\d{4}$/.test(value)) {
                const hours = value.substring(0, 2);
                const minutes = value.substring(2, 4);
                if (parseInt(hours) < 24 && parseInt(minutes) < 60) {
                    input.value = `${hours}:${minutes}`;
                }
            }
        }

        // 更新天數標籤滾動
        function updateDaysTabsScroll() {
            const daysTabsContainer = document.getElementById('daysTabsContainer');
            if (daysTabsContainer) {
                daysTabsContainer.scrollLeft = 0;
            }
        }

        // 顯示GitHub雲端設定模態框
        function showGithubCloudModal() {
            document.getElementById('githubToken').value = state.githubConfig.token || '';
            document.getElementById('gistId').value = state.githubConfig.gistId || '';
            document.getElementById('gistDescription').value = state.githubConfig.description || '旅遊計劃備份';
            document.getElementById('githubCloudModal').classList.add('active');
            
            setTimeout(() => {
                document.getElementById('githubToken').focus();
            }, 100);
        }

        // 關閉GitHub雲端設定模態框
        function closeGithubCloudModal() {
            document.getElementById('githubCloudModal').classList.remove('active');
            document.getElementById('githubCloudForm').reset();
        }

        // 儲存GitHub設定
        async function saveGithubConfig() {
            console.log('開始儲存GitHub設定...');
            
            const token = document.getElementById('githubToken').value.trim();
            const gistId = document.getElementById('gistId').value.trim() || null;
            const description = document.getElementById('gistDescription').value.trim() || '旅遊計劃備份';
            
            if (!token) {
                alert('請輸入GitHub Personal Access Token');
                return;
            }
            
            state.githubConfig.token = token;
            state.githubConfig.gistId = gistId;
            state.githubConfig.description = description;
            
            // 測試連接
            const isConnected = await testGithubConnection();
            
            if (isConnected) {
                // 如果提供了Gist ID，驗證Gist是否存在
                if (gistId) {
                    try {
                        const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                            headers: {
                                'Authorization': `token ${token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        
                        if (!response.ok) {
                            alert('找不到指定的Gist，請檢查Gist ID是否正確');
                            state.githubConfig.isConnected = false;
                            updateCloudStatus();
                            return;
                        }
                        
                        const gistData = await response.json();
                        console.log('Gist驗證成功:', gistData.description);
                    } catch (error) {
                        console.error('Gist驗證錯誤:', error);
                        alert('Gist驗證失敗，請檢查Gist ID是否正確');
                        state.githubConfig.isConnected = false;
                        updateCloudStatus();
                        return;
                    }
                }
                
                state.githubConfig.isConnected = true;
                saveGithubConfigToStorage();
                updateCloudStatus();
                alert('GitHub連接成功！');
                closeGithubCloudModal();
            } else {
                alert('GitHub連接失敗，請檢查Token是否正確');
                state.githubConfig.isConnected = false;
                updateCloudStatus();
            }
        }

        // 顯示雲端備份模態框
        function showCloudBackupModal() {
            if (!state.githubConfig.isConnected || !state.githubConfig.token) {
                alert('請先連接GitHub雲端');
                return;
            }
            
            if (state.plans.length === 0) {
                alert('目前沒有旅遊計劃可供備份');
                return;
            }
            
            // 更新備份計劃列表
            updateCloudBackupList();
            
            document.getElementById('cloudBackupModal').classList.add('active');
        }

        // 更新雲端備份列表
        function updateCloudBackupList() {
            const cloudBackupList = document.getElementById('cloudBackupList');
            cloudBackupList.innerHTML = '';
            
            if (state.plans.length === 0) {
                cloudBackupList.innerHTML = `
                    <div class="cloud-backup-empty">
                        <i class="fas fa-calendar-times"></i>
                        <p>目前沒有旅遊計劃</p>
                    </div>
                `;
                return;
            }
            
            state.plans.forEach(plan => {
                const planElement = document.createElement('div');
                planElement.className = 'cloud-backup-item';
                
                const startDate = new Date(plan.startDate);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + plan.days - 1);
                
                planElement.innerHTML = `
                    <input type="checkbox" class="cloud-backup-checkbox" data-id="${plan.id}">
                    <div class="cloud-backup-info">
                        <div class="cloud-backup-name">${plan.name}</div>
                        <div class="cloud-backup-details">${formatDate(startDate)} - ${formatDate(endDate)} (${plan.days} 天)</div>
                    </div>
                `;
                
                cloudBackupList.appendChild(planElement);
            });
            
            // 添加事件監聽器
            document.querySelectorAll('.cloud-backup-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateCloudBackupSelectedCount);
            });
            
            updateCloudBackupSelectedCount();
        }

        // 更新雲端備份選擇計數
        function updateCloudBackupSelectedCount() {
            const selectedCheckboxes = document.querySelectorAll('.cloud-backup-checkbox:checked');
            const selectedCount = selectedCheckboxes.length;
            
            document.getElementById('cloudBackupSelectedCount').textContent = `已選擇 ${selectedCount} 個計劃`;
            document.getElementById('confirmCloudBackupBtn').disabled = selectedCount === 0;
            
            // 更新選中項目的樣式
            document.querySelectorAll('.cloud-backup-item').forEach(item => {
                const checkbox = item.querySelector('.cloud-backup-checkbox');
                if (checkbox.checked) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // 關閉雲端備份模態框
        function closeCloudBackupModal() {
            document.getElementById('cloudBackupModal').classList.remove('active');
            // 取消所有選擇
            document.querySelectorAll('.cloud-backup-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateCloudBackupSelectedCount();
        }

        // 開始雲端備份
        async function startCloudBackup() {
            const selectedCheckboxes = document.querySelectorAll('.cloud-backup-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert('請至少選擇一個旅遊計劃進行備份');
                return;
            }
            
            const selectedPlanIds = Array.from(selectedCheckboxes).map(checkbox => parseInt(checkbox.dataset.id));
            const selectedPlans = state.plans.filter(plan => selectedPlanIds.includes(plan.id));
            
            try {
                const backupData = {
                    plans: selectedPlans,
                    exchangeRates: state.exchangeRates,
                    backupDate: new Date().toISOString(),
                    appVersion: '1.0'
                };
                
                const planNames = selectedPlans.map(plan => plan.name).join(', ');
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const filename = `旅遊計劃備份_${timestamp}.json`;
                
                const content = JSON.stringify(backupData, null, 2);
                
                const gistData = {
                    description: state.githubConfig.description || '旅遊計劃備份',
                    public: false,
                    files: {
                        [filename]: {
                            content: content
                        }
                    }
                };
                
                // 顯示備份進度
                const confirmBtn = document.getElementById('confirmCloudBackupBtn');
                const originalText = confirmBtn.innerHTML;
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 備份中...';
                confirmBtn.disabled = true;
                
                // 如果已有Gist ID，則更新現有Gist
                let response;
                if (state.githubConfig.gistId) {
                    // 先獲取現有Gist
                    try {
                        const getResponse = await fetch(`https://api.github.com/gists/${state.githubConfig.gistId}`, {
                            headers: {
                                'Authorization': `token ${state.githubConfig.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        
                        if (getResponse.ok) {
                            const existingGist = await getResponse.json();
                            // 合併檔案（保留現有檔案）
                            gistData.files = { ...existingGist.files, ...gistData.files };
                        }
                    } catch (error) {
                        console.error('獲取現有Gist失敗:', error);
                    }
                    
                    response = await fetch(`https://api.github.com/gists/${state.githubConfig.gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${state.githubConfig.token}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify(gistData)
                    });
                } else {
                    // 否則創建新的Gist
                    response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${state.githubConfig.token}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify(gistData)
                    });
                }
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // 如果是新創建的Gist，保存Gist ID
                    if (!state.githubConfig.gistId) {
                        state.githubConfig.gistId = result.id;
                        saveGithubConfigToStorage();
                    }
                    
                    // 重置按鈕狀態
                    confirmBtn.innerHTML = originalText;
                    confirmBtn.disabled = false;
                    
                    alert(`雲端備份成功！\n已備份 ${selectedPlans.length} 個計劃: ${planNames}`);
                    console.log('雲端備份成功，Gist ID:', state.githubConfig.gistId);
                    closeCloudBackupModal();
                } else {
                    const errorText = await response.text();
                    console.error('雲端備份失敗:', errorText);
                    
                    // 重置按鈕狀態
                    confirmBtn.innerHTML = originalText;
                    confirmBtn.disabled = false;
                    
                    alert('雲端備份失敗，請檢查網路連接或Token權限');
                }
            } catch (error) {
                console.error('雲端備份錯誤:', error);
                
                // 重置按鈕狀態
                const confirmBtn = document.getElementById('confirmCloudBackupBtn');
                confirmBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> 開始備份';
                confirmBtn.disabled = false;
                
                alert('雲端備份失敗：' + error.message);
            }
        }

        // 顯示雲端還原模態框
        async function showCloudRestoreModal() {
            if (!state.githubConfig.isConnected || !state.githubConfig.token) {
                alert('請先連接GitHub雲端');
                return;
            }
            
            if (!state.githubConfig.gistId) {
                alert('沒有找到可還原的Gist，請先進行雲端備份');
                return;
            }
            
            try {
                // 顯示載入狀態
                const cloudRestoreList = document.getElementById('cloudRestoreList');
                cloudRestoreList.innerHTML = `
                    <div class="cloud-restore-empty">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>載入雲端備份中...</p>
                    </div>
                `;
                
                document.getElementById('cloudRestoreModal').classList.add('active');
                
                // 獲取雲端備份清單
                await loadCloudBackups();
                
                // 更新還原列表
                updateCloudRestoreList();
                
            } catch (error) {
                console.error('載入雲端備份失敗:', error);
                alert('載入雲端備份失敗：' + error.message);
                closeCloudRestoreModal();
            }
        }

        // 載入雲端備份清單
        async function loadCloudBackups() {
            try {
                const response = await fetch(`https://api.github.com/gists/${state.githubConfig.gistId}`, {
                    headers: {
                        'Authorization': `token ${state.githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('取得Gist失敗:', errorText);
                    throw new Error('取得Gist失敗，請檢查Gist ID是否正確');
                }
                
                const gistData = await response.json();
                const files = gistData.files;
                
                if (!files || Object.keys(files).length === 0) {
                    throw new Error('Gist中沒有找到備份檔案');
                }
                
                state.cloudBackups = [];
                
                // 處理所有JSON檔案
                for (const [filename, file] of Object.entries(files)) {
                    if (file && filename.includes('旅遊計劃') && filename.endsWith('.json')) {
                        try {
                            // 透過 raw_url 下載實際內容
                            if (!file.raw_url) {
                                console.warn(`檔案 ${filename} 沒有 raw_url，跳過`);
                                continue;
                            }
                            
                            const rawResponse = await fetch(file.raw_url);
                            if (!rawResponse.ok) {
                                console.warn(`下載檔案 ${filename} 失敗`);
                                continue;
                            }
                            
                            const backupData = await rawResponse.json();
                            
                            if (backupData && backupData.plans && Array.isArray(backupData.plans)) {
                                // 提取備份資訊
                                const backupInfo = {
                                    filename: filename,
                                    rawUrl: file.raw_url,
                                    backupDate: backupData.backupDate || new Date().toISOString(),
                                    plans: backupData.plans,
                                    planCount: backupData.plans.length,
                                    gistId: state.githubConfig.gistId
                                };
                                
                                state.cloudBackups.push(backupInfo);
                            }
                        } catch (parseError) {
                            console.error(`解析備份檔案 ${filename} 失敗:`, parseError);
                        }
                    }
                }
                
                // 按備份日期排序（最新的在前）
                state.cloudBackups.sort((a, b) => {
                    return new Date(b.backupDate) - new Date(a.backupDate);
                });
                
                console.log('載入雲端備份成功:', state.cloudBackups.length, '個備份');
                
            } catch (error) {
                console.error('載入雲端備份清單錯誤:', error);
                throw error;
            }
        }

        // 更新雲端還原列表
        function updateCloudRestoreList() {
            const cloudRestoreList = document.getElementById('cloudRestoreList');
            cloudRestoreList.innerHTML = '';
            
            if (state.cloudBackups.length === 0) {
                cloudRestoreList.innerHTML = `
                    <div class="cloud-restore-empty">
                        <i class="fas fa-cloud"></i>
                        <p>沒有找到可還原的備份</p>
                    </div>
                `;
                return;
            }
            
            state.cloudBackups.forEach((backup, index) => {
                const backupElement = document.createElement('div');
                backupElement.className = 'cloud-restore-item';
                
                const backupDate = new Date(backup.backupDate);
                const planNames = backup.plans.map(plan => plan.name).join(', ');
                
                backupElement.innerHTML = `
                    <input type="checkbox" class="cloud-restore-checkbox" data-index="${index}">
                    <div class="cloud-restore-info">
                        <div class="cloud-restore-name">備份 ${index + 1}</div>
                        <div class="cloud-restore-details">
                            <div>包含計劃: ${planNames}</div>
                            <div class="cloud-backup-datetime">備份時間: ${backupDate.toLocaleString('zh-TW')}</div>
                        </div>
                    </div>
                `;
                
                cloudRestoreList.appendChild(backupElement);
            });
            
            // 添加事件監聽器
            document.querySelectorAll('.cloud-restore-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateCloudRestoreSelectedCount);
            });
            
            updateCloudRestoreSelectedCount();
        }

        // 更新雲端還原選擇計數
        function updateCloudRestoreSelectedCount() {
            const selectedCheckboxes = document.querySelectorAll('.cloud-restore-checkbox:checked');
            const selectedCount = selectedCheckboxes.length;
            
            document.getElementById('cloudRestoreSelectedCount').textContent = `已選擇 ${selectedCount} 個備份`;
            document.getElementById('confirmCloudRestoreBtn').disabled = selectedCount === 0;
            
            // 更新選中項目的樣式
            document.querySelectorAll('.cloud-restore-item').forEach(item => {
                const checkbox = item.querySelector('.cloud-restore-checkbox');
                if (checkbox.checked) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // 關閉雲端還原模態框
        function closeCloudRestoreModal() {
            document.getElementById('cloudRestoreModal').classList.remove('active');
            // 取消所有選擇
            document.querySelectorAll('.cloud-restore-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateCloudRestoreSelectedCount();
            state.cloudBackups = [];
        }

        // 開始雲端還原
        async function startCloudRestore() {
            const selectedCheckboxes = document.querySelectorAll('.cloud-restore-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert('請至少選擇一個備份進行還原');
                return;
            }
            
            const selectedBackupIndices = Array.from(selectedCheckboxes).map(checkbox => parseInt(checkbox.dataset.index));
            const selectedBackups = selectedBackupIndices.map(index => state.cloudBackups[index]);
            
            // 確認還原
            const backupInfo = selectedBackups.map(backup => 
                `• ${backup.plans.length} 個計劃 (${backup.plans.map(p => p.name).join(', ')})`
            ).join('\n');
            
            if (!confirm(`確定要還原以下備份嗎？這將把選中的計劃添加到您的計劃列表中。\n\n${backupInfo}`)) {
                return;
            }
            
            try {
                // 顯示還原進度
                const confirmBtn = document.getElementById('confirmCloudRestoreBtn');
                const originalText = confirmBtn.innerHTML;
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 還原中...';
                confirmBtn.disabled = true;
                
                let restoredPlanCount = 0;
                let restoredPlans = [];
                
                // 遍歷所有選中的備份
                for (const backup of selectedBackups) {
                    for (const plan of backup.plans) {
                        // 檢查是否已存在相同ID的計劃
                        const existingPlanIndex = state.plans.findIndex(p => p.id === plan.id);
                        
                        if (existingPlanIndex !== -1) {
                            // 如果已存在，創建新ID
                            plan.id = state.nextId++;
                            plan.name = `${plan.name} (還原)`;
                        }
                        
                        // 確保活動和交通方式有唯一ID
                        if (plan.activities) {
                            plan.activities.forEach(activity => {
                                if (!activity.id) activity.id = Date.now() + Math.random();
                            });
                        }
                        if (plan.transports) {
                            plan.transports.forEach(transport => {
                                if (!transport.id) transport.id = Date.now() + Math.random();
                            });
                        }
                        
                        // 添加到計劃列表
                        state.plans.push(plan);
                        restoredPlanCount++;
                        restoredPlans.push(plan.name);
                    }
                }
                
                // 更新下一個ID
                state.nextId = state.plans.reduce((maxId, plan) => Math.max(maxId, plan.id), 0) + 1;
                
                // 保存到本地儲存
                savePlansToStorage();
                
                // 更新UI
                updatePlansList();
                updateCostSummary();
                
                // 重置按鈕狀態
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
                
                alert(`雲端還原成功！\n已還原 ${restoredPlanCount} 個計劃: ${restoredPlans.join(', ')}`);
                console.log('雲端還原成功，還原了', restoredPlanCount, '個計劃');
                closeCloudRestoreModal();
                
                // 如果有還原的計劃，顯示第一個
                if (restoredPlanCount > 0 && !state.currentPlanId) {
                    state.currentPlanId = state.plans[0].id;
                    showPlanContent();
                }
                
            } catch (error) {
                console.error('雲端還原錯誤:', error);
                
                // 重置按鈕狀態
                const confirmBtn = document.getElementById('confirmCloudRestoreBtn');
                confirmBtn.innerHTML = '<i class="fas fa-cloud-download-alt"></i> 開始還原';
                confirmBtn.disabled = false;
                
                alert('雲端還原失敗：' + error.message);
            }
        }

        // 顯示刪除雲端備份模態框
        async function showCloudDeleteModal() {
            if (!state.githubConfig.isConnected || !state.githubConfig.token) {
                alert('請先連接GitHub雲端');
                return;
            }
            
            if (!state.githubConfig.gistId) {
                alert('沒有找到可刪除的Gist');
                return;
            }
            
            try {
                // 顯示載入狀態
                const cloudDeleteList = document.getElementById('cloudDeleteList');
                cloudDeleteList.innerHTML = `
                    <div class="cloud-delete-empty">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>載入雲端備份中...</p>
                    </div>
                `;
                
                document.getElementById('cloudDeleteModal').classList.add('active');
                
                // 獲取雲端備份清單
                await loadCloudBackups();
                
                // 更新刪除列表
                updateCloudDeleteList();
                
            } catch (error) {
                console.error('載入雲端備份失敗:', error);
                alert('載入雲端備份失敗：' + error.message);
                closeCloudDeleteModal();
            }
        }

        // 更新刪除雲端備份列表
        function updateCloudDeleteList() {
            const cloudDeleteList = document.getElementById('cloudDeleteList');
            cloudDeleteList.innerHTML = '';
            
            if (state.cloudBackups.length === 0) {
                cloudDeleteList.innerHTML = `
                    <div class="cloud-delete-empty">
                        <i class="fas fa-cloud"></i>
                        <p>沒有找到可刪除的備份</p>
                    </div>
                `;
                return;
            }
            
            state.cloudBackups.forEach((backup, index) => {
                const deleteElement = document.createElement('div');
                deleteElement.className = 'cloud-delete-item';
                
                const backupDate = new Date(backup.backupDate);
                const planNames = backup.plans.map(plan => plan.name).join(', ');
                
                deleteElement.innerHTML = `
                    <input type="checkbox" class="cloud-delete-checkbox" data-index="${index}">
                    <div class="cloud-delete-info">
                        <div class="cloud-delete-name">${backup.filename}</div>
                        <div class="cloud-delete-details">
                            <div>包含計劃: ${planNames}</div>
                            <div class="cloud-backup-datetime">備份時間: ${backupDate.toLocaleString('zh-TW')}</div>
                        </div>
                    </div>
                `;
                
                cloudDeleteList.appendChild(deleteElement);
            });
            
            // 添加事件監聽器
            document.querySelectorAll('.cloud-delete-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateCloudDeleteSelectedCount);
            });
            
            updateCloudDeleteSelectedCount();
        }

        // 更新刪除雲端備份選擇計數
        function updateCloudDeleteSelectedCount() {
            const selectedCheckboxes = document.querySelectorAll('.cloud-delete-checkbox:checked');
            const selectedCount = selectedCheckboxes.length;
            
            document.getElementById('cloudDeleteSelectedCount').textContent = `已選擇 ${selectedCount} 個備份檔案`;
            document.getElementById('confirmCloudDeleteBtn').disabled = selectedCount === 0;
            
            // 更新選中項目的樣式
            document.querySelectorAll('.cloud-delete-item').forEach(item => {
                const checkbox = item.querySelector('.cloud-delete-checkbox');
                if (checkbox.checked) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // 關閉刪除雲端備份模態框
        function closeCloudDeleteModal() {
            document.getElementById('cloudDeleteModal').classList.remove('active');
            // 取消所有選擇
            document.querySelectorAll('.cloud-delete-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateCloudDeleteSelectedCount();
            state.cloudBackups = [];
        }

        // 開始刪除雲端備份
        async function startCloudDelete() {
            const selectedCheckboxes = document.querySelectorAll('.cloud-delete-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert('請至少選擇一個備份檔案進行刪除');
                return;
            }
            
            const selectedBackupIndices = Array.from(selectedCheckboxes).map(checkbox => parseInt(checkbox.dataset.index));
            const selectedBackups = selectedBackupIndices.map(index => state.cloudBackups[index]);
            
            // 確認刪除
            const backupInfo = selectedBackups.map(backup => 
                `• ${backup.filename} (${backup.plans.length} 個計劃)`
            ).join('\n');
            
            if (!confirm(`確定要刪除以下備份檔案嗎？此操作無法復原！\n\n${backupInfo}`)) {
                return;
            }
            
            try {
                // 顯示刪除進度
                const confirmBtn = document.getElementById('confirmCloudDeleteBtn');
                const originalText = confirmBtn.innerHTML;
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 刪除中...';
                confirmBtn.disabled = true;
                
                // 先獲取現有Gist
                const getResponse = await fetch(`https://api.github.com/gists/${state.githubConfig.gistId}`, {
                    headers: {
                        'Authorization': `token ${state.githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getResponse.ok) {
                    throw new Error('取得Gist失敗');
                }
                
                const existingGist = await getResponse.json();
                const files = { ...existingGist.files };
                
                // 刪除選中的檔案
                selectedBackups.forEach(backup => {
                    delete files[backup.filename];
                });
                
                // 如果還有其他檔案，更新Gist；否則刪除整個Gist
                if (Object.keys(files).length > 0) {
                    const gistData = {
                        description: state.githubConfig.description || '旅遊計劃備份',
                        public: false,
                        files: files
                    };
                    
                    const response = await fetch(`https://api.github.com/gists/${state.githubConfig.gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${state.githubConfig.token}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify(gistData)
                    });
                    
                    if (!response.ok) {
                        throw new Error('更新Gist失敗');
                    }
                } else {
                    // 刪除整個Gist
                    const response = await fetch(`https://api.github.com/gists/${state.githubConfig.gistId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `token ${state.githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('刪除Gist失敗');
                    }
                    
                    // 清除Gist ID
                    state.githubConfig.gistId = null;
                    saveGithubConfigToStorage();
                }
                
                // 重置按鈕狀態
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
                
                alert(`已成功刪除 ${selectedBackups.length} 個備份檔案`);
                console.log('刪除雲端備份成功');
                closeCloudDeleteModal();
                
            } catch (error) {
                console.error('刪除雲端備份錯誤:', error);
                
                // 重置按鈕狀態
                const confirmBtn = document.getElementById('confirmCloudDeleteBtn');
                confirmBtn.innerHTML = '<i class="fas fa-trash-alt"></i> 刪除備份';
                confirmBtn.disabled = false;
                
                alert('刪除雲端備份失敗：' + error.message);
            }
        }

        // 更新計劃列表（按照要求排序）
        function updatePlansList() {
            const plansList = document.getElementById('plansList');
            const expiredPlansContent = document.getElementById('expiredPlansContent');
            const expiredPlansContainer = document.getElementById('expiredPlansContainer');
            
            plansList.innerHTML = '';
            expiredPlansContent.innerHTML = '';
            
            if (state.plans.length === 0) {
                plansList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">暫無旅遊計劃</div>';
                expiredPlansContainer.style.display = 'none';
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // 分離未過期和已過期的計劃
            const activePlans = [];
            const expiredPlans = [];
            
            state.plans.forEach(plan => {
                const endDate = new Date(plan.startDate);
                endDate.setDate(endDate.getDate() + plan.days - 1);
                
                if (endDate >= today) {
                    activePlans.push(plan);
                } else {
                    expiredPlans.push(plan);
                }
            });
            
            // 未過期計劃：由近到遠排序
            activePlans.sort((a, b) => {
                const dateA = new Date(a.startDate);
                const dateB = new Date(b.startDate);
                return dateA - dateB; // 由近到遠
            });
            
            // 顯示未過期計劃
            if (activePlans.length === 0) {
                plansList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">暫無未過期旅遊計劃</div>';
            } else {
                activePlans.forEach(plan => {
                    const planElement = createPlanElement(plan);
                    plansList.appendChild(planElement);
                });
            }
            
            // 顯示已過期計劃
            if (expiredPlans.length > 0) {
                expiredPlansContainer.style.display = 'block';
                document.getElementById('expiredPlansCount').textContent = expiredPlans.length;
                
                expiredPlans.forEach(plan => {
                    const planElement = createPlanElement(plan, true);
                    expiredPlansContent.appendChild(planElement);
                });
            } else {
                expiredPlansContainer.style.display = 'none';
            }
        }

        // 創建計劃元素
        function createPlanElement(plan, isExpired = false) {
            const planElement = document.createElement('div');
            planElement.className = `plan-item ${state.currentPlanId === plan.id ? 'active' : ''} ${isExpired ? 'expired-plan-item' : ''}`;
            planElement.dataset.id = plan.id;
            
            const startDate = new Date(plan.startDate);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + plan.days - 1);
            
            // 在分享模式下隱藏編輯按鈕
            const editButtonHtml = state.isSharedMode ? '' : `
                <button class="btn btn-small btn-secondary edit-plan edit-controls" data-id="${plan.id}">
                    <i class="fas fa-edit"></i>
                </button>
            `;
            
            planElement.innerHTML = `
                <div class="plan-item-header">
                    <div class="plan-item-name">${plan.name}</div>
                    <div>
                        ${editButtonHtml}
                    </div>
                </div>
                <div class="plan-item-dates">${formatDate(startDate)} - ${formatDate(endDate)}</div>
                <div class="plan-item-days">${plan.days} 天</div>
            `;
            
            // 在分享模式下，計劃項目不可點擊
            if (!state.isSharedMode) {
                planElement.addEventListener('click', function(e) {
                    if (!e.target.closest('.edit-plan') && !state.isViewMode) {
                        state.currentPlanId = plan.id;
                        updatePlansList();
                        showPlanContent();
                        
                        if (window.innerWidth <= 1024) {
                            document.getElementById('plansPanel').classList.remove('active');
                            document.getElementById('overlay').classList.remove('active');
                        }
                    }
                });
                
                const editBtn = planElement.querySelector('.edit-plan');
                if (editBtn) {
                    editBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        showEditPlanModal(plan.id);
                    });
                }
            }
            
            return planElement;
        }

        // 顯示計劃內容
        function showPlanContent() {
            const plan = state.plans.find(p => p.id === state.currentPlanId);
            if (!plan) {
                document.getElementById('noPlanSelected').style.display = 'block';
                document.getElementById('planContent').style.display = 'none';
                return;
            }
            
            document.getElementById('noPlanSelected').style.display = 'none';
            document.getElementById('planContent').style.display = 'block';
            
            document.getElementById('currentPlanName').textContent = plan.name;
            
            const startDate = new Date(plan.startDate);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + plan.days - 1);
            document.getElementById('currentPlanDates').textContent = 
                `${formatDate(startDate)} - ${formatDate(endDate)} (${plan.days} 天)`;
            
            updateDaysTabs(plan);
            showDayContent(1);
        }

        // 更新天數標籤（包含費用頁簽）
        function updateDaysTabs(plan) {
            const daysTabsContainer = document.getElementById('daysTabsContainer');
            const daysTabs = document.getElementById('daysTabs');
            const daysContent = document.getElementById('daysContent');
            
            daysTabs.innerHTML = '';
            daysContent.innerHTML = '';
            
            for (let i = 1; i <= plan.days; i++) {
                const dayTab = document.createElement('div');
                dayTab.className = `day-tab ${i === state.currentDay ? 'active' : ''}`;
                dayTab.textContent = `Day ${i}`;
                dayTab.dataset.day = i;
                
                // 修復：移除分享模式的判斷，允許分享模式下也能點擊切換天數
                dayTab.addEventListener('click', function() {
                    state.currentDay = parseInt(this.dataset.day);
                    document.querySelectorAll('.day-tab').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.cost-tab').forEach(tab => tab.classList.remove('active'));
                    this.classList.add('active');
                    showDayContent(state.currentDay);
                });
                
                daysTabs.appendChild(dayTab);
                
                const dayContent = document.createElement('div');
                dayContent.className = `day-content ${i === state.currentDay ? 'active' : ''}`;
                dayContent.dataset.day = i;
                
                const dayTitle = plan.dayTitles && plan.dayTitles[i] ? plan.dayTitles[i] : `第 ${i} 天`;
                
                // 在分享模式下，隱藏標題輸入框
                const titleInputHtml = state.isSharedMode ? 
                    `<h3 class="day-title-input" style="border: none; background: transparent; padding: 0; margin-bottom: 20px;">${dayTitle}</h3>` :
                    `<input type="text" class="day-title-input" value="${dayTitle}" data-day="${i}" placeholder="輸入當日標題">`;
                
                dayContent.innerHTML = `
                    ${titleInputHtml}
                    <div class="activities-container" data-day="${i}"></div>
                `;
                
                // 正常模式下添加事件監聽器
                if (!state.isSharedMode) {
                    const titleInput = dayContent.querySelector('.day-title-input');
                    if (titleInput && titleInput.tagName === 'INPUT') {
                        titleInput.addEventListener('change', function() {
                            saveDayTitle(plan.id, parseInt(this.dataset.day), this.value);
                        });
                    }
                }
                
                daysContent.appendChild(dayContent);
            }
            
            // 添加費用頁簽
            const costTab = document.createElement('div');
            costTab.className = 'day-tab cost-tab';
            costTab.textContent = '費用';
            costTab.dataset.tab = 'cost';
            
            // 修復：移除分享模式的判斷，允許分享模式下也能查看費用
            costTab.addEventListener('click', function() {
                document.querySelectorAll('.day-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.cost-tab').forEach(tab => tab.classList.remove('active'));
                this.classList.add('active');
                showCostContent();
            });
            
            daysTabs.appendChild(costTab);
            
            // 添加費用內容區域
            const costContent = document.createElement('div');
            costContent.className = 'cost-content';
            costContent.id = 'costContent';
            
            // 在分享模式下，隱藏新增費用按鈕
            // 1. 定義「新增費用」按鈕的 HTML (原有的)
			const addCostButtonHtml = state.isSharedMode ? '' : `
				<button class="btn btn-primary" id="addCostBtn2">
					<i class="fas fa-plus"></i> 新增費用
				</button>
			`;

			// 2. 定義「排序/分組方式」下拉選單的 HTML (新增的)
			const sortControlHtml = `
				<div style="display: flex; align-items: center; gap: 10px; margin-left: auto;">
					<label for="costSortSelect" style="margin:0; font-weight:600; color:var(--text-color);">
						<i class="fas fa-filter"></i> 分組方式：
					</label>
					<select id="costSortSelect" style="padding: 6px; border-radius: 4px; border: 1px solid var(--border-color); width: auto;">
						<option value="date" ${state.costSortMode === 'date' ? 'selected' : ''}>依日期</option>
						<option value="category" ${state.costSortMode === 'category' ? 'selected' : ''}>依類別</option>
					</select>
				</div>
			`;

			// 3. 組合並填入 costContent
			costContent.innerHTML = `
				<div class="cost-management">
					<div class="cost-categories">
						<div class="cost-category-badge"><i class="fas fa-shopping-cart"></i> 購物</div>
						<div class="cost-category-badge"><i class="fas fa-utensils"></i> 飲食</div>
						<div class="cost-category-badge"><i class="fas fa-shield-alt"></i> 保險</div>
						<div class="cost-category-badge"><i class="fas fa-wifi"></i> 網路</div>
						<div class="cost-category-badge"><i class="fas fa-bus"></i> 交通</div>
						<div class="cost-category-badge"><i class="fas fa-ellipsis-h"></i> 其他</div>
					</div>
				</div>
				
				<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
					<div class="cost-list-actions">
						${addCostButtonHtml}
					</div>
					${sortControlHtml}
				</div>

				<div class="cost-summary" style="margin-top: 0;">
					<h3><i class="fas fa-calculator"></i> 費用列表</h3>
					<div class="table-responsive">
						<table class="cost-table" id="costTable">
							<thead>
								<tr>
									<th>日期</th>
									<th>類別</th>
									<th>說明</th>
									<th>幣別</th>
									<th>原幣費用</th>
									<th>換算台幣</th>
									<th>分攤人數</th>
									<th>每人費用(台幣)</th>
									${(!state.isSharedMode && !state.isViewMode) ? '<th>操作</th>' : ''}
								</tr>
							</thead>
							<tbody id="costTableBody">
								</tbody>
						</table>
					</div>
				</div>
			`;

			// 4. 重要：必須在 HTML 加入後綁定選單切換事件
			setTimeout(() => {
				const sortSelect = costContent.querySelector('#costSortSelect');
				if (sortSelect) {
					sortSelect.addEventListener('change', function() {
						state.costSortMode = this.value; // 更新 state 裡的模式
						updateCostSummary();           // 立即重新刷新列表顯示
					});
				}
			}, 0);
            
            daysContent.appendChild(costContent);
            
            // 正常模式下為新增費用按鈕添加事件監聽器
            if (!state.isSharedMode) {
                setTimeout(() => {
                    const addCostBtn2 = document.getElementById('addCostBtn2');
                    if (addCostBtn2) {
                        addCostBtn2.addEventListener('click', showAddCostModal);
                    }
                }, 100);
            }
            
            updateActivitiesContainer();
            checkPreviousDayAccommodation(plan);
            updateCostSummary();
        }

        // 檢查前一天的住宿，作為今日的起點
        function checkPreviousDayAccommodation(plan) {
            if (state.currentDay > 1) {
                const previousDay = state.currentDay - 1;
                const previousDayActivities = plan.activities ? plan.activities.filter(a => a.day === previousDay) : [];
                
                const previousAccommodation = previousDayActivities.find(a => a.category === 'accommodation');
                
                if (previousAccommodation) {
                    const currentDayActivities = plan.activities ? plan.activities.filter(a => a.day === state.currentDay) : [];
                    
                    const hasStartFromAccommodation = currentDayActivities.some(a => 
                        a.location === previousAccommodation.location
                    );
                    
                    if (!hasStartFromAccommodation && currentDayActivities.length > 0) {
                        const activitiesContainer = document.querySelector(`.activities-container[data-day="${state.currentDay}"]`);
                        if (activitiesContainer && !activitiesContainer.querySelector('.accommodation-start-point')) {
                            const accommodationPoint = document.createElement('div');
                            accommodationPoint.className = 'transport-item accommodation-start-point';
                            accommodationPoint.innerHTML = `
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-bed" style="color: #ef6c00;"></i>
                                    <div>
                                        <div style="font-weight: bold; color: #ef6c00;">今日起點：前一天的住宿</div>
                                        <div>${previousAccommodation.name} - ${previousAccommodation.location}</div>
                                    </div>
                                </div>
                            `;
                            activitiesContainer.insertBefore(accommodationPoint, activitiesContainer.firstChild);
                        }
                    }
                }
            }
        }

        // 載入前一晚的住宿選項
        function loadPreviousAccommodations() {
            const select = document.getElementById('previousAccommodation');
            select.innerHTML = '<option value="">無（新住宿地點）</option>';
            
            if (state.currentPlanId && state.currentDay > 1) {
                const plan = state.plans.find(p => p.id === state.currentPlanId);
                if (plan && plan.activities) {
                    const previousDay = state.currentDay - 1;
                    const accommodations = plan.activities.filter(a => 
                        a.day === previousDay && a.category === 'accommodation'
                    );
                    
                    accommodations.forEach(accommodation => {
                        const option = document.createElement('option');
                        option.value = accommodation.id;
                        option.textContent = `${accommodation.name} - ${accommodation.location}`;
                        select.appendChild(option);
                    });
                }
            }
        }

        // 顯示指定天數的內容
        function showDayContent(day) {
            document.querySelectorAll('.day-content').forEach(content => {
                content.classList.remove('active');
                if (parseInt(content.dataset.day) === day) {
                    content.classList.add('active');
                }
            });
            
            document.querySelectorAll('.cost-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.day-tab').forEach(tab => {
                tab.classList.remove('active');
                if (parseInt(tab.dataset.day) === day) {
                    tab.classList.add('active');
                }
            });
            
            document.querySelectorAll('.cost-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            state.currentDay = day;
            updateActivitiesContainer();
            
            const plan = state.plans.find(p => p.id === state.currentPlanId);
            if (plan) {
                checkPreviousDayAccommodation(plan);
            }
        }

        // 顯示費用內容
        function showCostContent() {
            document.querySelectorAll('.day-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.cost-content').forEach(content => {
                content.classList.add('active');
            });
            
            document.querySelectorAll('.day-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.cost-tab').forEach(tab => {
                tab.classList.add('active');
            });
            
            updateCostSummary();
        }


	// 更新活動容器
	function updateActivitiesContainer() {
	    const plan = state.plans.find(p => p.id === state.currentPlanId);
	    if (!plan) return;

	    const day = state.currentDay;
	    const activitiesContainer = document.querySelector(`.activities-container[data-day="${day}"]`);
	    if (!activitiesContainer) return;

	    activitiesContainer.innerHTML = '';

	    const dayActivities = plan.activities ? plan.activities.filter(a => a.day === day) : [];
	    const dayTransports = plan.transports ? plan.transports.filter(t => t.day === day) : [];

	    if (dayActivities.length === 0) {
	        activitiesContainer.innerHTML = `
	            <div style="text-align: center; padding: 40px 20px; color: #999;">
	                <i class="fas fa-calendar-plus" style="font-size: 3rem; margin-bottom: 15px;"></i>
	                <p>還沒有行程安排${state.isSharedMode ? '' : '，點擊右下角的「+行程」按鈕開始規劃'}</p>
	            </div>
	        `;
	        return;
	    }

	    // 依照時間排序
	    dayActivities.sort((a, b) => {
	        const timeA = a.startTime ? parseTime(a.startTime) : 0;
	        const timeB = b.startTime ? parseTime(b.startTime) : 0;
	        return timeA - timeB;
	    });

	    dayActivities.forEach((activity, index) => {
	        const activityElement = createActivityElement(activity, index, day);
	        activitiesContainer.appendChild(activityElement);

	        // 如果不是最後一個活動，尋找兩者之間的交通
	        if (index < dayActivities.length - 1) {
	            const nextActivity = dayActivities[index + 1];
	            const transportsBetween = dayTransports.filter(t => t.fromActivityId === activity.id && t.toActivityId === nextActivity.id);
            
	            transportsBetween.forEach(transport => {
	                const transportElement = createTransportElement(transport);
	                activitiesContainer.appendChild(transportElement);
	            });
	        }
	    });
	}

	// 創建活動元素 - 完整替換版 (已加入連結顯示邏輯)
	function createActivityElement(activity, index, day) {
	    const activityElement = document.createElement('div');
	    activityElement.className = 'activity-item';
	    activityElement.dataset.id = activity.id;
	    activityElement.dataset.type = 'activity';

	    // 如果不是分享或檢視模式，則允許拖拽
	    if (!state.isSharedMode && !state.isViewMode) {
	        activityElement.draggable = true;
	    }

	    const categoryLabels = {
	        attraction: '景點', transport: '交通', activity: '活動',
	        accommodation: '住宿', shopping: '購物', other: '其他'
	    };
	    const categoryClasses = {
	        attraction: 'attraction', transport: 'transport', activity: 'activity',
	        accommodation: 'accommodation', shopping: 'shopping', other: 'other'
	    };

	    // 費用計算
	    const originalCost = activity.cost || 0;
	    const currency = activity.currency || 'TWD';
	    const exchangeRate = state.exchangeRates[currency] || 1;
	    const twdCost = originalCost * exchangeRate;

	    // --- 新增：行程連結 HTML 生成邏輯 ---
	    let linksHtml = '';
	    if (activity.links && Array.isArray(activity.links) && activity.links.length > 0) {
	        linksHtml = '<div class="activity-links" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px;">';
	        activity.links.forEach(link => {
	            if (link.url) {
	                // 自動檢查並補上 http 協議
	                const url = link.url.startsWith('http') ? link.url : `https://${link.url}`;
	                const name = link.name || '相關連結';
	                linksHtml += `
	                    <a href="${url}" target="_blank" style="font-size: 0.9rem; text-decoration: none; color: #4a6fa5;">
	                        <i class="fas fa-external-link-alt"></i> ${name}
	                    </a>`;
	            }
	        });
	        linksHtml += '</div>';
	    }

	    // 建立編輯/刪除按鈕（僅在非分享且非檢視模式顯示）
	    const showControls = !state.isSharedMode && !state.isViewMode;
	    const editControlsHtml = showControls ? `
	        <div style="margin-top: 10px; text-align: right;" class="edit-controls">
	            <button class="btn btn-small btn-secondary edit-activity" data-id="${activity.id}">
	                <i class="fas fa-edit"></i> 編輯
	            </button>
	            <button class="btn btn-small btn-danger delete-activity" data-id="${activity.id}">
	                <i class="fas fa-trash-alt"></i> 刪除
	            </button>
	        </div>
	    ` : '';

	    activityElement.innerHTML = `
	        <div class="activity-header">
	            <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 8px; max-width: 100%;">
	                <span class="activity-name">${activity.name}</span>
	                <span class="activity-category ${categoryClasses[activity.category]}">
	                    ${categoryLabels[activity.category]}
	                </span>
	            </div>
	            <div class="activity-time">
	                ${activity.startTime || ''} ${activity.endTime ? `- ${activity.endTime}` : ''}
	            </div>
	        </div>
	        <div style="margin-bottom: 10px;">
	            <div style="word-break: break-word;"><i class="fas fa-map-marker-alt"></i> ${activity.location}</div>
	            ${activity.address ? `<div class="activity-address" style="word-break: break-word; color: #666; font-size: 0.85rem;"><i class="fas fa-map-pin"></i> ${activity.address}</div>` : ''}
	        </div>
	        <div class="activity-details">
	            ${originalCost > 0 ? `
	                <div class="activity-cost">
	                    <i class="fas fa-money-bill-wave"></i> ${currency} ${Number(originalCost).toFixed(2)} (${Math.round(twdCost)} TWD)
	                </div>
	            ` : ''}
	            ${activity.notes ? `<div class="activity-notes" style="white-space: pre-wrap; margin-bottom: 5px;"><i class="fas fa-sticky-note"></i> ${activity.notes}</div>` : ''}
	            ${linksHtml} </div>
	        ${editControlsHtml}
	    `;

	    // 綁定事件
	    if (showControls) {
	        const editBtn = activityElement.querySelector('.edit-activity');
	        const deleteBtn = activityElement.querySelector('.delete-activity');
	        if (editBtn) editBtn.addEventListener('click', () => showEditActivityModal(activity.id));
	        if (deleteBtn) deleteBtn.addEventListener('click', () => deleteActivity(activity.id));
	    }

	    return activityElement;
	}


        // 創建交通方式元素
        function createTransportElement(transport) {
            const transportElement = document.createElement('div');
            transportElement.className = `transport-item ${transport.isMain ? 'transport-main' : 'transport-alternate'}`;
            transportElement.dataset.id = transport.id;
            transportElement.dataset.type = 'transport';
            
            const transportLabels = {
                taxi: '計程車',
                subway: '地鐵',
                bus: '公交',
                train: '高鐵',
                walking: '步行',
                flight: '飛機',
                ship: '輪船',
                coach: '巴士',
                selfdrive: '自駕',
                other: '其他'
            };
            
            const routeDescription = transport.fromLocation && transport.toLocation 
                ? `${transport.fromLocation} → ${transport.toLocation}`
                : `${transport.fromActivityName} → ${transport.toActivityName}`;
            
            // 計算換算後的台幣費用（只有主要交通方式才計算費用）
            let totalCostTWD = 0;
            let totalPersonalTWD = 0;
            
            if (transport.isMain && transport.options && transport.options.length > 0) {
                transport.options.forEach(option => {
                    if (option.isMain && option.cost > 0) {
                        const currency = option.currency || 'TWD';
                        const exchangeRate = state.exchangeRates[currency] || 1;
                        const originalCost = option.cost;
                        const twdCost = originalCost * exchangeRate;
                        const participants = option.participants || 1;
                        const personalTwdCost = twdCost / participants;
                        
                        totalCostTWD += twdCost;
                        totalPersonalTWD += personalTwdCost;
                    }
                });
            }
            
            // 顯示所有交通方式選項
            let optionsHtml = '';
            if (transport.options && transport.options.length > 0) {
                transport.options.forEach((option, index) => {
                    const transportTypeLabel = transportLabels[option.type] || option.type;
                    const isMainOption = option.isMain ? '✓ 主要' : '○ 次要';
                    
                    // 計算換算後的台幣費用
                    const originalCost = option.cost || 0;
                    const currency = option.currency || 'TWD';
                    const exchangeRate = state.exchangeRates[currency] || 1;
                    const twdCost = originalCost * exchangeRate;
                    const participants = option.participants || 1;
                    const personalTwdCost = twdCost / participants;
                    
                    optionsHtml += `
                        <div style="margin: 8px 0; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid ${option.isMain ? '#4caf50' : '#ff9800'};">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span><strong>${transportTypeLabel}</strong> <span style="color: ${option.isMain ? '#4caf50' : '#ff9800'};">(${isMainOption})</span></span>
                            </div>
                            ${originalCost > 0 ? `
                                <div style="font-size: 0.9rem;">
                                    <i class="fas fa-money-bill-wave"></i> 
                                    ${currency} ${originalCost.toFixed(2)} 
                                    <small>(${twdCost.toFixed(2)} TWD)</small>
                                    ${participants > 1 ? ` (每人 ${personalTwdCost.toFixed(2)} TWD)` : ''}
                                </div>
                            ` : ''}
                            ${option.link && option.linkName ? `
                                <div style="font-size: 0.9rem; margin-top: 5px;">
                                    <a href="${option.link}" target="_blank" style="word-break: break-all;"><i class="fas fa-link"></i> ${option.linkName}</a>
                                </div>
                            ` : ''}
                            ${option.notes ? `
                                <div style="font-size: 0.9rem; margin-top: 5px;">
                                    <i class="fas fa-sticky-note"></i> ${option.notes}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }
            
            // 建立編輯/刪除按鈕HTML（分享模式或檢視模式下隱藏）
            const editControlsHtml = (state.isSharedMode || state.isViewMode) ? '' : `
                <div style="margin-top: 10px; text-align: right;">
                    <button class="btn btn-small btn-secondary edit-transport edit-controls" data-id="${transport.id}">
                        <i class="fas fa-edit"></i> 編輯
                    </button>
                    <button class="btn btn-small btn-danger delete-transport edit-controls" data-id="${transport.id}">
                        <i class="fas fa-trash-alt"></i> 刪除
                    </button>
                </div>
            `;
            
            transportElement.innerHTML = `
                <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <div>
                        ${transport.isMain ? '<i class="fas fa-star" style="color: #4caf50;"></i> 主要' : '<i class="far fa-star" style="color: #ff9800;"></i> 備用'}
                    </div>
                </div>
                <div style="margin: 8px 0; word-break: break-word;">
                    <i class="fas fa-clock"></i> ${transport.startTime} - ${transport.endTime}
                </div>
                <div style="margin: 8px 0; word-break: break-word;">
                    <i class="fas fa-route"></i> ${routeDescription}
                </div>
                
                <div style="margin: 15px 0;">
                    ${optionsHtml}
                </div>
                
                ${totalCostTWD > 0 ? `
                    <div style="margin: 8px 0; padding: 10px; background: #e8f5e9; border-radius: 4px; word-break: break-word;">
                        <i class="fas fa-money-bill-wave"></i> 
                        <strong>總費用: ${totalCostTWD.toFixed(2)} TWD</strong>
                        <small> (每人 ${totalPersonalTWD.toFixed(2)} TWD)</small>
                    </div>
                ` : ''}
                
                ${editControlsHtml}
            `;
            
            if (!state.isSharedMode && !state.isViewMode) {
                const editBtn = transportElement.querySelector('.edit-transport');
                const deleteBtn = transportElement.querySelector('.delete-transport');
                
                if (editBtn) {
                    editBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        showEditTransportModal(transport.id);
                    });
                }
                
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        deleteTransport(transport.id);
                    });
                }
            }
            
            return transportElement;
        }

        // 拖放事件處理函數（僅在正常模式下使用）
        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', this.dataset.id);
            this.classList.add('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDrop(e) {
            e.preventDefault();
            const id = e.dataTransfer.getData('text/plain');
            const draggedElement = document.querySelector(`[data-id="${id}"]`);
            
            if (draggedElement && this !== draggedElement) {
                const container = this.parentNode;
                const afterElement = getDragAfterElement(container, e.clientY);
                
                if (afterElement == null) {
                    container.appendChild(draggedElement);
                } else {
                    container.insertBefore(draggedElement, afterElement);
                }
                
                updateActivitiesOrder();
            }
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.activity-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function updateActivitiesOrder() {
            const plan = state.plans.find(p => p.id === state.currentPlanId);
            if (!plan || !plan.activities) return;
            
            const day = state.currentDay;
            const activitiesContainer = document.querySelector(`.activities-container[data-day="${day}"]`);
            const activityElements = activitiesContainer.querySelectorAll('.activity-item');
            
            activityElements.forEach((element, index) => {
                const activityId = parseInt(element.dataset.id);
                const activity = plan.activities.find(a => a.id === activityId);
                if (activity) {
                    activity.order = index;
                }
            });
            
            plan.activities.sort((a, b) => {
                if (a.day !== b.day) return a.day - b.day;
                return (a.order || 0) - (b.order || 0);
            });
            
            savePlansToStorage();
        }

        // 新增活動連結欄位
        function addActivityLinkField(linkData = { name: '', url: '' }) {
            const container = document.getElementById('activityLinksContainer');
            const linkIndex = container.children.length;
            
            const linkItem = document.createElement('div');
            linkItem.className = 'link-item';
            linkItem.innerHTML = `
                <input type="text" class="link-name" placeholder="連結名稱" value="${linkData.name || ''}">
                <input type="url" class="link-url" placeholder="https://example.com" value="${linkData.url || ''}">
                <button type="button" class="remove-link-btn" data-index="${linkIndex}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(linkItem);
            
            // 為刪除按鈕添加事件監聽器
            linkItem.querySelector('.remove-link-btn').addEventListener('click', function() {
                this.parentElement.remove();
            });
        }

        // 新增交通方式選項欄位（更新交通類型選項）
        function addTransportOptionField(optionData = null) {
            const container = document.getElementById('transportOptionsContainer');
            const optionIndex = container.children.length;
            
            const optionItem = document.createElement('div');
            optionItem.className = 'transport-option';
            
            const optionId = optionData ? optionData.id || Date.now() + Math.random() : Date.now() + Math.random();
            
            optionItem.innerHTML = `
                <div class="transport-option-header">
                    <div class="transport-option-title">交通方式選項 #${optionIndex + 1}</div>
                    <div class="transport-option-actions">
                        <button type="button" class="btn btn-small btn-secondary set-main-option" data-id="${optionId}">
                            <i class="fas fa-star"></i> 設為主要
                        </button>
                        <button type="button" class="remove-link-btn remove-transport-option" data-id="${optionId}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="transportOptionType_${optionId}">交通類別</label>
                    <select id="transportOptionType_${optionId}" class="transport-option-type">
                        <option value="taxi" ${(optionData && optionData.type === 'taxi') ? 'selected' : ''}>計程車</option>
                        <option value="subway" ${(optionData && optionData.type === 'subway') ? 'selected' : ''}>地鐵</option>
                        <option value="bus" ${(optionData && optionData.type === 'bus') ? 'selected' : ''}>公交</option>
                        <option value="train" ${(optionData && optionData.type === 'train') ? 'selected' : ''}>高鐵</option>
                        <option value="walking" ${(optionData && optionData.type === 'walking') ? 'selected' : ''}>步行</option>
                        <option value="flight" ${(optionData && optionData.type === 'flight') ? 'selected' : ''}>飛機</option>
                        <option value="ship" ${(optionData && optionData.type === 'ship') ? 'selected' : ''}>輪船</option>
                        <option value="coach" ${(optionData && optionData.type === 'coach') ? 'selected' : ''}>巴士</option>
                        <option value="selfdrive" ${(optionData && optionData.type === 'selfdrive') ? 'selected' : ''}>自駕</option>
                        <option value="other" ${(optionData && optionData.type === 'other') ? 'selected' : ''}>其他</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="transportOptionCost_${optionId}">交通費用</label>
                        <input type="number" id="transportOptionCost_${optionId}" class="transport-option-cost" min="0" step="0.01" value="${optionData ? optionData.cost || 0 : 0}">
                    </div>
                    <div class="form-group">
                        <label for="transportOptionCurrency_${optionId}">幣別</label>
                        <select id="transportOptionCurrency_${optionId}" class="transport-option-currency">
                            <option value="TWD" ${(optionData && optionData.currency === 'TWD') ? 'selected' : ''}>新台幣 (TWD)</option>
                            <option value="USD" ${(optionData && optionData.currency === 'USD') ? 'selected' : ''}>美元 (USD)</option>
                            <option value="JPY" ${(optionData && optionData.currency === 'JPY') ? 'selected' : ''}>日圓 (JPY)</option>
                            <option value="EUR" ${(optionData && optionData.currency === 'EUR') ? 'selected' : ''}>歐元 (EUR)</option>
                            <option value="CNY" ${(optionData && optionData.currency === 'CNY') ? 'selected' : ''}>人民幣 (CNY)</option>
                            <option value="KRW" ${(optionData && optionData.currency === 'KRW') ? 'selected' : ''}>韓元 (KRW)</option>
                            <option value="HKD" ${(optionData && optionData.currency === 'HKD') ? 'selected' : ''}>港幣 (HKD)</option>
                            <option value="GBP" ${(optionData && optionData.currency === 'GBP') ? 'selected' : ''}>英鎊 (GBP)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transportOptionParticipants_${optionId}">分攤人數</label>
                        <input type="number" id="transportOptionParticipants_${optionId}" class="transport-option-participants" min="1" value="${optionData ? optionData.participants || 1 : 1}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="transportOptionLinkName_${optionId}">連結名稱</label>
                        <input type="text" id="transportOptionLinkName_${optionId}" class="transport-option-link-name" value="${optionData ? optionData.linkName || '' : ''}">
                    </div>
                    <div class="form-group">
                        <label for="transportOptionLink_${optionId}">連結</label>
                        <input type="url" id="transportOptionLink_${optionId}" class="transport-option-link" placeholder="https://example.com" value="${optionData ? optionData.link || '' : ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label for="transportOptionNotes_${optionId}">備註</label>
                    <textarea id="transportOptionNotes_${optionId}" class="transport-option-notes" rows="2">${optionData ? optionData.notes || '' : ''}</textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" class="transport-option-is-main" ${optionData && optionData.isMain ? 'checked' : ''}>
                        設為主要交通方式（只有主要方式才計算費用）
                    </label>
                </div>
            `;
            
            container.appendChild(optionItem);
            
            // 為設為主要按鈕添加事件監聽器
            optionItem.querySelector('.set-main-option').addEventListener('click', function() {
                // 取消所有其他選項的主要狀態
                document.querySelectorAll('.transport-option-is-main').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // 設置當前選項為主要
                const currentOption = this.closest('.transport-option');
                currentOption.querySelector('.transport-option-is-main').checked = true;
            });
            
            // 為刪除按鈕添加事件監聽器
            optionItem.querySelector('.remove-transport-option').addEventListener('click', function() {
                this.closest('.transport-option').remove();
            });
            
            return optionId;
        }

        // 顯示新增計劃模態框
        function showAddPlanModal() {
            document.getElementById('planModalTitle').textContent = '新增旅遊計劃';
            document.getElementById('planForm').reset();
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            document.getElementById('planStartDate').value = todayStr;
            document.getElementById('planModal').classList.add('active');
            
            delete document.getElementById('planForm').dataset.editingId;
            
            setTimeout(() => {
                document.getElementById('planName').focus();
            }, 100);
        }

        // 顯示編輯計劃模態框
        function showEditPlanModal(planId) {
            const plan = state.plans.find(p => p.id === planId);
            if (!plan) return;
            
            document.getElementById('planModalTitle').textContent = '編輯旅遊計劃';
            document.getElementById('planName').value = plan.name;
            document.getElementById('planStartDate').value = plan.startDate;
            document.getElementById('planDays').value = plan.days;
            document.getElementById('planModal').classList.add('active');
            
            document.getElementById('planForm').dataset.editingId = planId;
        }

        // 關閉計劃模態框
        function closePlanModal() {
            document.getElementById('planModal').classList.remove('active');
            document.getElementById('planForm').reset();
            delete document.getElementById('planForm').dataset.editingId;
        }

        // 儲存計劃
        function savePlan() {
            console.log('開始儲存計劃...');
            
            const planName = document.getElementById('planName').value;
            const startDate = document.getElementById('planStartDate').value;
            const days = parseInt(document.getElementById('planDays').value);
            
            if (!planName || !startDate || !days) {
                alert('請填寫所有必要欄位');
                return;
            }
            
            if (days < 1 || days > 365) {
                alert('旅遊天數必須在1到365天之間');
                return;
            }
            
            const editingId = document.getElementById('planForm').dataset.editingId;
            
            if (editingId) {
                const plan = state.plans.find(p => p.id === parseInt(editingId));
                if (plan) {
                    const originalDays = plan.days;
                    plan.name = planName;
                    plan.startDate = startDate;
                    plan.days = days;
                    
                    if (days < originalDays) {
                        plan.activities = plan.activities ? plan.activities.filter(a => a.day <= days) : [];
                        plan.transports = plan.transports ? plan.transports.filter(t => t.day <= days) : [];
                        if (plan.dayTitles) {
                            Object.keys(plan.dayTitles).forEach(day => {
                                if (parseInt(day) > days) delete plan.dayTitles[day];
                            });
                        }
                    }
                    console.log('計劃已更新:', plan);
                }
            } else {
                const newPlan = {
                    id: state.nextId++,
                    name: planName,
                    startDate: startDate,
                    days: days,
                    activities: [],
                    transports: [],
                    additionalCosts: [], // 新增：儲存額外費用
                    dayTitles: {}
                };
                
                state.plans.push(newPlan);
                state.currentPlanId = newPlan.id;
                console.log('新計劃已建立:', newPlan);
            }
            
            savePlansToStorage();
            updatePlansList();
            showPlanContent();
            closePlanModal();
        }

        // 顯示新增活動模態框
        function showAddActivityModal() {
            if (!state.currentPlanId) {
                alert('請先選擇一個旅遊計劃');
                return;
            }
            
            document.getElementById('activityModalTitle').textContent = '新增行程';
            document.getElementById('activityForm').reset();
            document.getElementById('activityCurrency').value = 'TWD';
            document.getElementById('activityParticipants').value = 1;
            
            // 重置連結區域
            document.getElementById('activityLinksContainer').innerHTML = '';
            addActivityLinkField(); // 添加一個初始連結欄位
            
            // 重置前一晚住宿選擇
            document.getElementById('previousAccommodationContainer').style.display = 'none';
            
            document.getElementById('activityModal').classList.add('active');
            
            delete document.getElementById('activityForm').dataset.editingId;
            
            setTimeout(() => {
                document.getElementById('activityStartTime').focus();
            }, 100);
        }

        // 顯示編輯活動模態框
        function showEditActivityModal(activityId) {
            const plan = state.plans.find(p => p.id === state.currentPlanId);
            if (!plan || !plan.activities) return;
            
            const activity = plan.activities.find(a => a.id === activityId);
            if (!activity) return;
            
            document.getElementById('activityModalTitle').textContent = '編輯行程';
            document.getElementById('activityStartTime').value = activity.startTime || '';
            document.getElementById('activityEndTime').value = activity.endTime || '';
            document.getElementById('activityName').value = activity.name;
            document.getElementById('activityCategory').value = activity.category;
            document.getElementById('activityLocation').value = activity.location;
            document.getElementById('activityAddress').value = activity.address || '';
            document.getElementById('activityCost').value = activity.cost || 0;
            document.getElementById('activityCurrency').value = activity.currency || 'TWD';
            document.getElementById('activityParticipants').value = activity.participants || 1;
            document.getElementById('activityNotes').value = activity.notes || '';
            
            // 載入連結
            document.getElementById('activityLinksContainer').innerHTML = '';
            if (activity.links && activity.links.length > 0) {
                activity.links.forEach(link => {
                    addActivityLinkField(link);
                });
            } else {
                addActivityLinkField(); // 添加一個初始連結欄位
            }
            
            // 如果是住宿類別且不是第一天，顯示前一晚住宿選擇
            if (activity.category === 'accommodation' && state.currentDay > 1) {
                loadPreviousAccommodations();
                document.getElementById('previousAccommodationContainer').style.display = 'block';
            } else {
                document.getElementById('previousAccommodationContainer').style.display = 'none';
            }
            
            document.getElementById('activityModal').classList.add('active');
            
            document.getElementById('activityForm').dataset.editingId = activityId;
        }

        // 關閉活動模態框
        function closeActivityModal() {
            document.getElementById('activityModal').classList.remove('active');
            document.getElementById('activityForm').reset();
            delete document.getElementById('activityForm').dataset.editingId;
            
            // 重置連結區域
            document.getElementById('activityLinksContainer').innerHTML = '';
        }

        // 儲存活動
        function saveActivity() {
            console.log('開始儲存活動...');
            
            if (!state.currentPlanId) {
                alert('請先選擇一個旅遊計劃');
                return;
            }
            
            const plan = state.plans.find(p => p.id === state.currentPlanId);
            if (!plan) {
                alert('找不到選擇的計劃');
                return;
            }
            
            formatTimeInput(document.getElementById('activityStartTime'));
            formatTimeInput(document.getElementById('activityEndTime'));
            
            const startTime = document.getElementById('activityStartTime').value;
            const endTime = document.getElementById('activityEndTime').value || null;
            const name = document.getElementById('activityName').value;
            const category = document.getElementById('activityCategory').value;
            const location = document.getElementById('activityLocation').value;
            const address = document.getElementById('activityAddress').value || null;
            const cost = parseFloat(document.getElementById('activityCost').value) || 0;
            const currency = document.getElementById('activityCurrency').value;
            const participants = parseInt(document.getElementById('activityParticipants').value) || 1;
            const notes = document.getElementById('activityNotes').value || null;
            
            if (!startTime || !name || !location) {
                alert('請填寫必要欄位：開始時間、行程名稱、地點');
                return;
            }
            
            // 收集所有連結
            const links = [];
            const linkItems = document.querySelectorAll('#activityLinksContainer .link-item');
            linkItems.forEach(item => {
                const linkName = item.querySelector('.link-name').value.trim();
                const linkUrl = item.querySelector('.link-url').value.trim();
                
                if (linkName && linkUrl) {
                    links.push({
                        name: linkName,
                        url: linkUrl
                    });
                }
            });
            
            const activityData = {
                startTime: startTime,
                endTime: endTime,
                name: name,
                category: category,
                location: location,
                address: address,
                cost: cost,
                currency: currency,
                participants: participants,
                links: links.length > 0 ? links : null,
                notes: notes,
                day: state.currentDay
            };
            
            console.log('活動數據:', activityData);
            
            const editingId = document.getElementById('activityForm').dataset.editingId;
            
            if (editingId) {
                const activityIndex = plan.activities.findIndex(a => a.id === parseInt(editingId));
                if (activityIndex !== -1) {
                    activityData.id = parseInt(editingId);
                    activityData.order = plan.activities[activityIndex].order;
                    plan.activities[activityIndex] = activityData;
                    console.log('編輯現有活動成功');
                }
            } else {
                activityData.id = Date.now();
                activityData.order = plan.activities.filter(a => a.day === state.currentDay).length;
                if (!plan.activities) plan.activities = [];
                plan.activities.push(activityData);
                console.log('新增活動成功，ID:', activityData.id);
            }
            
            savePlansToStorage();
            updateActivitiesContainer();
            updateCostSummary();
            closeActivityModal();
        }

        // 顯示新增交通方式模態框
        function showAddTransportModal() {
            if (!state.currentPlanId) {
                alert('請先選擇一個旅遊計劃');
                return;
            }
            
            const plan = state.plans.find(p => p.id === state.currentPlanId);
            if (!plan || !plan.activities) {
                alert('請先添加行程，然後才能添加交通方式');
                return;
            }
            
            const dayActivities = plan.activities.filter(a => a.day === state.currentDay);
            if (dayActivities.length < 2) {
                alert('需要至少兩個行程才能添加交通方式');
                return;
            }
            
            const fromSelect = document.getElementById('transportFromActivity');
            const toSelect = document.getElementById('transportToActivity');
            
            fromSelect.innerHTML = '';
            toSelect.innerHTML = '';
            
            dayActivities.forEach(activity => {
                const option1 = document.createElement('option');
                option1.value = activity.id;
                option1.textContent = `${activity.startTime || ''} ${activity.name} (${activity.location})`;
                fromSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = activity.id;
                option2.textContent = `${activity.startTime || ''} ${activity.name} (${activity.location})`;
                toSelect.appendChild(option2);
            });
            
            fromSelect.selectedIndex = 0;
            toSelect.selectedIndex = Math.min(1, dayActivities.length - 1);
            
            const fromActivity = dayActivities[fromSelect.selectedIndex];
            const toActivity = dayActivities[toSelect.selectedIndex];
            
            document.getElementById('transportStartTime').value = fromActivity.endTime || fromActivity.startTime || '';
            document.getElementById('transportEndTime').value = toActivity.startTime || '';
            
            document.getElementById('transportModalTitle').textContent = '新增交通方式';
            document.getElementById('transportForm').reset();
            
            // 重置交通方式選項區域
            document.getElementById('transportOptionsContainer').innerHTML = '';
            addTransportOptionField(); // 添加一個初始選項
            
            document.getElementById('transportModal').classList.add('active');
            
            delete document.getElementById('transportForm').dataset.editingId;
            
            fromSelect.addEventListener('change', updateTransportTimes);
            toSelect.addEventListener('change', updateTransportTimes);
            
            setTimeout(() => {
                document.getElementById('transportStartTime').focus();
            }, 100);
        }

        // 更新交通時間
        function updateTransportTimes() {
            const plan = state.plans.find(p => p.id === state.currentPlanId);
            if (!plan || !plan.activities) return;
            
            const dayActivities = plan.activities.filter(a => a.day === state.currentDay);
            const fromSelect = document.getElementById('transportFromActivity');
            const toSelect = document.getElementById('transportToActivity');
            
            const fromActivity = dayActivities.find(a => a.id === parseInt(fromSelect.value));
            const toActivity = dayActivities.find(a => a.id === parseInt(toSelect.value));
            
            if (fromActivity) {
                document.getElementById('transportStartTime').value = fromActivity.endTime || fromActivity.startTime || '';
            }
            
            if (toActivity) {
                document.getElementById('transportEndTime').value = toActivity.startTime || '';
            }
        }

        // 顯示編輯交通方式模態框
        function showEditTransportModal(transportId) {
            const plan = state.plans.find(p => p.id === state.currentPlanId);
            if (!plan || !plan.transports) return;
            
            const transport = plan.transports.find(t => t.id === transportId);
            if (!transport) return;
            
            const dayActivities = plan.activities.filter(a => a.day === state.currentDay);
            const fromSelect = document.getElementById('transportFromActivity');
            const toSelect = document.getElementById('transportToActivity');
            
            fromSelect.innerHTML = '';
            toSelect.innerHTML = '';
            
            dayActivities.forEach(activity => {
                const option1 = document.createElement('option');
                option1.value = activity.id;
                option1.textContent = `${activity.startTime || ''} ${activity.name} (${activity.location})`;
                option1.selected = activity.id === transport.fromActivityId;
                fromSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = activity.id;
                option2.textContent = `${activity.startTime || ''} ${activity.name} (${activity.location})`;
                option2.selected = activity.id === transport.toActivityId;
                toSelect.appendChild(option2);
            });
            
            document.getElementById('transportModalTitle').textContent = '編輯交通方式';
            document.getElementById('transportStartTime').value = transport.startTime;
            document.getElementById('transportEndTime').value = transport.endTime;
            
            // 載入交通方式選項
            document.getElementById('transportOptionsContainer').innerHTML = '';
            if (transport.options && transport.options.length > 0) {
                transport.options.forEach(option => {
                    addTransportOptionField(option);
                });
            } else {
                addTransportOptionField(); // 添加一個初始選項
            }
            
            document.getElementById('transportModal').classList.add('active');
            
            document.getElementById('transportForm').dataset.editingId = transportId;
            
            fromSelect.addEventListener('change', updateTransportTimes);
            toSelect.addEventListener('change', updateTransportTimes);
        }

        // 關閉交通方式模態框
        function closeTransportModal() {
            document.getElementById('transportModal').classList.remove('active');
            document.getElementById('transportForm').reset();
            delete document.getElementById('transportForm').dataset.editingId;
            
            // 重置交通方式選項區域
            document.getElementById('transportOptionsContainer').innerHTML = '';
            
            const fromSelect = document.getElementById('transportFromActivity');
            const toSelect = document.getElementById('transportToActivity');
            
            fromSelect.removeEventListener('change', updateTransportTimes);
            toSelect.removeEventListener('change', updateTransportTimes);
        }

        // 儲存交通方式
        function saveTransport() {
            console.log('開始儲存交通方式...');
            
            if (!state.currentPlanId) {
                alert('請先選擇一個旅遊計劃');
                return;
            }
            
            const plan = state.plans.find(p => p.id === state.currentPlanId);
            if (!plan) {
                alert('找不到選擇的計劃');
                return;
            }
            
            formatTimeInput(document.getElementById('transportStartTime'));
            formatTimeInput(document.getElementById('transportEndTime'));
            
            const startTime = document.getElementById('transportStartTime').value;
            const endTime = document.getElementById('transportEndTime').value;
            const fromActivityId = parseInt(document.getElementById('transportFromActivity').value);
            const toActivityId = parseInt(document.getElementById('transportToActivity').value);
            
            if (!startTime || !endTime || !fromActivityId || !toActivityId) {
                alert('請填寫所有必要欄位');
                return;
            }
            
            if (fromActivityId === toActivityId) {
                alert('起始行程和結束行程不能相同');
                return;
            }
            
            const fromActivity = plan.activities.find(a => a.id === fromActivityId);
            const toActivity = plan.activities.find(a => a.id === toActivityId);
            
            if (!fromActivity || !toActivity) {
                alert('無法找到選擇的行程，請重新選擇');
                return;
            }
            
            // 收集所有交通方式選項
            const options = [];
            const optionElements = document.querySelectorAll('.transport-option');
            let hasMainOption = false;
            
            optionElements.forEach(optionElement => {
                const type = optionElement.querySelector('.transport-option-type').value;
                const cost = parseFloat(optionElement.querySelector('.transport-option-cost').value) || 0;
                const currency = optionElement.querySelector('.transport-option-currency').value;
                const participants = parseInt(optionElement.querySelector('.transport-option-participants').value) || 1;
                const linkName = optionElement.querySelector('.transport-option-link-name').value.trim() || null;
                const link = optionElement.querySelector('.transport-option-link').value.trim() || null;
                const notes = optionElement.querySelector('.transport-option-notes').value.trim() || null;
                const isMain = optionElement.querySelector('.transport-option-is-main').checked;
                
                // 檢查是否已經有主要選項
                if (isMain && hasMainOption) {
                    alert('只能有一個主要交通方式！');
                    return;
                }
                
                if (isMain) {
                    hasMainOption = true;
                }
                
                options.push({
                    id: Date.now() + Math.random(),
                    type: type,
                    cost: cost,
                    currency: currency,
                    participants: participants,
                    linkName: linkName,
                    link: link,
                    notes: notes,
                    isMain: isMain
                });
            });
            
            if (options.length === 0) {
                alert('請至少添加一個交通方式選項');
                return;
            }
            
            const transportData = {
                startTime: startTime,
                endTime: endTime,
                fromActivityId: fromActivityId,
                toActivityId: toActivityId,
                fromActivityName: fromActivity.name,
                toActivityName: toActivity.name,
                fromLocation: fromActivity.location,
                toLocation: toActivity.location,
                options: options,
                isMain: hasMainOption, // 只要有任何主要選項，整個交通方式就是主要的
                day: state.currentDay
            };
            
            console.log('交通數據:', transportData);
            
            const editingId = document.getElementById('transportForm').dataset.editingId;
            
            if (editingId) {
                const transportIndex = plan.transports.findIndex(t => t.id === parseInt(editingId));
                if (transportIndex !== -1) {
                    transportData.id = parseInt(editingId);
                    plan.transports[transportIndex] = transportData;
                    console.log('編輯交通方式成功');
                }
            } else {
                transportData.id = Date.now();
                if (!plan.transports) plan.transports = [];
                plan.transports.push(transportData);
                console.log('新增交通方式成功，ID:', transportData.id);
            }
            
            savePlansToStorage();
            updateActivitiesContainer();
            updateCostSummary();
            closeTransportModal();
        }

        // 顯示新增費用模態框
        function showAddCostModal() {
            if (!state.currentPlanId) {
                alert('請先選擇一個旅遊計劃');
                return;
            }
            
            document.getElementById('costModalTitle').textContent = '新增費用';
            document.getElementById('costForm').reset();
            
            const plan = state.plans.find(p => p.id === state.currentPlanId);
            if (plan) {
                const startDate = new Date(plan.startDate);
                const dateStr = startDate.toISOString().split('T')[0];
                document.getElementById('costDate').value = dateStr;
            }
            
            document.getElementById('costAmount').value = 0;
            document.getElementById('costCurrency').value = 'TWD';
            document.getElementById('costParticipants').value = 1;
            
            document.getElementById('costModal').classList.add('active');
            
            delete document.getElementById('costForm').dataset.editingId;
            
            setTimeout(() => {
                document.getElementById('costDescription').focus();
            }, 100);
        }

        // 顯示編輯費用模態框
        function showEditCostModal(costId) {
            const plan = state.plans.find(p => p.id === state.currentPlanId);
            if (!plan || !plan.additionalCosts) return;
            
            const cost = plan.additionalCosts.find(c => c.id === costId);
            if (!cost) return;
            
            document.getElementById('costModalTitle').textContent = '編輯費用';
            document.getElementById('costDate').value = cost.date;
            document.getElementById('costCategory').value = cost.category;
            document.getElementById('costDescription').value = cost.description;
            document.getElementById('costAmount').value = cost.amount || 0;
            document.getElementById('costCurrency').value = cost.currency || 'TWD';
            document.getElementById('costParticipants').value = cost.participants || 1;
            document.getElementById('costNotes').value = cost.notes || '';
            
            document.getElementById('costModal').classList.add('active');
            
            document.getElementById('costForm').dataset.editingId = costId;
        }

        // 關閉費用模態框
        function closeCostModal() {
            document.getElementById('costModal').classList.remove('active');
            document.getElementById('costForm').reset();
            delete document.getElementById('costForm').dataset.editingId;
        }

        // 儲存費用
        function saveCost() {
            console.log('開始儲存費用...');
            
            if (!state.currentPlanId) {
                alert('請先選擇一個旅遊計劃');
                return;
            }
            
            const plan = state.plans.find(p => p.id === state.currentPlanId);
            if (!plan) {
                alert('找不到選擇的計劃');
                return;
            }
            
            const date = document.getElementById('costDate').value;
            const category = document.getElementById('costCategory').value;
            const description = document.getElementById('costDescription').value;
            const amount = parseFloat(document.getElementById('costAmount').value) || 0;
            const currency = document.getElementById('costCurrency').value;
            const participants = parseInt(document.getElementById('costParticipants').value) || 1;
            const notes = document.getElementById('costNotes').value || null;
            
            if (!date || !category || !description) {
                alert('請填寫必要欄位：日期、類別、費用說明');
                return;
            }
            
            const costData = {
                date: date,
                category: category,
                description: description,
                amount: amount,
                currency: currency,
                participants: participants,
                notes: notes
            };
            
            console.log('費用數據:', costData);
            
            const editingId = document.getElementById('costForm').dataset.editingId;
            
            if (editingId) {
                const costIndex = plan.additionalCosts.findIndex(c => c.id === editingId);
                if (costIndex !== -1) {
                    costData.id = editingId;
                    plan.additionalCosts[costIndex] = costData;
                    console.log('編輯費用成功');
                }
            } else {
                costData.id = Date.now().toString();
                if (!plan.additionalCosts) plan.additionalCosts = [];
                plan.additionalCosts.push(costData);
                console.log('新增費用成功，ID:', costData.id);
            }
            
            savePlansToStorage();
            updateCostSummary();
            closeCostModal();
        }

        // 刪除活動
        function deleteActivity(activityId) {
            if (!confirm('確定要刪除這個行程嗎？')) return;
            
            const plan = state.plans.find(p => p.id === state.currentPlanId);
            if (!plan || !plan.activities) return;
            
            plan.activities = plan.activities.filter(a => a.id !== activityId);
            
            if (plan.transports) {
                plan.transports = plan.transports.filter(t => 
                    t.fromActivityId !== activityId && t.toActivityId !== activityId
                );
            }
            
            savePlansToStorage();
            updateActivitiesContainer();
            updateCostSummary();
        }

        // 刪除交通方式
        function deleteTransport(transportId) {
            if (!confirm('確定要刪除這個交通方式嗎？')) return;
            
            const plan = state.plans.find(p => p.id === state.currentPlanId);
            if (!plan || !plan.transports) return;
            
            plan.transports = plan.transports.filter(t => t.id !== transportId);
            
            savePlansToStorage();
            updateActivitiesContainer();
            updateCostSummary();
        }

        // 刪除費用
        function deleteCost(costId) {
            if (!confirm('確定要刪除這個費用嗎？')) return;
            
            const plan = state.plans.find(p => p.id === state.currentPlanId);
            if (!plan || !plan.additionalCosts) return;
            
            plan.additionalCosts = plan.additionalCosts.filter(c => c.id !== costId);
            
            savePlansToStorage();
            updateCostSummary();
        }

        // 儲存每日標題
        function saveDayTitle(planId, day, title) {
            const plan = state.plans.find(p => p.id === planId);
            if (!plan) return;
            
            if (!plan.dayTitles) plan.dayTitles = {};
            plan.dayTitles[day] = title;
            
            savePlansToStorage();
        }

        // 刪除計劃
        function deletePlan() {
            if (!state.currentPlanId) return;
            
            if (!confirm('確定要刪除這個旅遊計劃嗎？此操作無法復原。')) return;
            
            state.plans = state.plans.filter(p => p.id !== state.currentPlanId);
            
            if (state.plans.length > 0) {
                state.currentPlanId = state.plans[0].id;
            } else {
                state.currentPlanId = null;
            }
            
            savePlansToStorage();
            updatePlansList();
            updateCostSummary();
            
            if (state.currentPlanId) {
                showPlanContent();
            } else {
                document.getElementById('noPlanSelected').style.display = 'block';
                document.getElementById('planContent').style.display = 'none';
            }
        }

        // 顯示匯率設定模態框
        function showExchangeRateModal() {
            document.getElementById('exchangeRateModal').classList.add('active');
            
            // 填入當前匯率
            document.getElementById('usdRate').value = state.exchangeRates.USD;
            document.getElementById('jpyRate').value = state.exchangeRates.JPY;
            document.getElementById('eurRate').value = state.exchangeRates.EUR;
            document.getElementById('cnyRate').value = state.exchangeRates.CNY;
            document.getElementById('krwRate').value = state.exchangeRates.KRW;
            document.getElementById('hkdRate').value = state.exchangeRates.HKD;
            document.getElementById('gbpRate').value = state.exchangeRates.GBP;
        }

        // 關閉匯率設定模態框
        function closeExchangeRateModal() {
            document.getElementById('exchangeRateModal').classList.remove('active');
        }

		// 自動取得最新匯率
		async function fetchLiveExchangeRates() {
			const btn = document.getElementById('autoFetchRateBtn');
			const originalText = btn.innerHTML;
			
			// 設定按鈕為載入中狀態
			btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在連線取得數據...';
			btn.disabled = true;

			try {
				// 使用免費公開的匯率 API，以 TWD 為基準
				const response = await fetch('https://api.exchangerate-api.com/v4/latest/TWD');
				
				if (!response.ok) {
					throw new Error('網路連線失敗');
				}

				const data = await response.json();
				const rates = data.rates; // 這裡取得的是 1 TWD = x 外幣

				// 定義欄位 ID 與貨幣代碼的對應
				const currencyMap = {
					'usdRate': 'USD',
					'jpyRate': 'JPY',
					'eurRate': 'EUR',
					'cnyRate': 'CNY',
					'krwRate': 'KRW',
					'hkdRate': 'HKD',
					'gbpRate': 'GBP'
				};

				// 更新介面上的輸入框
				let updateCount = 0;
				for (const [inputId, currencyCode] of Object.entries(currencyMap)) {
					if (rates[currencyCode]) {
						// API 給的是 1 TWD = 4.5 JPY
						// 應用程式需要的是 1 JPY = ? TWD (所以要用 1 / API匯率)
						const rateToTwd = 1 / rates[currencyCode];
						
						// 根據幣值大小決定小數點位數 (日幣/韓元顯示較多位，美元等顯示2位)
						const precision = (currencyCode === 'JPY' || currencyCode === 'KRW') ? 4 : 2;
						
						document.getElementById(inputId).value = rateToTwd.toFixed(precision);
						updateCount++;
					}
				}

				alert(`成功更新匯率！\n資料日期：${data.date}\n請記得點擊「儲存匯率」按鈕以套用設定。`);

			} catch (error) {
				console.error('匯率取得失敗:', error);
				alert('無法取得最新匯率，請檢查網路連線或稍後再試。\n錯誤訊息: ' + error.message);
			} finally {
				// 恢復按鈕狀態
				btn.innerHTML = originalText;
				btn.disabled = false;
			}
		}

        // 儲存匯率設定
        function saveExchangeRates() {
            state.exchangeRates.USD = parseFloat(document.getElementById('usdRate').value) || 30.5;
            state.exchangeRates.JPY = parseFloat(document.getElementById('jpyRate').value) || 0.22;
            state.exchangeRates.EUR = parseFloat(document.getElementById('eurRate').value) || 33.5;
            state.exchangeRates.CNY = parseFloat(document.getElementById('cnyRate').value) || 4.3;
            state.exchangeRates.KRW = parseFloat(document.getElementById('krwRate').value) || 0.023;
            state.exchangeRates.HKD = parseFloat(document.getElementById('hkdRate').value) || 3.9;
            state.exchangeRates.GBP = parseFloat(document.getElementById('gbpRate').value) || 38.5;
            
            saveExchangeRatesToStorage();
            updateCostSummary();
            updateActivitiesContainer(); // 更新活動顯示以反映新的匯率
            
            alert('匯率設定已更新！');
            closeExchangeRateModal();
        }

        // 將外幣換算為台幣
        function convertToTWD(amount, currency) {
            const exchangeRate = state.exchangeRates[currency] || 1;
            return amount * exchangeRate;
        }

        // 備份計劃（本地）
	// 備份計劃（本地）- 修改版：支援自行選取儲存位置
        async function backupPlan() {
            if (!state.currentPlanId) {
                alert('請先選擇一個旅遊計劃');
                return;
            }
            
            const plan = state.plans.find(p => p.id === state.currentPlanId);
            if (!plan) return;
            
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `旅遊計劃_${plan.name}_${dateStr}.json`;
            
            const dataStr = JSON.stringify(plan, null, 2);

            // 檢查瀏覽器是否支援 showSaveFilePicker (選取視窗功能)
            if ('showSaveFilePicker' in window) {
                try {
                    // 彈出視窗讓使用者選擇資料夾與輸入檔名
                    const handle = await window.showSaveFilePicker({
                        suggestedName: filename,
                        types: [{
                            description: 'JSON Files',
                            accept: {'application/json': ['.json']},
                        }],
                    });

                    // 執行寫入檔案
                    const writable = await handle.createWritable();
                    await writable.write(dataStr);
                    await writable.close();
                    
                    alert('備份成功！檔案已儲存。');
                } catch (err) {
                    // 如果使用者點擊取消，則不報錯
                    if (err.name !== 'AbortError') {
                        console.error('儲存失敗:', err);
                        alert('儲存失敗：' + err.message);
                    }
                }
            } else {
                // 如果瀏覽器不支援新 API (如舊版 Safari 或手機)，則跳回原本的下載方式
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                alert('您的瀏覽器不支援選取資料夾功能，已自動下載至預設位置。');
            }
        }



        // 還原計劃（本地）
        function restorePlan() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const planData = JSON.parse(event.target.result);
                        
                        if (!planData.name || !planData.startDate || !planData.days) {
                            alert('檔案格式不正確，無法還原計劃');
                            return;
                        }
                        
                        planData.id = state.nextId++;
                        
                        if (planData.activities) {
                            planData.activities.forEach(activity => {
                                if (!activity.id) activity.id = Date.now() + Math.random();
                            });
                        }
                        
                        if (planData.transports) {
                            planData.transports.forEach(transport => {
                                if (!transport.id) transport.id = Date.now() + Math.random();
                            });
                        }
                        
                        state.plans.push(planData);
                        state.currentPlanId = planData.id;
                        
                        savePlansToStorage();
                        updatePlansList();
                        showPlanContent();
                        
                        alert('計劃已成功還原！');
                    } catch (error) {
                        alert('讀取檔案時發生錯誤：' + error.message);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        // 更新費用統計（包含所有費用）
		// 更新費用統計（包含分組與小計功能）
		function updateCostSummary() {
			const costTableBody = document.getElementById('costTableBody');
			if (!costTableBody) return;
			
			costTableBody.innerHTML = '';
			
			if (!state.currentPlanId) {
				costTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">請選擇一個旅遊計劃</td></tr>';
				return;
			}
			
			const plan = state.plans.find(p => p.id === state.currentPlanId);
			if (!plan) {
				costTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">找不到計劃資料</td></tr>';
				return;
			}
			
			let allCosts = getAllCosts(plan);
			
			if (allCosts.length === 0) {
				costTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">暫無費用資料</td></tr>';
				return;
			}
			
			// 定義類別中文名稱映射
			const categoryLabels = {
				attraction: '景點', transport: '交通', activity: '活動',
				accommodation: '住宿', shopping: '購物', other: '其他',
				food: '飲食', insurance: '保險', internet: '網路'
			};

			// --- 分組邏輯開始 ---
			const groups = {};
			const sortMode = state.costSortMode || 'date'; // 預設依日期

			allCosts.forEach(cost => {
				let groupKey;
				let groupDisplayName;

				if (sortMode === 'date') {
					// 依日期分組
					groupKey = cost.date; 
					groupDisplayName = formatDate(new Date(cost.date));
				} else {
					// 依類別分組
					// 如果是交通方式 (type === 'transport')，groupKey 使用其細項代碼 (如 taxi, subway)
					groupKey = cost.category;
					
					// 定義交通工具的中文對照表
					const transportLabels = {
						'taxi': '交通：計程車', 'subway': '交通：地鐵', 'bus': '交通：巴士',
						'train': '交通：火車', 'walking': '交通：步行', 'flight': '交通：飛機',
						'ship': '交通：船隻', 'coach': '交通：長途客車', 'selfdrive': '交通：自駕'
					};

					// 優先從交通對照表找名稱，找不到再從一般類別找
					groupDisplayName = transportLabels[cost.category] || categoryLabels[cost.category] || cost.category;
				}

				if (!groups[groupKey]) {
					groups[groupKey] = {
						title: groupDisplayName,
						items: [],
						totalTWD: 0
					};
				}
				groups[groupKey].items.push(cost);
			});

			// --- 排序群組 ---
			let sortedKeys = Object.keys(groups);
			if (sortMode === 'date') {
				sortedKeys.sort((a, b) => new Date(a) - new Date(b));
			} else {
				// 類別依照筆畫或字母排序
				sortedKeys.sort((a, b) => groups[a].title.localeCompare(groups[b].title, 'zh-TW'));
			}

			// --- 渲染列表 ---
			sortedKeys.forEach(key => {
				const group = groups[key];
				
				// 該群組內的項目排序 (若依類別分組，內部依日期排；若依日期分組，內部預設不變或可依金額排)
				group.items.sort((a, b) => new Date(a.date) - new Date(b.date));

				// 計算該群組小計
				group.items.forEach(cost => {
					const currency = cost.currency || 'TWD';
					const exchangeRate = state.exchangeRates[currency] || 1;
					group.totalTWD += (cost.amount * exchangeRate);
				});

				// 1. 插入分組標題列 (佔據整行)
				const headerRow = document.createElement('tr');
				headerRow.innerHTML = `
					<td colspan="9" style="padding: 0; border: none;">
						<div class="cost-group-header">
							<span class="group-title">
								<i class="fas ${sortMode === 'date' ? 'fa-calendar-day' : 'fa-tag'}"></i> 
								${group.title}
							</span>
							<span class="group-subtotal">
								小計: ${group.totalTWD.toFixed(2)} TWD
							</span>
						</div>
					</td>
				`;
				costTableBody.appendChild(headerRow);

				// 2. 插入該群組的費用項目
				group.items.forEach(cost => {
					const row = document.createElement('tr');
					
					// 計算顯示數值
					const originalCost = cost.amount || 0;
					const currency = cost.currency || 'TWD';
					const exchangeRate = state.exchangeRates[currency] || 1;
					const twdCost = originalCost * exchangeRate;
					const participants = cost.participants || 1;
					const personalTwdCost = twdCost / participants;
					
					// 決定顯示文字
					const transportLabels = {
						'taxi': '計程車', 'subway': '地鐵', 'bus': '巴士',
						'train': '火車', 'walking': '步行', 'flight': '飛機',
						'ship': '船隻', 'coach': '長途客車', 'selfdrive': '自駕'
					};

					let categoryText = categoryLabels[cost.category] || cost.category;
					let descriptionText = '';
					
					if (cost.type === 'activity') {
						descriptionText = cost.name;
					} else if (cost.type === 'transport') {
						// 修改這裡：如果是交通，顯示具體的交通工具名稱
						categoryText = transportLabels[cost.category] || '交通';
						descriptionText = `${cost.fromActivityName} → ${cost.toActivityName}`;
					} else if (cost.type === 'additional') {
						descriptionText = cost.description;
					}
					
					else if (cost.type === 'additional') descriptionText = cost.description;
					
					// 操作按鈕 HTML
					let actionHtml = '';
					if (!state.isSharedMode && !state.isViewMode) {
						// 只有額外費用可以編輯/刪除 (行程與交通費用需在行程頁籤編輯)
						if (cost.type === 'additional') {
							actionHtml = `
								<button class="btn btn-small btn-secondary edit-cost" data-id="${cost.id}"><i class="fas fa-edit"></i></button>
								<button class="btn btn-small btn-danger delete-cost" data-id="${cost.id}"><i class="fas fa-trash-alt"></i></button>
							`;
						} else {
							actionHtml = `<span style="color:#999; font-size:0.8rem;">(由行程管理)</span>`;
						}
					}

					row.innerHTML = `
						<td>${formatDate(new Date(cost.date))}</td>
						<td>${categoryText}</td>
						<td>${descriptionText}</td>
						<td>${currency}</td>
						<td>${originalCost.toFixed(2)}</td>
						<td>${twdCost.toFixed(2)}</td>
						<td>${participants}</td>
						<td class="total-cost">${personalTwdCost.toFixed(2)}</td>
						${(!state.isSharedMode && !state.isViewMode) ? `<td>${actionHtml}</td>` : ''}
					`;
					
					// 綁定按鈕事件 (僅針對額外費用)
					if (cost.type === 'additional' && actionHtml) {
						const editBtn = row.querySelector('.edit-cost');
						const deleteBtn = row.querySelector('.delete-cost');
						if (editBtn) editBtn.addEventListener('click', (e) => { e.stopPropagation(); showEditCostModal(cost.id); });
						if (deleteBtn) deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteCost(cost.id); });
					}
					
					costTableBody.appendChild(row);
				});
			});
			
			// --- 總計行 ---
			const totalRow = document.createElement('tr');
			totalRow.className = 'cost-total-row';
			const totals = calculateTotalCosts(plan);
			
			// 依據是否有操作欄位調整 colspan
			const colSpanFirst = 5;
			
			totalRow.innerHTML = `
				<td colspan="${colSpanFirst}"><strong>總計 (新台幣)</strong></td>
				<td><strong>${totals.totalTWD.toFixed(2)}</strong></td>
				<td></td>
				<td class="total-cost"><strong>${totals.totalPersonalTWD.toFixed(2)}</strong></td>
				${(!state.isSharedMode && !state.isViewMode) ? '<td></td>' : ''}
			`;
			
			costTableBody.appendChild(totalRow);
		}
		

        // 取得所有費用（行程、交通、額外費用）
        function getAllCosts(plan) {
            const allCosts = [];
            
            // 行程費用
            if (plan.activities) {
                plan.activities.forEach(activity => {
                    if (activity.cost > 0) {
                        const activityDate = new Date(plan.startDate);
                        activityDate.setDate(activityDate.getDate() + activity.day - 1);
                        
                        allCosts.push({
                            type: 'activity',
                            date: activityDate.toISOString().split('T')[0],
                            category: activity.category,
                            name: activity.name,
                            amount: activity.cost,
                            currency: activity.currency || 'TWD',
                            participants: activity.participants || 1
                        });
                    }
                });
            }
            
            // 交通費用（只有主要交通方式才計算費用）
            if (plan.transports) {
                plan.transports.forEach(transport => {
                    if (transport.isMain && transport.options && transport.options.length > 0) {
                        transport.options.forEach(option => {
                            if (option.isMain && option.cost > 0) {
                                const transportDate = new Date(plan.startDate);
                                transportDate.setDate(transportDate.getDate() + transport.day - 1);
                                
                                allCosts.push({
                                    type: 'transport',
                                    date: transportDate.toISOString().split('T')[0],
                                    category: option.type,
                                    fromActivityName: transport.fromActivityName,
                                    toActivityName: transport.toActivityName,
                                    amount: option.cost,
                                    currency: option.currency || 'TWD',
                                    participants: option.participants || 1
                                });
                            }
                        });
                    }
                });
            }
            
            // 額外費用
            if (plan.additionalCosts) {
                plan.additionalCosts.forEach(cost => {
                    allCosts.push({
                        type: 'additional',
                        id: cost.id,
                        date: cost.date,
                        category: cost.category,
                        description: cost.description,
                        amount: cost.amount,
                        currency: cost.currency || 'TWD',
                        participants: cost.participants || 1
                    });
                });
            }
            
            return allCosts;
        }

        // 計算總費用
        function calculateTotalCosts(plan) {
            let totalTWD = 0;
            let totalPersonalTWD = 0;
            
            // 行程費用
            if (plan.activities) {
                plan.activities.forEach(activity => {
                    if (activity.cost > 0) {
                        const currency = activity.currency || 'TWD';
                        const exchangeRate = state.exchangeRates[currency] || 1;
                        const twdCost = activity.cost * exchangeRate;
                        const participants = activity.participants || 1;
                        const personalTwdCost = twdCost / participants;
                        
                        totalTWD += twdCost;
                        totalPersonalTWD += personalTwdCost;
                    }
                });
            }
            
            // 交通費用（只有主要交通方式才計算費用）
            if (plan.transports) {
                plan.transports.forEach(transport => {
                    if (transport.isMain && transport.options && transport.options.length > 0) {
                        transport.options.forEach(option => {
                            if (option.isMain && option.cost > 0) {
                                const currency = option.currency || 'TWD';
                                const exchangeRate = state.exchangeRates[currency] || 1;
                                const twdCost = option.cost * exchangeRate;
                                const participants = option.participants || 1;
                                const personalTwdCost = twdCost / participants;
                                
                                totalTWD += twdCost;
                                totalPersonalTWD += personalTwdCost;
                            }
                        });
                    }
                });
            }
            
            // 額外費用
            if (plan.additionalCosts) {
                plan.additionalCosts.forEach(cost => {
                    const currency = cost.currency || 'TWD';
                    const exchangeRate = state.exchangeRates[currency] || 1;
                    const twdCost = cost.amount * exchangeRate;
                    const participants = cost.participants || 1;
                    const personalTwdCost = twdCost / participants;
                    
                    totalTWD += twdCost;
                    totalPersonalTWD += personalTwdCost;
                });
            }
            
            return {
                totalTWD: totalTWD,
                totalPersonalTWD: totalPersonalTWD
            };
        }

        // 分享計劃（HTML匯出）
        function sharePlan() {
            if (!state.currentPlanId) {
                alert('請先選擇一個旅遊計劃');
                return;
            }
            
            const plan = state.plans.find(p => p.id === state.currentPlanId);
            if (!plan) return;
            
            let html = `
            <!DOCTYPE html>
            <html lang="zh-TW">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${plan.name} - 旅遊計劃</title>
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                <style>
                    * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    }
                    
                    body {
                        background-color: #f8f9fa;
                        color: #333;
                        line-height: 1.6;
                        min-height: 100vh;
                        overflow-x: hidden;
                        width: 100%;
                        max-width: 100vw;
                    }
                    
                    .container {
                        max-width: 1200px;
                        margin: 0 auto;
                        padding: 20px;
                        width: 100%;
                        overflow-x: hidden;
                    }
                    
                    header {
                        background: linear-gradient(135deg, #4a6fa5, #6b8cbc);
                        color: white;
                        padding: 30px 20px;
                        border-radius: 10px;
                        margin-bottom: 30px;
                        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
                    }
                    
                    h1 {
                        font-size: clamp(1.8rem, 4vw, 2.5rem);
                        margin-bottom: 10px;
                        word-break: break-word;
                    }
                    
                    .header-info {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 20px;
                        margin-top: 20px;
                        background: rgba(255,255,255,0.1);
                        padding: 20px;
                        border-radius: 8px;
                        backdrop-filter: blur(10px);
                    }
                    
                    .info-item {
                        font-size: clamp(0.9rem, 2vw, 1rem);
                        word-break: break-word;
                    }
                    
                    .info-item strong {
                        display: block;
                        margin-bottom: 5px;
                        font-size: 0.9em;
                        opacity: 0.9;
                    }
                    
                    /* 天數導航 */
                    .days-nav-container {
                        width: 100%;
                        max-width: 100%;
                        overflow-x: auto;
                        margin-bottom: 30px;
                        padding-bottom: 10px;
                        -webkit-overflow-scrolling: touch;
                        scrollbar-width: thin;
                    }
                    
                    .days-nav {
                        display: flex;
                        min-width: min-content;
                        width: max-content;
                    }
                    
                    .days-nav-container::-webkit-scrollbar {
                        height: 6px;
                    }
                    
                    .days-nav-container::-webkit-scrollbar-track {
                        background: #f1f1f1;
                        border-radius: 3px;
                    }
                    
                    .days-nav-container::-webkit-scrollbar-thumb {
                        background: #4a6fa5;
                        border-radius: 3px;
                    }
                    
                    .day-nav-btn {
                        padding: 12px 20px;
                        background: white;
                        border: 2px solid #4a6fa5;
                        border-radius: 8px;
                        cursor: pointer;
                        white-space: nowrap;
                        transition: all 0.3s;
                        font-size: clamp(0.8rem, 1.5vw, 0.9rem);
                        min-width: 120px;
                        text-align: center;
                        font-weight: 600;
                        color: #4a6fa5;
                        margin-right: 10px;
                    }
                    
                    .day-nav-btn:hover,
                    .day-nav-btn.active {
                        background: #4a6fa5;
                        color: white;
                    }
                    
                    /* 天數內容 */
                    .day-content {
                        display: none;
                        background: white;
                        border-radius: 10px;
                        padding: 25px;
                        margin-bottom: 30px;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
                        width: 100%;
                        max-width: 100%;
                        overflow-x: hidden;
                        position: relative;
                    }
                    
                    .day-content.active {
                        display: block;
                    }
                    
                    .day-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 25px;
                        padding-bottom: 15px;
                        border-bottom: 2px solid #f0f0f0;
                        flex-wrap: wrap;
                        gap: 15px;
                    }
                    
                    .day-title {
                        color: #4a6fa5;
                        font-size: clamp(1.3rem, 3vw, 1.8rem);
                        font-weight: bold;
                        word-break: break-word;
                    }
                    
                    .day-date {
                        color: #666;
                        font-size: clamp(0.9rem, 2vw, 1rem);
                        background: #f8f9fa;
                        padding: 8px 15px;
                        border-radius: 20px;
                        white-space: nowrap;
                    }
                    
                    /* 活動項目 */
                    .activities-container {
                        display: flex;
                        flex-direction: column;
                        gap: 20px;
                        width: 100%;
                        max-width: 100%;
                    }
                    
                    .activity-item {
                        background: #f9f9f9;
                        border-left: 4px solid #4a6fa5;
                        border-radius: 8px;
                        padding: 20px;
                        transition: all 0.3s;
                        position: relative;
                        width: 100%;
                        max-width: 100%;
                        overflow: hidden;
                    }
                    
                    .activity-item:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                    }
                    
                    .activity-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        margin-bottom: 15px;
                        flex-wrap: wrap;
                        gap: 10px;
                        width: 100%;
                    }
                    
                    .activity-name {
                        font-weight: bold;
                        font-size: clamp(1rem, 2vw, 1.2rem);
                        color: #4a6fa5;
                        word-break: break-word;
                        max-width: 100%;
                    }
                    
                    .activity-category {
                        display: inline-block;
                        padding: 4px 12px;
                        border-radius: 20px;
                        font-size: 0.75rem;
                        font-weight: bold;
                        margin-left: 10px;
                        white-space: nowrap;
                        flex-shrink: 0;
                    }
                    
                    .activity-category.attraction {
                        background-color: #e3f2fd;
                        color: #1565c0;
                    }
                    
                    .activity-category.transport {
                        background-color: #f3e5f5;
                        color: #7b1fa2;
                    }
                    
                    .activity-category.activity {
                        background-color: #e8f5e9;
                        color: #2e7d32;
                    }
                    
                    .activity-category.accommodation {
                        background-color: #fff3e0;
                        color: #ef6c00;
                    }
                    
                    .activity-category.shopping {
                        background-color: #fff0f5;
                        color: #c2185b;
                    }
                    
                    .activity-category.other {
                        background-color: #f5f5f5;
                        color: #616161;
                    }
                    
                    .activity-time {
                        color: #666;
                        font-size: 0.9rem;
                        white-space: nowrap;
                        background: white;
                        padding: 5px 10px;
                        border-radius: 15px;
                        border: 1px solid #e0e0e0;
                        flex-shrink: 0;
                    }
                    
                    .activity-details {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 15px;
                        margin-top: 15px;
                        width: 100%;
                        max-width: 100%;
                    }
                    
                    .activity-details div {
                        font-size: 0.9rem;
                        word-break: break-word;
                        max-width: 100%;
                    }
                    
                    .activity-details i {
                        color: #4a6fa5;
                        margin-right: 8px;
                        width: 20px;
                    }
                    
                    /* 交通方式 */
                    .transport-item {
                        background: #f0f7ff;
                        border-left: 4px solid #6b8cbc;
                        border-radius: 8px;
                        padding: 15px;
                        margin: 15px 0 15px 30px;
                        position: relative;
                        width: calc(100% - 30px);
                        max-width: 100%;
                        overflow: hidden;
                    }
                    
                    .transport-item::before {
                        content: "";
                        position: absolute;
                        left: -20px;
                        top: 50%;
                        width: 20px;
                        height: 1px;
                        background-color: #e0e0e0;
                    }
                    
                    .transport-item::after {
                        content: "→";
                        position: absolute;
                        left: -25px;
                        top: 50%;
                        transform: translateY(-50%);
                        color: #666;
                        font-size: 0.9rem;
                    }
                    
                    .transport-type {
                        display: inline-block;
                        padding: 3px 10px;
                        border-radius: 20px;
                        font-size: 0.75rem;
                        font-weight: bold;
                        background-color: #e3f2fd;
                        color: #1565c0;
                        margin-bottom: 10px;
                        white-space: nowrap;
                    }
                    
                    .transport-main {
                        border-left-color: #4caf50;
                    }
                    
                    .transport-alternate {
                        border-left-color: #ff9800;
                    }
                    
                    /* 費用統計 */
                    .cost-summary {
                        background: white;
                        border-radius: 10px;
                        padding: 25px;
                        margin-top: 30px;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
                        width: 100%;
                        max-width: 100%;
                        overflow-x: auto;
                    }
                    
                    .cost-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-top: 15px;
                        font-size: clamp(0.8rem, 1.5vw, 0.9rem);
                        min-width: 800px;
                    }
                    
                    .cost-table th, .cost-table td {
                        padding: 10px 12px;
                        text-align: left;
                        border-bottom: 1px solid #e0e0e0;
                        word-break: break-word;
                        white-space: nowrap;
                        max-width: none;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    
                    .cost-table th {
                        background-color: #f0f0f0;
                        color: #333;
                        font-weight: 600;
                        position: sticky;
                        top: 0;
                    }
                    
                    .cost-table tr:last-child td {
                        border-bottom: none;
                    }
                    
                    .total-cost {
                        font-weight: bold;
                        color: #ff7e5f;
                    }
                    
                    .cost-category {
                        font-weight: 600;
                        color: #4a6fa5;
                        background-color: rgba(74, 111, 165, 0.1);
                    }
                    
                    .cost-subcategory {
                        padding-left: 20px !important;
                        font-weight: 500;
                    }
                    
                    .cost-total-row {
                        font-weight: bold;
                        background-color: rgba(255, 126, 95, 0.1);
                    }
                    
                    /* 滾動到頂部/底部按鈕 */
                    .scroll-day-buttons {
                        position: fixed;
                        right: 20px;
                        top: 50%;
                        transform: translateY(-50%);
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                        z-index: 99;
                    }
                    
                    .scroll-day-btn {
                        width: 50px;
                        height: 50px;
                        border-radius: 50%;
                        background-color: #4a6fa5;
                        color: white;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        box-shadow: 0 3px 8px rgba(0,0,0,0.2);
                        transition: all 0.3s;
                        border: none;
                        font-size: 1.2rem;
                    }
                    
                    .scroll-day-btn:hover {
                        background-color: #6b8cbc;
                        transform: scale(1.1);
                    }
                    
                    /* 響應式設計 */
                    @media (max-width: 768px) {
                        .container {
                            padding: 15px;
                        }
                        
                        header {
                            padding: 20px 15px;
                        }
                        
                        .header-info {
                            grid-template-columns: 1fr;
                            gap: 15px;
                        }
                        
                        .day-nav-btn {
                            min-width: 100px;
                            padding: 10px 15px;
                        }
                        
                        .day-content {
                            padding: 20px;
                        }
                        
                        .activity-details {
                            grid-template-columns: 1fr;
                        }
                        
                        .activity-header {
                            flex-direction: column;
                            align-items: flex-start;
                            gap: 10px;
                        }
                        
                        .activity-category {
                            margin-left: 0;
                            margin-top: 5px;
                        }
                        
                        .transport-item {
                            margin-left: 20px;
                            width: calc(100% - 20px);
                        }
                        
                        .days-nav {
                            width: max-content;
                        }
                        
                        .cost-table {
                            min-width: 700px;
                        }
                        
                        .cost-table th, .cost-table td {
                            padding: 8px 10px;
                            font-size: 0.75rem;
                        }
                        
                        .scroll-day-buttons {
                            display: none;
                        }
                    }
                    
                    @media (max-width: 480px) {
                        .container {
                            padding: 10px;
                        }
                        
                        header {
                            padding: 15px 10px;
                        }
                        
                        h1 {
                            font-size: 1.5rem;
                        }
                        
                        .day-nav-btn {
                            min-width: 80px;
                            padding: 8px 12px;
                            font-size: 0.8rem;
                        }
                        
                        .activity-item {
                            padding: 15px;
                        }
                        
                        .transport-item {
                            padding: 12px;
                        }
                        
                        .cost-table {
                            min-width: 600px;
                            font-size: 0.7rem;
                        }
                        
                        .cost-table th, .cost-table td {
                            padding: 5px 6px;
                        }
                    }
                    
                    /* 頁腳 */
                    footer {
                        text-align: center;
                        margin-top: 50px;
                        padding-top: 20px;
                        border-top: 1px solid #e0e0e0;
                        color: #666;
                        font-size: 0.9rem;
                    }
                </style>
            </head>
            <body>
                <div class="container">
                    <header>
                        <h1><i class="fas fa-map-marked-alt"></i> ${plan.name}</h1>
                        <div class="header-info">
                            <div class="info-item">
                                <strong>旅遊開始日期</strong>
                                ${new Date(plan.startDate).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}
                            </div>
                            <div class="info-item">
                                <strong>旅遊結束日期</strong>
                                ${new Date(new Date(plan.startDate).getTime() + (plan.days - 1) * 24 * 60 * 60 * 1000).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}
                            </div>
                            <div class="info-item">
                                <strong>旅遊天數</strong>
                                ${plan.days} 天
                            </div>
                        </div>
                    </header>
                    
                    <div class="days-nav-container" id="daysNavContainer">
                        <div class="days-nav" id="daysNav">
                            <!-- 天數導航按鈕將動態生成 -->
                        </div>
                    </div>
                    
                    <div id="daysContent">
                        <!-- 天數內容將動態生成 -->
                    </div>
                    
                    <div class="cost-summary">
                        <h3><i class="fas fa-calculator"></i> 費用統計</h3>
                        <table class="cost-table">
                            <thead>
                                <tr>
                                    <th>日期</th>
                                    <th>類別</th>
                                    <th>說明</th>
                                    <th>幣別</th>
                                    <th>原幣費用</th>
                                    <th>換算台幣</th>
                                    <th>分攤人數</th>
                                    <th>每人費用(台幣)</th>
                                </tr>
                            </thead>
                            <tbody id="shareCostTableBody">
                                <!-- 費用統計將動態生成 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <footer>
                        <p>使用「旅遊計劃規劃」應用程式創建 • ${new Date().toLocaleDateString('zh-TW')}</p>
                    </footer>
                </div>
                
                <!-- 滾動到當日頂部/底部按鈕 -->
                <div class="scroll-day-buttons" id="scrollDayButtons">
                    <button class="scroll-day-btn" id="scrollDayTopBtn" title="滾動到當日頂部">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                    <button class="scroll-day-btn" id="scrollDayBottomBtn" title="滾動到當日底部">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                
                <script>
                    let currentDay = 1;
                    
                    document.addEventListener('DOMContentLoaded', function() {
                        // 天數導航按鈕事件
                        document.querySelectorAll('.day-nav-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const day = this.dataset.day;
                                showDayContent(day);
                            });
                        });
                        
                        // 滾動按鈕事件
                        document.getElementById('scrollDayTopBtn').addEventListener('click', function() {
                            scrollToDayTop();
                        });
                        
                        document.getElementById('scrollDayBottomBtn').addEventListener('click', function() {
                            scrollToDayBottom();
                        });
                        
                        showDayContent(1);
                    });
                    
                    function showDayContent(day) {
                        currentDay = parseInt(day);
                        
                        document.querySelectorAll('.day-content').forEach(content => {
                            content.classList.remove('active');
                        });
                        
                        const dayContent = document.getElementById('dayContent' + day);
                        if (dayContent) {
                            dayContent.classList.add('active');
                        }
                        
                        document.querySelectorAll('.day-nav-btn').forEach(btn => {
                            btn.classList.remove('active');
                            if (btn.dataset.day === day) {
                                btn.classList.add('active');
                            }
                        });
                        
                        dayContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                    
                    function scrollToDayTop() {
                        const dayContent = document.getElementById('dayContent' + currentDay);
                        if (dayContent) {
                            dayContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }
                    
                    function scrollToDayBottom() {
                        const dayContent = document.getElementById('dayContent' + currentDay);
                        if (dayContent) {
                            const activitiesContainer = dayContent.querySelector('.activities-container');
                            if (activitiesContainer && activitiesContainer.lastElementChild) {
                                activitiesContainer.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'end' });
                            }
                        }
                    }
                    
                    // 輔助函數：解析時間字符串為分鐘數
                    function parseTime(timeStr) {
                        if (!timeStr) return 0;
                        
                        const match = timeStr.match(/^(\\d{1,2}):(\\d{2})$/);
                        if (match) {
                            const hours = parseInt(match[1]);
                            const minutes = parseInt(match[2]);
                            return hours * 60 + minutes;
                        }
                        
                        return 0;
                    }
                <\/script>
            </body>
            </html>
            `;
            
            // 計算費用統計
            const allCosts = getAllCosts(plan);
            let costHtml = '';
            
            if (allCosts.length === 0) {
                costHtml = '<tr><td colspan="8" style="text-align: center; padding: 20px;">暫無費用資料</td></tr>';
            } else {
                // 按日期排序
                allCosts.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return dateA - dateB;
                });
                
                // 顯示所有費用
                allCosts.forEach(cost => {
                    // 計算換算後的台幣費用
                    const originalCost = cost.amount || 0;
                    const currency = cost.currency || 'TWD';
                    const exchangeRate = state.exchangeRates[currency] || 1;
                    const twdCost = originalCost * exchangeRate;
                    const participants = cost.participants || 1;
                    const personalTwdCost = twdCost / participants;
                    
                    // 根據費用類型顯示不同的類別和說明
                    let categoryText = '';
                    let descriptionText = '';
                    
                    if (cost.type === 'activity') {
                        const categoryLabels = {
                            attraction: '景點',
                            transport: '交通',
                            activity: '活動',
                            accommodation: '住宿',
                            shopping: '購物',
                            other: '其他'
                        };
                        categoryText = categoryLabels[cost.category] || cost.category;
                        descriptionText = cost.name;
                    } else if (cost.type === 'transport') {
                        categoryText = '交通';
                        descriptionText = `${cost.fromActivityName} → ${cost.toActivityName}`;
                    } else if (cost.type === 'additional') {
                        const categoryLabels = {
                            transport: '交通',
                            shopping: '購物',
                            food: '飲食',
                            insurance: '保險',
                            internet: '網路',
                            other: '其他'
                        };
                        categoryText = categoryLabels[cost.category] || cost.category;
                        descriptionText = cost.description;
                    }
                    
                    costHtml += `
                        <tr>
                            <td>${formatDate(new Date(cost.date))}</td>
                            <td>${categoryText}</td>
                            <td>${descriptionText}</td>
                            <td>${currency}</td>
                            <td>${originalCost.toFixed(2)}</td>
                            <td>${twdCost.toFixed(2)}</td>
                            <td>${participants}</td>
                            <td class="total-cost">${personalTwdCost.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                // 添加總計行
                const totals = calculateTotalCosts(plan);
                costHtml += `
                    <tr class="cost-total-row">
                        <td colspan="5"><strong>總計 (新台幣)</strong></td>
                        <td><strong>${totals.totalTWD.toFixed(2)}</strong></td>
                        <td></td>
                        <td class="total-cost"><strong>${totals.totalPersonalTWD.toFixed(2)}</strong></td>
                    </tr>
                `;
            }
            
            html = html.replace('<!-- 費用統計將動態生成 -->', costHtml);
            
            // 生成天數導航和內容
            let daysNavHtml = '';
            let daysContentHtml = '';
            
            for (let day = 1; day <= plan.days; day++) {
                const dayDate = new Date(plan.startDate);
                dayDate.setDate(dayDate.getDate() + day - 1);
                
                const dayTitle = plan.dayTitles && plan.dayTitles[day] ? plan.dayTitles[day] : `第 ${day} 天`;
                const dateStr = dayDate.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
                
                daysNavHtml += `
                    <button class="day-nav-btn ${day === 1 ? 'active' : ''}" data-day="${day}">
                        Day ${day}
                    </button>
                `;
                
                const dayActivities = plan.activities ? plan.activities.filter(a => a.day === day) : [];
                const dayTransports = plan.transports ? plan.transports.filter(t => t.day === day) : [];
                
                dayActivities.sort((a, b) => {
                    const timeA = a.startTime ? parseTime(a.startTime) : 0;
                    const timeB = b.startTime ? parseTime(b.startTime) : 0;
                    return timeA - timeB;
                });
                
                let dayContentHtml = `<div class="day-content ${day === 1 ? 'active' : ''}" id="dayContent${day}">`;
                dayContentHtml += `
                    <div class="day-header">
                        <div class="day-title">${dayTitle}</div>
                        <div class="day-date">${dateStr}</div>
                    </div>
                    <div class="activities-container">
                `;
                
                if (dayActivities.length === 0) {
                    dayContentHtml += `
                        <div style="text-align: center; padding: 40px 20px; color: #999;">
                            <i class="fas fa-calendar-plus" style="font-size: 3rem; margin-bottom: 15px;"></i>
                            <p>當日暫無行程安排</p>
                        </div>
                    `;
                } else {
                    // 檢查前一天的住宿
                    if (day > 1) {
                        const previousDayActivities = plan.activities ? plan.activities.filter(a => a.day === day - 1) : [];
                        const previousAccommodation = previousDayActivities.find(a => a.category === 'accommodation');
                        
                        if (previousAccommodation) {
                            dayContentHtml += `
                                <div class="transport-item accommodation-start-point">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="fas fa-bed" style="color: #ef6c00;"></i>
                                        <div>
                                            <div style="font-weight: bold; color: #ef6c00;">今日起點：前一天的住宿</div>
                                            <div>${previousAccommodation.name} - ${previousAccommodation.location}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    dayActivities.forEach((activity, index) => {
                        const categoryLabels = {
                            attraction: '景點',
                            transport: '交通',
                            activity: '活動',
                            accommodation: '住宿',
                            shopping: '購物',
                            other: '其他'
                        };
                        
                        const categoryClasses = {
                            attraction: 'attraction',
                            transport: 'transport',
                            activity: 'activity',
                            accommodation: 'accommodation',
                            shopping: 'shopping',
                            other: 'other'
                        };
                        
                        // 計算換算後的台幣費用
                        const originalCost = activity.cost || 0;
                        const currency = activity.currency || 'TWD';
                        const exchangeRate = state.exchangeRates[currency] || 1;
                        const twdCost = originalCost * exchangeRate;
                        const participants = activity.participants || 1;
                        const personalTwdCost = twdCost / participants;
                        
                        // 建立連結HTML
                        let linksHtml = '';
                        if (activity.links && activity.links.length > 0) {
                            linksHtml = activity.links.map(link => 
                                `<div><i class="fas fa-link"></i> <a href="${link.url}" target="_blank" style="word-break: break-all;">${link.name}</a></div>`
                            ).join('');
                        }
                        
                        dayContentHtml += `
                            <div class="activity-item">
                                <div class="activity-header">
                                    <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 8px;">
                                        <span class="activity-name">${activity.name}</span>
                                        <span class="activity-category ${categoryClasses[activity.category]}">
                                            ${categoryLabels[activity.category]}
                                        </span>
                                    </div>
                                    <div class="activity-time">
                                        ${activity.startTime || ''} ${activity.endTime ? `- ${activity.endTime}` : ''}
                                    </div>
                                </div>
                                <div class="activity-details">
                                    <div><i class="fas fa-map-marker-alt"></i> ${activity.location}</div>
                                    ${activity.address ? `<div><i class="fas fa-map-pin"></i> ${activity.address}</div>` : ''}
                                    ${originalCost > 0 ? `
                                        <div><i class="fas fa-money-bill-wave"></i> 
                                            ${currency} ${originalCost.toFixed(2)} 
                                            <small>(${twdCost.toFixed(2)} TWD)</small>
                                            ${participants > 1 ? ` (每人 ${personalTwdCost.toFixed(2)} TWD)` : ''}
                                        </div>
                                    ` : ''}
                                    ${linksHtml}
                                    ${activity.notes ? `<div><i class="fas fa-sticky-note"></i> ${activity.notes}</div>` : ''}
                                </div>
                            </div>
                        `;
                        
                        if (index < dayActivities.length - 1) {
                            const nextActivity = dayActivities[index + 1];
                            const transportsBetween = dayTransports.filter(t => 
                                t.fromActivityId === activity.id && t.toActivityId === nextActivity.id
                            );
                            
                            transportsBetween.forEach(transport => {
                                const transportLabels = {
                                    taxi: '計程車',
                                    subway: '地鐵',
                                    bus: '公交',
                                    train: '高鐵',
                                    walking: '步行',
                                    flight: '飛機',
                                    ship: '輪船',
                                    coach: '巴士',
                                    selfdrive: '自駕',
                                    other: '其他'
                                };
                                
                                // 計算主要交通方式的總費用（只有主要方式才計算費用）
                                let totalCostTWD = 0;
                                let totalPersonalTWD = 0;
                                
                                if (transport.isMain && transport.options && transport.options.length > 0) {
                                    transport.options.forEach(option => {
                                        if (option.isMain && option.cost > 0) {
                                            const currency = option.currency || 'TWD';
                                            const exchangeRate = state.exchangeRates[currency] || 1;
                                            const originalCost = option.cost;
                                            const twdCost = originalCost * exchangeRate;
                                            const participants = option.participants || 1;
                                            const personalTwdCost = twdCost / participants;
                                            
                                            totalCostTWD += twdCost;
                                            totalPersonalTWD += personalTwdCost;
                                        }
                                    });
                                }
                                
                                const routeDescription = transport.fromLocation && transport.toLocation 
                                    ? `${transport.fromLocation} → ${transport.toLocation}`
                                    : `${transport.fromActivityName} → ${transport.toActivityName}`;
                                
                                // 顯示所有交通方式選項
                                let optionsHtml = '';
                                if (transport.options && transport.options.length > 0) {
                                    transport.options.forEach((option) => {
                                        const transportTypeLabel = transportLabels[option.type] || option.type;
                                        const isMainOption = option.isMain ? '✓ 主要' : '○ 次要';
                                        
                                        // 計算換算後的台幣費用
                                        const originalCost = option.cost || 0;
                                        const currency = option.currency || 'TWD';
                                        const exchangeRate = state.exchangeRates[currency] || 1;
                                        const twdCost = originalCost * exchangeRate;
                                        const participants = option.participants || 1;
                                        const personalTwdCost = twdCost / participants;
                                        
                                        optionsHtml += `
                                            <div style="margin: 8px 0; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid ${option.isMain ? '#4caf50' : '#ff9800'};">
                                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                                    <span><strong>${transportTypeLabel}</strong> <span style="color: ${option.isMain ? '#4caf50' : '#ff9800'};">(${isMainOption})</span></span>
                                                </div>
                                                ${originalCost > 0 ? `
                                                    <div style="font-size: 0.9rem;">
                                                        <i class="fas fa-money-bill-wave"></i> 
                                                        ${currency} ${originalCost.toFixed(2)} 
                                                        <small>(${twdCost.toFixed(2)} TWD)</small>
                                                        ${participants > 1 ? ` (每人 ${personalTwdCost.toFixed(2)} TWD)` : ''}
                                                    </div>
                                                ` : ''}
                                                ${option.link && option.linkName ? `
                                                    <div style="font-size: 0.9rem; margin-top: 5px;">
                                                        <a href="${option.link}" target="_blank" style="word-break: break-all;"><i class="fas fa-link"></i> ${option.linkName}</a>
                                                    </div>
                                                ` : ''}
                                                ${option.notes ? `
                                                    <div style="font-size: 0.9rem; margin-top: 5px;">
                                                        <i class="fas fa-sticky-note"></i> ${option.notes}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `;
                                    });
                                }
                                
                                dayContentHtml += `
                                    <div class="transport-item ${transport.isMain ? 'transport-main' : 'transport-alternate'}">
                                        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 8px; margin-bottom: 10px;">
                                            <div>
                                                ${transport.isMain ? '<i class="fas fa-star" style="color: #4caf50;"></i> 主要' : '<i class="far fa-star" style="color: #ff9800;"></i> 備用'}
                                            </div>
                                        </div>
                                        <div><i class="fas fa-clock"></i> ${transport.startTime} - ${transport.endTime}</div>
                                        <div><i class="fas fa-route"></i> ${routeDescription}</div>
                                        
                                        <div style="margin: 15px 0;">
                                            ${optionsHtml}
                                        </div>
                                        
                                        ${totalCostTWD > 0 ? `
                                            <div style="margin: 8px 0; padding: 10px; background: #e8f5e9; border-radius: 4px;">
                                                <i class="fas fa-money-bill-wave"></i> 
                                                <strong>總費用: ${totalCostTWD.toFixed(2)} TWD</strong>
                                                <small> (每人 ${totalPersonalTWD.toFixed(2)} TWD)</small>
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            });
                        }
                    });
                }
                
                dayContentHtml += `
                        </div>
                    </div>
                `;
                
                daysContentHtml += dayContentHtml;
            }
            
            html = html.replace('<!-- 天數導航按鈕將動態生成 -->', daysNavHtml);
            html = html.replace('<!-- 天數內容將動態生成 -->', daysContentHtml);
            
            const filename = `旅遊計劃_${plan.name}_分享.html`;
            const dataBlob = new Blob([html], {type: 'text/html'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 輔助函數：格式化日期
        function formatDate(date) {
            return date.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // 輔助函數：解析時間字符串為分鐘數
        function parseTime(timeStr) {
            if (!timeStr) return 0;
            
            const match = timeStr.match(/^(\d{1,2}):(\d{2})$/);
            if (match) {
                const hours = parseInt(match[1]);
                const minutes = parseInt(match[2]);
                return hours * 60 + minutes;
            }
            
            return 0;
        }
    </script>
</body>
</html>
